import{_ as l,c as t,a as s,f as i,o as c,r as a}from"./app-BB_BIQV8.js";const o={};function u(r,n){const e=a("DocSearchInPage"),p=a("InArticleAd");return c(),t("div",null,[s(e),s(p),n[0]||(n[0]=i(`<h1 id="rabbitmq-使用手册" tabindex="-1"><a class="header-anchor" href="#rabbitmq-使用手册"><span>RabbitMQ 使用手册</span></a></h1><h2 id="简介" tabindex="-1"><a class="header-anchor" href="#简介"><span>简介</span></a></h2><p>RabbitMQ 是一个开源的消息代理软件(Message Broker),实现了高级消息队列协议(AMQP)。它可以在分布式系统中传递消息,提供可靠的消息传递机制。</p><p><strong>主要特性:</strong></p><ul><li>可靠性:支持消息持久化、确认机制、事务等</li><li>灵活的路由:通过交换机(Exchange)实现灵活的消息路由</li><li>集群支持:支持多节点集群部署,提供高可用性</li><li>多种协议:支持 AMQP、STOMP、MQTT 等多种协议</li><li>管理界面:提供 Web 管理控制台</li><li>插件系统:丰富的插件生态系统</li></ul><h2 id="安装与配置" tabindex="-1"><a class="header-anchor" href="#安装与配置"><span>安装与配置</span></a></h2><h3 id="docker-安装-推荐" tabindex="-1"><a class="header-anchor" href="#docker-安装-推荐"><span>Docker 安装(推荐)</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 拉取带管理界面的镜像</span></span>
<span class="line"><span class="token function">docker</span> pull rabbitmq:3-management</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 运行容器</span></span>
<span class="line"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> rabbitmq <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">-p</span> <span class="token number">5672</span>:5672 <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">-p</span> <span class="token number">15672</span>:15672 <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">-e</span> <span class="token assign-left variable">RABBITMQ_DEFAULT_USER</span><span class="token operator">=</span>admin <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">-e</span> <span class="token assign-left variable">RABBITMQ_DEFAULT_PASS</span><span class="token operator">=</span>admin123 <span class="token punctuation">\\</span></span>
<span class="line">  rabbitmq:3-management</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>访问管理界面: http://localhost:15672</p><h3 id="ubuntu-debian-安装" tabindex="-1"><a class="header-anchor" href="#ubuntu-debian-安装"><span>Ubuntu/Debian 安装</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 添加 RabbitMQ 仓库</span></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://packagecloud.io/rabbitmq/rabbitmq-server/gpgkey <span class="token operator">|</span> <span class="token function">sudo</span> gpg <span class="token parameter variable">--dearmor</span> <span class="token parameter variable">-o</span> /usr/share/keyrings/rabbitmq-archive-keyring.gpg</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 安装</span></span>
<span class="line"><span class="token function">sudo</span> <span class="token function">apt-get</span> update</span>
<span class="line"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> rabbitmq-server</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 启动服务</span></span>
<span class="line"><span class="token function">sudo</span> systemctl start rabbitmq-server</span>
<span class="line"><span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> rabbitmq-server</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 启用管理插件</span></span>
<span class="line"><span class="token function">sudo</span> rabbitmq-plugins <span class="token builtin class-name">enable</span> rabbitmq_management</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="基本配置" tabindex="-1"><a class="header-anchor" href="#基本配置"><span>基本配置</span></a></h3><p>配置文件位置: <code>/etc/rabbitmq/rabbitmq.conf</code></p><div class="language-ini line-numbers-mode" data-highlighter="prismjs" data-ext="ini" data-title="ini"><pre><code><span class="line"><span class="token comment"># 监听端口</span></span>
<span class="line"><span class="token key attr-name">listeners.tcp.default</span> <span class="token punctuation">=</span> <span class="token value attr-value">5672</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 管理插件端口</span></span>
<span class="line"><span class="token key attr-name">management.tcp.port</span> <span class="token punctuation">=</span> <span class="token value attr-value">15672</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 虚拟主机</span></span>
<span class="line"><span class="token key attr-name">default_vhost</span> <span class="token punctuation">=</span> <span class="token value attr-value">/</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 用户权限</span></span>
<span class="line"><span class="token key attr-name">default_user</span> <span class="token punctuation">=</span> <span class="token value attr-value">guest</span></span>
<span class="line"><span class="token key attr-name">default_pass</span> <span class="token punctuation">=</span> <span class="token value attr-value">guest</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 内存限制</span></span>
<span class="line"><span class="token key attr-name">vm_memory_high_watermark.relative</span> <span class="token punctuation">=</span> <span class="token value attr-value">0.4</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 磁盘空间限制</span></span>
<span class="line"><span class="token key attr-name">disk_free_limit.absolute</span> <span class="token punctuation">=</span> <span class="token value attr-value">50GB</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="核心概念" tabindex="-1"><a class="header-anchor" href="#核心概念"><span>核心概念</span></a></h2><h3 id="_1-连接-connection" tabindex="-1"><a class="header-anchor" href="#_1-连接-connection"><span>1. 连接(Connection)</span></a></h3><p>应用程序与 RabbitMQ 服务器之间的 TCP 连接。</p><h3 id="_2-信道-channel" tabindex="-1"><a class="header-anchor" href="#_2-信道-channel"><span>2. 信道(Channel)</span></a></h3><p>在连接内部建立的虚拟连接,用于执行消息操作。一个连接可以包含多个信道。</p><h3 id="_3-交换机-exchange" tabindex="-1"><a class="header-anchor" href="#_3-交换机-exchange"><span>3. 交换机(Exchange)</span></a></h3><p>消息路由器,负责接收生产者发送的消息并根据路由规则将消息路由到队列。</p><p><strong>交换机类型:</strong></p><ul><li><strong>Direct</strong>: 精确匹配路由键</li><li><strong>Fanout</strong>: 广播到所有绑定的队列</li><li><strong>Topic</strong>: 模式匹配路由键</li><li><strong>Headers</strong>: 根据消息头属性路由</li></ul><h3 id="_4-队列-queue" tabindex="-1"><a class="header-anchor" href="#_4-队列-queue"><span>4. 队列(Queue)</span></a></h3><p>存储消息的容器,消费者从队列中获取消息。</p><h3 id="_5-绑定-binding" tabindex="-1"><a class="header-anchor" href="#_5-绑定-binding"><span>5. 绑定(Binding)</span></a></h3><p>交换机与队列之间的关联关系,定义了消息的路由规则。</p><h3 id="_6-虚拟主机-virtual-host" tabindex="-1"><a class="header-anchor" href="#_6-虚拟主机-virtual-host"><span>6. 虚拟主机(Virtual Host)</span></a></h3><p>类似于数据库中的命名空间,用于逻辑隔离。</p><h2 id="快速开始" tabindex="-1"><a class="header-anchor" href="#快速开始"><span>快速开始</span></a></h2><h3 id="python-示例-使用-pika" tabindex="-1"><a class="header-anchor" href="#python-示例-使用-pika"><span>Python 示例(使用 pika)</span></a></h3><p>安装依赖:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">pip <span class="token function">install</span> pika</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>生产者(Producer):</strong></p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token keyword">import</span> pika</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 建立连接</span></span>
<span class="line">connection <span class="token operator">=</span> pika<span class="token punctuation">.</span>BlockingConnection<span class="token punctuation">(</span></span>
<span class="line">    pika<span class="token punctuation">.</span>ConnectionParameters<span class="token punctuation">(</span><span class="token string">&#39;localhost&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line">channel <span class="token operator">=</span> connection<span class="token punctuation">.</span>channel<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 声明队列</span></span>
<span class="line">channel<span class="token punctuation">.</span>queue_declare<span class="token punctuation">(</span>queue<span class="token operator">=</span><span class="token string">&#39;hello&#39;</span><span class="token punctuation">,</span> durable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 发送消息</span></span>
<span class="line">channel<span class="token punctuation">.</span>basic_publish<span class="token punctuation">(</span></span>
<span class="line">    exchange<span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    routing_key<span class="token operator">=</span><span class="token string">&#39;hello&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    body<span class="token operator">=</span><span class="token string">&#39;Hello World!&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    properties<span class="token operator">=</span>pika<span class="token punctuation">.</span>BasicProperties<span class="token punctuation">(</span></span>
<span class="line">        delivery_mode<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>  <span class="token comment"># 消息持久化</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;消息已发送&quot;</span><span class="token punctuation">)</span></span>
<span class="line">connection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>消费者(Consumer):</strong></p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token keyword">import</span> pika</span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">callback</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> method<span class="token punctuation">,</span> properties<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;接收到消息: </span><span class="token interpolation"><span class="token punctuation">{</span>body<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">    ch<span class="token punctuation">.</span>basic_ack<span class="token punctuation">(</span>delivery_tag<span class="token operator">=</span>method<span class="token punctuation">.</span>delivery_tag<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">connection <span class="token operator">=</span> pika<span class="token punctuation">.</span>BlockingConnection<span class="token punctuation">(</span></span>
<span class="line">    pika<span class="token punctuation">.</span>ConnectionParameters<span class="token punctuation">(</span><span class="token string">&#39;localhost&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line">channel <span class="token operator">=</span> connection<span class="token punctuation">.</span>channel<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 声明队列</span></span>
<span class="line">channel<span class="token punctuation">.</span>queue_declare<span class="token punctuation">(</span>queue<span class="token operator">=</span><span class="token string">&#39;hello&#39;</span><span class="token punctuation">,</span> durable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 设置公平分发</span></span>
<span class="line">channel<span class="token punctuation">.</span>basic_qos<span class="token punctuation">(</span>prefetch_count<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 消费消息</span></span>
<span class="line">channel<span class="token punctuation">.</span>basic_consume<span class="token punctuation">(</span></span>
<span class="line">    queue<span class="token operator">=</span><span class="token string">&#39;hello&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    on_message_callback<span class="token operator">=</span>callback</span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#39;等待消息...&#39;</span><span class="token punctuation">)</span></span>
<span class="line">channel<span class="token punctuation">.</span>start_consuming<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="java-示例-使用-spring-amqp" tabindex="-1"><a class="header-anchor" href="#java-示例-使用-spring-amqp"><span>Java 示例(使用 Spring AMQP)</span></a></h3><p><strong>依赖配置(Maven):</strong></p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>配置文件(application.yml):</strong></p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost</span>
<span class="line">    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span></span>
<span class="line">    <span class="token key atrule">username</span><span class="token punctuation">:</span> admin</span>
<span class="line">    <span class="token key atrule">password</span><span class="token punctuation">:</span> admin123</span>
<span class="line">    <span class="token key atrule">virtual-host</span><span class="token punctuation">:</span> /</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>生产者:</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Service</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageProducer</span> <span class="token punctuation">{</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;exchange-name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;routing-key&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>消费者:</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageConsumer</span> <span class="token punctuation">{</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;queue-name&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接收到消息: &quot;</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="消息模式" tabindex="-1"><a class="header-anchor" href="#消息模式"><span>消息模式</span></a></h2><h3 id="_1-简单队列-simple-queue" tabindex="-1"><a class="header-anchor" href="#_1-简单队列-simple-queue"><span>1. 简单队列(Simple Queue)</span></a></h3><p>最基本的模式,一个生产者对应一个消费者。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">[Producer] -&gt; [Queue] -&gt; [Consumer]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_2-工作队列-work-queue" tabindex="-1"><a class="header-anchor" href="#_2-工作队列-work-queue"><span>2. 工作队列(Work Queue)</span></a></h3><p>多个消费者共享一个队列,实现负载均衡。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">                 -&gt; [Consumer 1]</span>
<span class="line">[Producer] -&gt; [Queue] -&gt; [Consumer 2]</span>
<span class="line">                 -&gt; [Consumer 3]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-发布-订阅-publish-subscribe" tabindex="-1"><a class="header-anchor" href="#_3-发布-订阅-publish-subscribe"><span>3. 发布/订阅(Publish/Subscribe)</span></a></h3><p>使用 Fanout 交换机,消息广播到所有订阅者。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">                     -&gt; [Queue 1] -&gt; [Consumer 1]</span>
<span class="line">[Producer] -&gt; [Fanout Exchange] -&gt; [Queue 2] -&gt; [Consumer 2]</span>
<span class="line">                     -&gt; [Queue 3] -&gt; [Consumer 3]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Python 示例:</strong></p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 发布者</span></span>
<span class="line">channel<span class="token punctuation">.</span>exchange_declare<span class="token punctuation">(</span>exchange<span class="token operator">=</span><span class="token string">&#39;logs&#39;</span><span class="token punctuation">,</span> exchange_type<span class="token operator">=</span><span class="token string">&#39;fanout&#39;</span><span class="token punctuation">)</span></span>
<span class="line">channel<span class="token punctuation">.</span>basic_publish<span class="token punctuation">(</span>exchange<span class="token operator">=</span><span class="token string">&#39;logs&#39;</span><span class="token punctuation">,</span> routing_key<span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> body<span class="token operator">=</span>message<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 订阅者</span></span>
<span class="line">channel<span class="token punctuation">.</span>exchange_declare<span class="token punctuation">(</span>exchange<span class="token operator">=</span><span class="token string">&#39;logs&#39;</span><span class="token punctuation">,</span> exchange_type<span class="token operator">=</span><span class="token string">&#39;fanout&#39;</span><span class="token punctuation">)</span></span>
<span class="line">result <span class="token operator">=</span> channel<span class="token punctuation">.</span>queue_declare<span class="token punctuation">(</span>queue<span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> exclusive<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">queue_name <span class="token operator">=</span> result<span class="token punctuation">.</span>method<span class="token punctuation">.</span>queue</span>
<span class="line">channel<span class="token punctuation">.</span>queue_bind<span class="token punctuation">(</span>exchange<span class="token operator">=</span><span class="token string">&#39;logs&#39;</span><span class="token punctuation">,</span> queue<span class="token operator">=</span>queue_name<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-路由-routing" tabindex="-1"><a class="header-anchor" href="#_4-路由-routing"><span>4. 路由(Routing)</span></a></h3><p>使用 Direct 交换机,根据路由键精确匹配。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">                         -&gt; [Queue: error] -&gt; [Consumer: error logs]</span>
<span class="line">[Producer] -&gt; [Direct Exchange]</span>
<span class="line">                         -&gt; [Queue: info] -&gt; [Consumer: all logs]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Python 示例:</strong></p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 生产者</span></span>
<span class="line">channel<span class="token punctuation">.</span>exchange_declare<span class="token punctuation">(</span>exchange<span class="token operator">=</span><span class="token string">&#39;direct_logs&#39;</span><span class="token punctuation">,</span> exchange_type<span class="token operator">=</span><span class="token string">&#39;direct&#39;</span><span class="token punctuation">)</span></span>
<span class="line">channel<span class="token punctuation">.</span>basic_publish<span class="token punctuation">(</span></span>
<span class="line">    exchange<span class="token operator">=</span><span class="token string">&#39;direct_logs&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    routing_key<span class="token operator">=</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    body<span class="token operator">=</span><span class="token string">&#39;Error message&#39;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 消费者</span></span>
<span class="line">channel<span class="token punctuation">.</span>queue_bind<span class="token punctuation">(</span>exchange<span class="token operator">=</span><span class="token string">&#39;direct_logs&#39;</span><span class="token punctuation">,</span> queue<span class="token operator">=</span>queue_name<span class="token punctuation">,</span> routing_key<span class="token operator">=</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-主题-topics" tabindex="-1"><a class="header-anchor" href="#_5-主题-topics"><span>5. 主题(Topics)</span></a></h3><p>使用 Topic 交换机,支持通配符匹配。</p><ul><li><code>*</code> 匹配一个单词</li><li><code>#</code> 匹配零个或多个单词</li></ul><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 生产者</span></span>
<span class="line">channel<span class="token punctuation">.</span>exchange_declare<span class="token punctuation">(</span>exchange<span class="token operator">=</span><span class="token string">&#39;topic_logs&#39;</span><span class="token punctuation">,</span> exchange_type<span class="token operator">=</span><span class="token string">&#39;topic&#39;</span><span class="token punctuation">)</span></span>
<span class="line">channel<span class="token punctuation">.</span>basic_publish<span class="token punctuation">(</span></span>
<span class="line">    exchange<span class="token operator">=</span><span class="token string">&#39;topic_logs&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    routing_key<span class="token operator">=</span><span class="token string">&#39;kern.critical&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    body<span class="token operator">=</span>message</span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 消费者</span></span>
<span class="line">channel<span class="token punctuation">.</span>queue_bind<span class="token punctuation">(</span>exchange<span class="token operator">=</span><span class="token string">&#39;topic_logs&#39;</span><span class="token punctuation">,</span> queue<span class="token operator">=</span>queue_name<span class="token punctuation">,</span> routing_key<span class="token operator">=</span><span class="token string">&#39;kern.*&#39;</span><span class="token punctuation">)</span></span>
<span class="line">channel<span class="token punctuation">.</span>queue_bind<span class="token punctuation">(</span>exchange<span class="token operator">=</span><span class="token string">&#39;topic_logs&#39;</span><span class="token punctuation">,</span> queue<span class="token operator">=</span>queue_name<span class="token punctuation">,</span> routing_key<span class="token operator">=</span><span class="token string">&#39;*.critical&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-rpc-模式" tabindex="-1"><a class="header-anchor" href="#_6-rpc-模式"><span>6. RPC 模式</span></a></h3><p>实现远程过程调用。</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 客户端</span></span>
<span class="line"><span class="token keyword">import</span> uuid</span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">RpcClient</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>connection <span class="token operator">=</span> pika<span class="token punctuation">.</span>BlockingConnection<span class="token punctuation">(</span></span>
<span class="line">            pika<span class="token punctuation">.</span>ConnectionParameters<span class="token punctuation">(</span><span class="token string">&#39;localhost&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>channel <span class="token operator">=</span> self<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>channel<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        result <span class="token operator">=</span> self<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>queue_declare<span class="token punctuation">(</span>queue<span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> exclusive<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>callback_queue <span class="token operator">=</span> result<span class="token punctuation">.</span>method<span class="token punctuation">.</span>queue</span>
<span class="line">        </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>response <span class="token operator">=</span> <span class="token boolean">None</span></span>
<span class="line">        self<span class="token punctuation">.</span>corr_id <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        self<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>basic_publish<span class="token punctuation">(</span></span>
<span class="line">            exchange<span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            routing_key<span class="token operator">=</span><span class="token string">&#39;rpc_queue&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            properties<span class="token operator">=</span>pika<span class="token punctuation">.</span>BasicProperties<span class="token punctuation">(</span></span>
<span class="line">                reply_to<span class="token operator">=</span>self<span class="token punctuation">.</span>callback_queue<span class="token punctuation">,</span></span>
<span class="line">                correlation_id<span class="token operator">=</span>self<span class="token punctuation">.</span>corr_id<span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            body<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">while</span> self<span class="token punctuation">.</span>response <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">            self<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>process_data_events<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>response<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="高级特性" tabindex="-1"><a class="header-anchor" href="#高级特性"><span>高级特性</span></a></h2><h3 id="_1-消息确认-acknowledgment" tabindex="-1"><a class="header-anchor" href="#_1-消息确认-acknowledgment"><span>1. 消息确认(Acknowledgment)</span></a></h3><p><strong>自动确认:</strong></p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line">channel<span class="token punctuation">.</span>basic_consume<span class="token punctuation">(</span>queue<span class="token operator">=</span><span class="token string">&#39;hello&#39;</span><span class="token punctuation">,</span> auto_ack<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> on_message_callback<span class="token operator">=</span>callback<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>手动确认:</strong></p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">callback</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> method<span class="token punctuation">,</span> properties<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;处理消息: </span><span class="token interpolation"><span class="token punctuation">{</span>body<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">    ch<span class="token punctuation">.</span>basic_ack<span class="token punctuation">(</span>delivery_tag<span class="token operator">=</span>method<span class="token punctuation">.</span>delivery_tag<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">channel<span class="token punctuation">.</span>basic_consume<span class="token punctuation">(</span>queue<span class="token operator">=</span><span class="token string">&#39;hello&#39;</span><span class="token punctuation">,</span> on_message_callback<span class="token operator">=</span>callback<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-消息持久化" tabindex="-1"><a class="header-anchor" href="#_2-消息持久化"><span>2. 消息持久化</span></a></h3><p><strong>队列持久化:</strong></p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line">channel<span class="token punctuation">.</span>queue_declare<span class="token punctuation">(</span>queue<span class="token operator">=</span><span class="token string">&#39;task_queue&#39;</span><span class="token punctuation">,</span> durable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>消息持久化:</strong></p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line">channel<span class="token punctuation">.</span>basic_publish<span class="token punctuation">(</span></span>
<span class="line">    exchange<span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    routing_key<span class="token operator">=</span><span class="token string">&#39;task_queue&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    body<span class="token operator">=</span>message<span class="token punctuation">,</span></span>
<span class="line">    properties<span class="token operator">=</span>pika<span class="token punctuation">.</span>BasicProperties<span class="token punctuation">(</span>delivery_mode<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-公平分发-fair-dispatch" tabindex="-1"><a class="header-anchor" href="#_3-公平分发-fair-dispatch"><span>3. 公平分发(Fair Dispatch)</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line">channel<span class="token punctuation">.</span>basic_qos<span class="token punctuation">(</span>prefetch_count<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_4-消息优先级" tabindex="-1"><a class="header-anchor" href="#_4-消息优先级"><span>4. 消息优先级</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 声明带优先级的队列</span></span>
<span class="line">channel<span class="token punctuation">.</span>queue_declare<span class="token punctuation">(</span></span>
<span class="line">    queue<span class="token operator">=</span><span class="token string">&#39;priority_queue&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    arguments<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&#39;x-max-priority&#39;</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 发送带优先级的消息</span></span>
<span class="line">channel<span class="token punctuation">.</span>basic_publish<span class="token punctuation">(</span></span>
<span class="line">    exchange<span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    routing_key<span class="token operator">=</span><span class="token string">&#39;priority_queue&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    body<span class="token operator">=</span>message<span class="token punctuation">,</span></span>
<span class="line">    properties<span class="token operator">=</span>pika<span class="token punctuation">.</span>BasicProperties<span class="token punctuation">(</span>priority<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-消息过期时间-ttl" tabindex="-1"><a class="header-anchor" href="#_5-消息过期时间-ttl"><span>5. 消息过期时间(TTL)</span></a></h3><p><strong>队列级别 TTL:</strong></p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line">channel<span class="token punctuation">.</span>queue_declare<span class="token punctuation">(</span></span>
<span class="line">    queue<span class="token operator">=</span><span class="token string">&#39;ttl_queue&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    arguments<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&#39;x-message-ttl&#39;</span><span class="token punctuation">:</span> <span class="token number">60000</span><span class="token punctuation">}</span>  <span class="token comment"># 60秒</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>消息级别 TTL:</strong></p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line">channel<span class="token punctuation">.</span>basic_publish<span class="token punctuation">(</span></span>
<span class="line">    exchange<span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    routing_key<span class="token operator">=</span><span class="token string">&#39;queue&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    body<span class="token operator">=</span>message<span class="token punctuation">,</span></span>
<span class="line">    properties<span class="token operator">=</span>pika<span class="token punctuation">.</span>BasicProperties<span class="token punctuation">(</span>expiration<span class="token operator">=</span><span class="token string">&#39;60000&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-死信队列-dead-letter-exchange" tabindex="-1"><a class="header-anchor" href="#_6-死信队列-dead-letter-exchange"><span>6. 死信队列(Dead Letter Exchange)</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 主队列配置</span></span>
<span class="line">channel<span class="token punctuation">.</span>queue_declare<span class="token punctuation">(</span></span>
<span class="line">    queue<span class="token operator">=</span><span class="token string">&#39;main_queue&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    arguments<span class="token operator">=</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&#39;x-dead-letter-exchange&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;dlx_exchange&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&#39;x-dead-letter-routing-key&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;dead_letter&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&#39;x-message-ttl&#39;</span><span class="token punctuation">:</span> <span class="token number">10000</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 死信交换机和队列</span></span>
<span class="line">channel<span class="token punctuation">.</span>exchange_declare<span class="token punctuation">(</span>exchange<span class="token operator">=</span><span class="token string">&#39;dlx_exchange&#39;</span><span class="token punctuation">,</span> exchange_type<span class="token operator">=</span><span class="token string">&#39;direct&#39;</span><span class="token punctuation">)</span></span>
<span class="line">channel<span class="token punctuation">.</span>queue_declare<span class="token punctuation">(</span>queue<span class="token operator">=</span><span class="token string">&#39;dead_letter_queue&#39;</span><span class="token punctuation">)</span></span>
<span class="line">channel<span class="token punctuation">.</span>queue_bind<span class="token punctuation">(</span></span>
<span class="line">    exchange<span class="token operator">=</span><span class="token string">&#39;dlx_exchange&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    queue<span class="token operator">=</span><span class="token string">&#39;dead_letter_queue&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    routing_key<span class="token operator">=</span><span class="token string">&#39;dead_letter&#39;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-延迟队列" tabindex="-1"><a class="header-anchor" href="#_7-延迟队列"><span>7. 延迟队列</span></a></h3><p>使用 TTL + 死信队列实现:</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 延迟队列(无消费者)</span></span>
<span class="line">channel<span class="token punctuation">.</span>queue_declare<span class="token punctuation">(</span></span>
<span class="line">    queue<span class="token operator">=</span><span class="token string">&#39;delay_queue&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    arguments<span class="token operator">=</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&#39;x-dead-letter-exchange&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;work_exchange&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&#39;x-dead-letter-routing-key&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;work&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&#39;x-message-ttl&#39;</span><span class="token punctuation">:</span> <span class="token number">30000</span>  <span class="token comment"># 延迟30秒</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 工作队列</span></span>
<span class="line">channel<span class="token punctuation">.</span>exchange_declare<span class="token punctuation">(</span>exchange<span class="token operator">=</span><span class="token string">&#39;work_exchange&#39;</span><span class="token punctuation">,</span> exchange_type<span class="token operator">=</span><span class="token string">&#39;direct&#39;</span><span class="token punctuation">)</span></span>
<span class="line">channel<span class="token punctuation">.</span>queue_declare<span class="token punctuation">(</span>queue<span class="token operator">=</span><span class="token string">&#39;work_queue&#39;</span><span class="token punctuation">)</span></span>
<span class="line">channel<span class="token punctuation">.</span>queue_bind<span class="token punctuation">(</span>exchange<span class="token operator">=</span><span class="token string">&#39;work_exchange&#39;</span><span class="token punctuation">,</span> queue<span class="token operator">=</span><span class="token string">&#39;work_queue&#39;</span><span class="token punctuation">,</span> routing_key<span class="token operator">=</span><span class="token string">&#39;work&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="管理与监控" tabindex="-1"><a class="header-anchor" href="#管理与监控"><span>管理与监控</span></a></h2><h3 id="命令行工具-rabbitmqctl" tabindex="-1"><a class="header-anchor" href="#命令行工具-rabbitmqctl"><span>命令行工具(rabbitmqctl)</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 查看队列</span></span>
<span class="line">rabbitmqctl list_queues</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看交换机</span></span>
<span class="line">rabbitmqctl list_exchanges</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看绑定</span></span>
<span class="line">rabbitmqctl list_bindings</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看连接</span></span>
<span class="line">rabbitmqctl list_connections</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 添加用户</span></span>
<span class="line">rabbitmqctl add_user username password</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 设置用户角色</span></span>
<span class="line">rabbitmqctl set_user_tags username administrator</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 设置权限</span></span>
<span class="line">rabbitmqctl set_permissions <span class="token parameter variable">-p</span> / username <span class="token string">&quot;.*&quot;</span> <span class="token string">&quot;.*&quot;</span> <span class="token string">&quot;.*&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 删除队列</span></span>
<span class="line">rabbitmqctl delete_queue queue_name</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 清空队列</span></span>
<span class="line">rabbitmqctl purge_queue queue_name</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看集群状态</span></span>
<span class="line">rabbitmqctl cluster_status</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="web-管理界面" tabindex="-1"><a class="header-anchor" href="#web-管理界面"><span>Web 管理界面</span></a></h3><p>访问 http://localhost:15672 可以:</p><ul><li>监控队列、交换机、连接状态</li><li>查看消息速率和统计信息</li><li>手动发送和接收消息</li><li>管理用户和权限</li><li>配置策略和参数</li></ul><h3 id="http-api" tabindex="-1"><a class="header-anchor" href="#http-api"><span>HTTP API</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 获取队列列表</span></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-u</span> admin:admin123 http://localhost:15672/api/queues</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 获取特定队列信息</span></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-u</span> admin:admin123 http://localhost:15672/api/queues/%2F/queue_name</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 发布消息</span></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-u</span> admin:admin123 <span class="token parameter variable">-H</span> <span class="token string">&quot;content-type:application/json&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">-X</span> POST http://localhost:15672/api/exchanges/%2F/amq.default/publish <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">-d</span> <span class="token string">&#39;{&quot;properties&quot;:{},&quot;routing_key&quot;:&quot;queue_name&quot;,&quot;payload&quot;:&quot;test message&quot;,&quot;payload_encoding&quot;:&quot;string&quot;}&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="最佳实践" tabindex="-1"><a class="header-anchor" href="#最佳实践"><span>最佳实践</span></a></h2><h3 id="_1-连接管理" tabindex="-1"><a class="header-anchor" href="#_1-连接管理"><span>1. 连接管理</span></a></h3><ul><li>使用连接池,避免频繁创建和销毁连接</li><li>一个应用使用一个连接,多个线程共享信道</li><li>妥善处理连接断开和重连逻辑</li></ul><h3 id="_2-消息可靠性" tabindex="-1"><a class="header-anchor" href="#_2-消息可靠性"><span>2. 消息可靠性</span></a></h3><ul><li>开启生产者确认(Publisher Confirms)</li><li>使用手动消息确认</li><li>启用消息和队列持久化</li><li>实现幂等性消费,防止重复处理</li></ul><h3 id="_3-性能优化" tabindex="-1"><a class="header-anchor" href="#_3-性能优化"><span>3. 性能优化</span></a></h3><ul><li>批量发送和确认消息</li><li>使用合适的预取数量(prefetch_count)</li><li>避免在消费者回调中执行耗时操作</li><li>考虑使用延迟确认(basic.ack multiple=true)</li></ul><h3 id="_4-监控和告警" tabindex="-1"><a class="header-anchor" href="#_4-监控和告警"><span>4. 监控和告警</span></a></h3><ul><li>监控队列深度,防止消息堆积</li><li>监控消费速率和发布速率</li><li>设置内存和磁盘告警阈值</li><li>定期检查死信队列</li></ul><h3 id="_5-集群和高可用" tabindex="-1"><a class="header-anchor" href="#_5-集群和高可用"><span>5. 集群和高可用</span></a></h3><ul><li>使用镜像队列提高可用性</li><li>配置合理的集群分区处理策略</li><li>定期备份重要配置和数据</li><li>使用负载均衡器分发连接</li></ul><h3 id="_6-安全性" tabindex="-1"><a class="header-anchor" href="#_6-安全性"><span>6. 安全性</span></a></h3><ul><li>使用强密码和定期更换</li><li>启用 TLS/SSL 加密传输</li><li>配置细粒度的用户权限</li><li>定期审计访问日志</li></ul><h3 id="_7-队列设计" tabindex="-1"><a class="header-anchor" href="#_7-队列设计"><span>7. 队列设计</span></a></h3><ul><li>避免创建过多队列,考虑使用路由键分流</li><li>设置合理的队列长度限制</li><li>为临时队列使用 exclusive 和 auto-delete</li><li>使用命名规范便于管理</li></ul><h3 id="_8-错误处理" tabindex="-1"><a class="header-anchor" href="#_8-错误处理"><span>8. 错误处理</span></a></h3><ul><li>实现重试机制,设置最大重试次数</li><li>使用死信队列处理失败消息</li><li>记录详细的错误日志</li><li>实现告警机制</li></ul><hr><p><strong>参考资源:</strong></p><ul><li>官方文档: https://www.rabbitmq.com/documentation.html</li><li>官方教程: https://www.rabbitmq.com/getstarted.html</li><li>GitHub: https://github.com/rabbitmq</li></ul><p><strong>版本说明:</strong> 本手册基于 RabbitMQ 3.x 系列编写,适用于最新稳定版本。</p>`,124))])}const k=l(o,[["render",u],["__file","index.html.vue"]]),v=JSON.parse('{"path":"/books/rabbitmq-handbook/","title":"RabbitMQ 使用手册","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"简介","slug":"简介","link":"#简介","children":[]},{"level":2,"title":"安装与配置","slug":"安装与配置","link":"#安装与配置","children":[{"level":3,"title":"Docker 安装(推荐)","slug":"docker-安装-推荐","link":"#docker-安装-推荐","children":[]},{"level":3,"title":"Ubuntu/Debian 安装","slug":"ubuntu-debian-安装","link":"#ubuntu-debian-安装","children":[]},{"level":3,"title":"基本配置","slug":"基本配置","link":"#基本配置","children":[]}]},{"level":2,"title":"核心概念","slug":"核心概念","link":"#核心概念","children":[{"level":3,"title":"1. 连接(Connection)","slug":"_1-连接-connection","link":"#_1-连接-connection","children":[]},{"level":3,"title":"2. 信道(Channel)","slug":"_2-信道-channel","link":"#_2-信道-channel","children":[]},{"level":3,"title":"3. 交换机(Exchange)","slug":"_3-交换机-exchange","link":"#_3-交换机-exchange","children":[]},{"level":3,"title":"4. 队列(Queue)","slug":"_4-队列-queue","link":"#_4-队列-queue","children":[]},{"level":3,"title":"5. 绑定(Binding)","slug":"_5-绑定-binding","link":"#_5-绑定-binding","children":[]},{"level":3,"title":"6. 虚拟主机(Virtual Host)","slug":"_6-虚拟主机-virtual-host","link":"#_6-虚拟主机-virtual-host","children":[]}]},{"level":2,"title":"快速开始","slug":"快速开始","link":"#快速开始","children":[{"level":3,"title":"Python 示例(使用 pika)","slug":"python-示例-使用-pika","link":"#python-示例-使用-pika","children":[]},{"level":3,"title":"Java 示例(使用 Spring AMQP)","slug":"java-示例-使用-spring-amqp","link":"#java-示例-使用-spring-amqp","children":[]}]},{"level":2,"title":"消息模式","slug":"消息模式","link":"#消息模式","children":[{"level":3,"title":"1. 简单队列(Simple Queue)","slug":"_1-简单队列-simple-queue","link":"#_1-简单队列-simple-queue","children":[]},{"level":3,"title":"2. 工作队列(Work Queue)","slug":"_2-工作队列-work-queue","link":"#_2-工作队列-work-queue","children":[]},{"level":3,"title":"3. 发布/订阅(Publish/Subscribe)","slug":"_3-发布-订阅-publish-subscribe","link":"#_3-发布-订阅-publish-subscribe","children":[]},{"level":3,"title":"4. 路由(Routing)","slug":"_4-路由-routing","link":"#_4-路由-routing","children":[]},{"level":3,"title":"5. 主题(Topics)","slug":"_5-主题-topics","link":"#_5-主题-topics","children":[]},{"level":3,"title":"6. RPC 模式","slug":"_6-rpc-模式","link":"#_6-rpc-模式","children":[]}]},{"level":2,"title":"高级特性","slug":"高级特性","link":"#高级特性","children":[{"level":3,"title":"1. 消息确认(Acknowledgment)","slug":"_1-消息确认-acknowledgment","link":"#_1-消息确认-acknowledgment","children":[]},{"level":3,"title":"2. 消息持久化","slug":"_2-消息持久化","link":"#_2-消息持久化","children":[]},{"level":3,"title":"3. 公平分发(Fair Dispatch)","slug":"_3-公平分发-fair-dispatch","link":"#_3-公平分发-fair-dispatch","children":[]},{"level":3,"title":"4. 消息优先级","slug":"_4-消息优先级","link":"#_4-消息优先级","children":[]},{"level":3,"title":"5. 消息过期时间(TTL)","slug":"_5-消息过期时间-ttl","link":"#_5-消息过期时间-ttl","children":[]},{"level":3,"title":"6. 死信队列(Dead Letter Exchange)","slug":"_6-死信队列-dead-letter-exchange","link":"#_6-死信队列-dead-letter-exchange","children":[]},{"level":3,"title":"7. 延迟队列","slug":"_7-延迟队列","link":"#_7-延迟队列","children":[]}]},{"level":2,"title":"管理与监控","slug":"管理与监控","link":"#管理与监控","children":[{"level":3,"title":"命令行工具(rabbitmqctl)","slug":"命令行工具-rabbitmqctl","link":"#命令行工具-rabbitmqctl","children":[]},{"level":3,"title":"Web 管理界面","slug":"web-管理界面","link":"#web-管理界面","children":[]},{"level":3,"title":"HTTP API","slug":"http-api","link":"#http-api","children":[]}]},{"level":2,"title":"最佳实践","slug":"最佳实践","link":"#最佳实践","children":[{"level":3,"title":"1. 连接管理","slug":"_1-连接管理","link":"#_1-连接管理","children":[]},{"level":3,"title":"2. 消息可靠性","slug":"_2-消息可靠性","link":"#_2-消息可靠性","children":[]},{"level":3,"title":"3. 性能优化","slug":"_3-性能优化","link":"#_3-性能优化","children":[]},{"level":3,"title":"4. 监控和告警","slug":"_4-监控和告警","link":"#_4-监控和告警","children":[]},{"level":3,"title":"5. 集群和高可用","slug":"_5-集群和高可用","link":"#_5-集群和高可用","children":[]},{"level":3,"title":"6. 安全性","slug":"_6-安全性","link":"#_6-安全性","children":[]},{"level":3,"title":"7. 队列设计","slug":"_7-队列设计","link":"#_7-队列设计","children":[]},{"level":3,"title":"8. 错误处理","slug":"_8-错误处理","link":"#_8-错误处理","children":[]}]}],"git":{},"filePathRelative":"books/rabbitmq-handbook/index.md"}');export{k as comp,v as data};
