import{_ as n,c as a,f as e,o as p}from"./app-BB_BIQV8.js";const l={};function t(i,s){return p(),a("div",null,s[0]||(s[0]=[e(`<p>symfony配置异步邮件发送，主要有两种方式</p><ul><li>使用默认的messageHandler</li></ul><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">framework</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">messenger</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">failure_transport</span><span class="token punctuation">:</span> failed</span>
<span class="line"></span>
<span class="line">        <span class="token key atrule">transports</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># https://symfony.com/doc/current/messenger.html#transport-configuration</span></span>
<span class="line">            <span class="token key atrule">async</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token key atrule">dsn</span><span class="token punctuation">:</span> <span class="token string">&#39;%env(MESSENGER_TRANSPORT_DSN)%&#39;</span></span>
<span class="line">                <span class="token key atrule">options</span><span class="token punctuation">:</span></span>
<span class="line">                    <span class="token key atrule">use_notify</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">                    <span class="token key atrule">check_delayed_interval</span><span class="token punctuation">:</span> <span class="token number">60000</span></span>
<span class="line">                <span class="token key atrule">retry_strategy</span><span class="token punctuation">:</span></span>
<span class="line">                    <span class="token key atrule">max_retries</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line">                    <span class="token key atrule">multiplier</span><span class="token punctuation">:</span> <span class="token number">2</span></span>
<span class="line">            <span class="token key atrule">failed</span><span class="token punctuation">:</span> <span class="token string">&#39;doctrine://default?queue_name=failed&#39;</span></span>
<span class="line">            <span class="token key atrule">sync</span><span class="token punctuation">:</span> <span class="token string">&#39;sync://&#39;</span></span>
<span class="line"></span>
<span class="line">        <span class="token key atrule">routing</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">Symfony\\Component\\Mailer\\Messenger\\SendEmailMessage</span><span class="token punctuation">:</span> async</span>
<span class="line"></span>
<span class="line">            <span class="token comment"># Route your messages to the transports</span></span>
<span class="line">            <span class="token comment"># &#39;App\\Message\\YourMessage&#39;: async</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>使用自定义的messageHandler</li></ul><p>1.先创建一个消息类</p><div class="language-php line-numbers-mode" data-highlighter="prismjs" data-ext="php" data-title="php"><pre><code><span class="line"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\\</span>Message</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name-definition class-name">EmailAsync</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token variable">$subject</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token variable">$body</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token variable">$bodyText</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token variable">$recipient</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token variable">$context</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$subject</span><span class="token punctuation">,</span> <span class="token variable">$body</span><span class="token punctuation">,</span> <span class="token variable">$bodyText</span><span class="token punctuation">,</span> <span class="token variable">$recipient</span><span class="token punctuation">,</span> <span class="token variable">$context</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">subject</span> <span class="token operator">=</span> <span class="token variable">$subject</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">body</span> <span class="token operator">=</span> <span class="token variable">$body</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">bodyText</span> <span class="token operator">=</span> <span class="token variable">$bodyText</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">recipient</span> <span class="token operator">=</span> <span class="token variable">$recipient</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">context</span> <span class="token operator">=</span> <span class="token variable">$context</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2.创建一个消息处理类</p><div class="language-php line-numbers-mode" data-highlighter="prismjs" data-ext="php" data-title="php"><pre><code><span class="line"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\\</span>MessageHandler</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\\</span>Message<span class="token punctuation">\\</span>EmailAsync</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\\</span>Component<span class="token punctuation">\\</span>Mime<span class="token punctuation">\\</span>Address</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\\</span>Bridge<span class="token punctuation">\\</span>Twig<span class="token punctuation">\\</span>Mime<span class="token punctuation">\\</span>TemplatedEmail</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\\</span>Component<span class="token punctuation">\\</span>Mailer<span class="token punctuation">\\</span>MailerInterface</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\\</span>Component<span class="token punctuation">\\</span>Messenger<span class="token punctuation">\\</span>Handler<span class="token punctuation">\\</span>MessageHandlerInterface</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name-definition class-name">EmailAsyncHandler</span>  <span class="token keyword">implements</span> <span class="token class-name">MessageHandlerInterface</span> </span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token variable">$mailer</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">MailerInterface</span> <span class="token variable">$mailer</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">mailer</span> <span class="token operator">=</span> <span class="token variable">$mailer</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__invoke</span><span class="token punctuation">(</span><span class="token class-name type-declaration">EmailAsync</span> <span class="token variable">$email</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token variable">$subject</span> <span class="token operator">=</span> <span class="token variable">$email</span><span class="token operator">-&gt;</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token variable">$body</span> <span class="token operator">=</span> <span class="token variable">$email</span><span class="token operator">-&gt;</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token variable">$bodyText</span> <span class="token operator">=</span> <span class="token variable">$email</span><span class="token operator">-&gt;</span><span class="token function">getBodyText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token variable">$recipient</span> <span class="token operator">=</span> <span class="token variable">$email</span><span class="token operator">-&gt;</span><span class="token function">getRecipient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token variable">$context</span> <span class="token operator">=</span> <span class="token variable">$email</span><span class="token operator">-&gt;</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token variable">$emailToSend</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TemplatedEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token operator">-&gt;</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;my-address@hello.com&quot;</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token operator">-&gt;</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Address</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;your-address@hello.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token operator">-&gt;</span><span class="token function">subject</span><span class="token punctuation">(</span><span class="token variable">$subject</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">// path of the Twig template to render</span></span>
<span class="line">            <span class="token operator">-&gt;</span><span class="token function">htmlTemplate</span><span class="token punctuation">(</span><span class="token variable">$body</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token operator">-&gt;</span><span class="token function">textTemplate</span><span class="token punctuation">(</span><span class="token variable">$bodyText</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">// pass variables (name =&gt; value) to the template</span></span>
<span class="line">            <span class="token operator">-&gt;</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token variable">$context</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">mailer</span><span class="token operator">-&gt;</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token variable">$emailToSend</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3.配置messageHandler</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">framework</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">messenger</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">transports</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">async</span><span class="token punctuation">:</span> <span class="token string">&#39;%env(MESSENGER_TRANSPORT_DSN)%&#39;</span></span>
<span class="line"></span>
<span class="line">        <span class="token key atrule">routing</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># Route your messages to the transports</span></span>
<span class="line">            <span class="token key atrule">App\\Message\\EmailAsync</span><span class="token punctuation">:</span>  async</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4.触发邮件发送服务</p><div class="language-php line-numbers-mode" data-highlighter="prismjs" data-ext="php" data-title="php"><pre><code><span class="line"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\\</span>Service</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\\</span>Message<span class="token punctuation">\\</span>EmailAsync</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\\</span>Component<span class="token punctuation">\\</span>Messenger<span class="token punctuation">\\</span>MessageBusInterface</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name-definition class-name">MailManagerAsync</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token variable">$bus</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">MessageBusInterface</span> <span class="token variable">$bus</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">bus</span> <span class="token operator">=</span> <span class="token variable">$bus</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">sendMessage</span><span class="token punctuation">(</span><span class="token variable">$subject</span><span class="token punctuation">,</span> <span class="token variable">$body</span><span class="token punctuation">,</span> <span class="token variable">$bodyText</span><span class="token punctuation">,</span> <span class="token variable">$to</span><span class="token punctuation">,</span> <span class="token variable">$context</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token variable">$emailAsync</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EmailAsync</span><span class="token punctuation">(</span><span class="token variable">$subject</span><span class="token punctuation">,</span> <span class="token variable">$body</span><span class="token punctuation">,</span> <span class="token variable">$bodyText</span><span class="token punctuation">,</span> <span class="token variable">$to</span><span class="token punctuation">,</span> <span class="token variable">$context</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">bus</span><span class="token operator">-&gt;</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token variable">$emailAsync</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>整个流程和普通的消息队列是一样的</p><p>注意点:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">之前我这里有个问题，在config/packages/dev/mailer.yaml 里配置了:</span>
<span class="line">framework:</span>
<span class="line">    mailer:</span>
<span class="line">        dsn: &#39;%env(MAILER_DSN)%&#39;</span>
<span class="line">        message_bus: false</span>
<span class="line"></span>
<span class="line">根据官网的介绍(https://symfony.com/doc/5.4/mailer.html#sending-messages-async)可以知道，这里配置</span>
<span class="line">为false以后 asymc 就会失效，尤其是这个 dev 环境，直接覆盖了我的配置，所以导致 async 一直不生效</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,15)]))}const o=n(l,[["render",t],["__file","symfony之手动配置异步发送邮件.html.vue"]]),u=JSON.parse('{"path":"/content/php/symfony/symfony%E4%B9%8B%E6%89%8B%E5%8A%A8%E9%85%8D%E7%BD%AE%E5%BC%82%E6%AD%A5%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6.html","title":"symfony之手动配置异步发送邮件","lang":"en-US","frontmatter":{"sidebar":false,"title":"symfony之手动配置异步发送邮件","description":"symfony之手动配置异步发送邮件"},"headers":[],"git":{},"filePathRelative":"content/php/symfony/symfony之手动配置异步发送邮件.md"}');export{o as comp,u as data};
