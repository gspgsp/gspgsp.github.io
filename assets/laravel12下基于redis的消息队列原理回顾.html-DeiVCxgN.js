import{_ as n,c as a,f as e,o as t}from"./app-BB_BIQV8.js";const p={};function l(i,s){return t(),a("div",null,s[0]||(s[0]=[e(`<h5 id="laravel12ä¸‹åŸºäºredisçš„æ¶ˆæ¯é˜Ÿåˆ—åŸç†å›é¡¾" tabindex="-1"><a class="header-anchor" href="#laravel12ä¸‹åŸºäºredisçš„æ¶ˆæ¯é˜Ÿåˆ—åŸç†å›é¡¾"><span>laravel12ä¸‹åŸºäºredisçš„æ¶ˆæ¯é˜Ÿåˆ—åŸç†å›é¡¾</span></a></h5><h5 id="_1-å‘½ä»¤å‚æ•°å«ä¹‰" tabindex="-1"><a class="header-anchor" href="#_1-å‘½ä»¤å‚æ•°å«ä¹‰"><span>1. å‘½ä»¤å‚æ•°å«ä¹‰</span></a></h5><ul><li><code>queue:work</code> ğŸ‘‰ å¯åŠ¨ä¸€ä¸ª <strong>é˜Ÿåˆ— Worker è¿›ç¨‹</strong></li><li><code>redis</code> ğŸ‘‰ ä¸æ˜¯ <strong>queue åç§°</strong>ï¼Œè€Œæ˜¯ <strong>é˜Ÿåˆ—è¿æ¥ï¼ˆconnectionï¼‰åç§°</strong></li></ul><p>Laravel çš„é˜Ÿåˆ—é…ç½®åœ¨ <code>config/queue.php</code>ï¼Œé‡Œé¢æœ‰ <code>connections</code>ï¼š</p><div class="language-php line-numbers-mode" data-highlighter="prismjs" data-ext="php" data-title="php"><pre><code><span class="line"><span class="token string single-quoted-string">&#39;connections&#39;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string single-quoted-string">&#39;sync&#39;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string single-quoted-string">&#39;database&#39;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string single-quoted-string">&#39;redis&#39;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>   <span class="token comment">// â† è¿™é‡Œå°±æ˜¯ connection åå­—</span></span>
<span class="line">        <span class="token string single-quoted-string">&#39;driver&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;redis&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string single-quoted-string">&#39;connection&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;default&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string single-quoted-string">&#39;queue&#39;</span> <span class="token operator">=&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;REDIS_QUEUE&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;default&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// é»˜è®¤é˜Ÿåˆ—åå« &quot;default&quot;</span></span>
<span class="line">        <span class="token string single-quoted-string">&#39;retry_after&#39;</span> <span class="token operator">=&gt;</span> <span class="token number">90</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string single-quoted-string">&#39;block_for&#39;</span> <span class="token operator">=&gt;</span> <span class="token constant">null</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰€ä»¥ä½ è¿è¡Œï¼š</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">php artisan queue:work redis</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>è¡¨ç¤ºï¼š<strong>ç”¨ <code>redis</code> è¿™ä¸ª connection å»å–ä»»åŠ¡</strong>ã€‚</p><p>å¦‚æœä½ è¦æŒ‡å®šé˜Ÿåˆ—åå­—ï¼ˆqueue nameï¼‰ï¼Œè¦é¢å¤–ä¼ ï¼š</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">php artisan queue:work redis <span class="token parameter variable">--queue</span><span class="token operator">=</span>emails</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>è¿™æ ·å°±ä¼šæ¶ˆè´¹ <code>emails</code> é˜Ÿåˆ—ï¼Œè€Œä¸æ˜¯é»˜è®¤çš„ <code>default</code>ã€‚</p><h5 id="_2-worker-çš„è¿è¡ŒåŸç†" tabindex="-1"><a class="header-anchor" href="#_2-worker-çš„è¿è¡ŒåŸç†"><span>2. Worker çš„è¿è¡ŒåŸç†</span></a></h5><p><code>queue:work</code> ä¼šå¯åŠ¨ä¸€ä¸ªå¸¸é©» PHP è¿›ç¨‹ï¼Œå†…éƒ¨å¤§è‡´æµç¨‹æ˜¯ï¼š</p><ol><li>è¿›å…¥å¾ªç¯ â†’ ä¸æ–­å‘ Redis é‡Œ <code>BLPOP</code>ï¼ˆé˜»å¡å¼ popï¼‰ é˜Ÿåˆ— <ul><li>é»˜è®¤é˜Ÿåˆ— key æ ¼å¼ï¼š<code>queues:default</code></li><li>å¦‚æœæŒ‡å®š <code>--queue=emails</code> â†’ key å°±æ˜¯ <code>queues:emails</code></li></ul></li><li>æ‹¿åˆ°é˜Ÿåˆ—æ¶ˆæ¯ï¼ˆå°±æ˜¯è¢« <code>dispatch()</code> åºåˆ—åŒ–è¿‡çš„ Job æ•°æ®ï¼‰</li><li>ååºåˆ—åŒ– Job â†’ è°ƒç”¨ Job çš„ <code>handle()</code> æ–¹æ³•</li><li>å¦‚æœå¤±è´¥ â†’ é‡æ–°å…¥é˜Ÿï¼ˆå»¶è¿Ÿï¼‰ï¼Œæˆ–è€…è¿›å…¥ <code>failed_jobs</code> è¡¨ <strong>æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå¸¸é©»æ¶ˆè´¹è€…è¿›ç¨‹ï¼Œç”¨ Redis åˆ—è¡¨å®ç°æ¶ˆæ¯é˜Ÿåˆ—ã€‚</strong></li></ol><h5 id="_3-redis-ä¸­çš„å­˜å‚¨å½¢å¼" tabindex="-1"><a class="header-anchor" href="#_3-redis-ä¸­çš„å­˜å‚¨å½¢å¼"><span>3. Redis ä¸­çš„å­˜å‚¨å½¢å¼</span></a></h5><p>å½“ä½ æ´¾å‘ Jobï¼š</p><div class="language-php line-numbers-mode" data-highlighter="prismjs" data-ext="php" data-title="php"><pre><code><span class="line"><span class="token class-name static-context">SendEmailJob</span><span class="token operator">::</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;test@example.com&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Redis é‡Œä¼šå¤šä¸€æ¡æ•°æ®ï¼š</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">LPUSH queues:default <span class="token string">&quot;åºåˆ—åŒ–åçš„ Job&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Worker æ¶ˆè´¹æ—¶å°±æ˜¯ï¼š</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">BRPOP queues:default</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>ç„¶åæ‰§è¡Œ Jobã€‚</p><p>âœ… æ€»ç»“ï¼š</p><ul><li><code>php artisan queue:work redis</code> é‡Œçš„ <strong>redis = connection å</strong>ï¼Œä¸æ˜¯ queue åã€‚</li><li>çœŸæ­£çš„ <strong>é˜Ÿåˆ—åï¼ˆqueue nameï¼‰</strong> é»˜è®¤æ˜¯ <code>default</code>ï¼Œå¯ä»¥ç”¨ <code>--queue=</code> å‚æ•°æŒ‡å®šã€‚å¦‚ï¼š php artisan queue:work redis --queue=emails</li><li>Worker å†…éƒ¨å°±æ˜¯ä¸æ–­ <strong>BRPOP Redis åˆ—è¡¨</strong>ï¼Œå–å‡º Jobï¼Œæ‰§è¡Œ <code>handle()</code>ã€‚</li></ul><hr><h5 id="config-queue-phpä¸‹å…³äº-after-commité…ç½®çš„ä½¿ç”¨-è¿™ä¸ªç‰¹æ€§å¾ˆæœ‰å¿…è¦-è²Œä¼¼ä»larael9-x-å°±æœ‰äº†-å®é™…ä¸Šæœ‰æ—¶å€™ç¡®å®éœ€è¦æ•°æ®åº“æ“ä½œå®Œæˆ-æ‰å›å»è§¦å‘å¼‚æ­¥ä»»åŠ¡-è¿™æ ·çš„éœ€æ±‚å¾ˆå¤š" tabindex="-1"><a class="header-anchor" href="#config-queue-phpä¸‹å…³äº-after-commité…ç½®çš„ä½¿ç”¨-è¿™ä¸ªç‰¹æ€§å¾ˆæœ‰å¿…è¦-è²Œä¼¼ä»larael9-x-å°±æœ‰äº†-å®é™…ä¸Šæœ‰æ—¶å€™ç¡®å®éœ€è¦æ•°æ®åº“æ“ä½œå®Œæˆ-æ‰å›å»è§¦å‘å¼‚æ­¥ä»»åŠ¡-è¿™æ ·çš„éœ€æ±‚å¾ˆå¤š"><span>config/queue.phpä¸‹å…³äº after_commité…ç½®çš„ä½¿ç”¨ï¼Œè¿™ä¸ªç‰¹æ€§å¾ˆæœ‰å¿…è¦ï¼Œè²Œä¼¼ä»larael9.x å°±æœ‰äº†ï¼Œå®é™…ä¸Šæœ‰æ—¶å€™ç¡®å®éœ€è¦æ•°æ®åº“æ“ä½œå®Œæˆï¼Œæ‰å›å»è§¦å‘å¼‚æ­¥ä»»åŠ¡ï¼Œè¿™æ ·çš„éœ€æ±‚å¾ˆå¤š</span></a></h5><p>åœ¨ <strong>Laravel 12</strong> çš„ <code>queue.php</code> é…ç½®ä¸­ï¼Œ<code>after_commit</code> æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ–°çš„é€‰é¡¹ï¼Œç”¨æ¥æ§åˆ¶ <strong>Job æ˜¯å¦åœ¨æ•°æ®åº“äº‹åŠ¡æäº¤åå†å…¥é˜Ÿ</strong>ã€‚</p><h3 id="_1-é»˜è®¤é…ç½®ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#_1-é»˜è®¤é…ç½®ç¤ºä¾‹"><span>1. é»˜è®¤é…ç½®ç¤ºä¾‹</span></a></h3><div class="language-php line-numbers-mode" data-highlighter="prismjs" data-ext="php" data-title="php"><pre><code><span class="line"><span class="token string single-quoted-string">&#39;connections&#39;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string single-quoted-string">&#39;database&#39;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token string single-quoted-string">&#39;driver&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;database&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string single-quoted-string">&#39;table&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;jobs&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string single-quoted-string">&#39;queue&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;default&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string single-quoted-string">&#39;retry_after&#39;</span> <span class="token operator">=&gt;</span> <span class="token number">90</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string single-quoted-string">&#39;after_commit&#39;</span> <span class="token operator">=&gt;</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string single-quoted-string">&#39;redis&#39;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token string single-quoted-string">&#39;driver&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;redis&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string single-quoted-string">&#39;connection&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;default&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string single-quoted-string">&#39;queue&#39;</span> <span class="token operator">=&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;REDIS_QUEUE&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;default&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string single-quoted-string">&#39;retry_after&#39;</span> <span class="token operator">=&gt;</span> <span class="token number">90</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string single-quoted-string">&#39;block_for&#39;</span> <span class="token operator">=&gt;</span> <span class="token constant">null</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string single-quoted-string">&#39;after_commit&#39;</span> <span class="token operator">=&gt;</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-after-commit-çš„ä½œç”¨" tabindex="-1"><a class="header-anchor" href="#_2-after-commit-çš„ä½œç”¨"><span>2. <code>after_commit</code> çš„ä½œç”¨</span></a></h5><ul><li><p><strong><code>after_commit = false</code>ï¼ˆé»˜è®¤ï¼‰</strong></p><ul><li>Job ä¼šç«‹å³å…¥é˜Ÿï¼Œå³ä½¿å½“å‰æ•°æ®åº“äº‹åŠ¡å°šæœªæäº¤</li><li>å¦‚æœäº‹åŠ¡å›æ»šï¼ŒJob ä¾ç„¶ä¼šè¢«æ¶ˆè´¹ â†’ å¯èƒ½å¯¼è‡´ä¸šåŠ¡é€»è¾‘å¼‚å¸¸</li></ul></li><li><p><strong><code>after_commit = true</code></strong></p><ul><li>Job ä¼š <strong>ç­‰åˆ°æ•°æ®åº“äº‹åŠ¡æäº¤æˆåŠŸå</strong> å†å…¥é˜Ÿ</li><li>ä¿è¯ Job æ¶ˆè´¹æ—¶ï¼Œç›¸å…³æ•°æ®åº“æ“ä½œå·²ç»ç”Ÿæ•ˆ</li><li>å¸¸ç”¨äºä¾èµ–æ•°æ®åº“çŠ¶æ€çš„å¼‚æ­¥ä»»åŠ¡ï¼Œä¾‹å¦‚å‘é€é‚®ä»¶ã€å»¶è¿Ÿè®¡ç®—ç»Ÿè®¡ç­‰</li></ul></li></ul><h5 id="_3-ä½¿ç”¨ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#_3-ä½¿ç”¨ç¤ºä¾‹"><span>3. ä½¿ç”¨ç¤ºä¾‹</span></a></h5><div class="language-php line-numbers-mode" data-highlighter="prismjs" data-ext="php" data-title="php"><pre><code><span class="line"><span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\\</span>Jobs<span class="token punctuation">\\</span>MyJob</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\\</span>Support<span class="token punctuation">\\</span>Facades<span class="token punctuation">\\</span>DB</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name static-context">DB</span><span class="token operator">::</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">use</span> <span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;status&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;active&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// Job åªæœ‰åœ¨äº‹åŠ¡æäº¤æˆåŠŸåæ‰ä¼šå…¥é˜Ÿ</span></span>
<span class="line">    <span class="token class-name static-context">MyJob</span><span class="token operator">::</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">afterCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>afterCommit()</code> æ–¹æ³•å¯ä»¥åœ¨ dispatch æ—¶å•ç‹¬æ§åˆ¶</li><li>é…ç½®æ–‡ä»¶ <code>after_commit</code> é€‰é¡¹æ˜¯å…¨å±€é»˜è®¤å€¼</li></ul><h5 id="_4-æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#_4-æ€»ç»“"><span>4. æ€»ç»“</span></a></h5><table><thead><tr><th>é…ç½® / æ–¹æ³•</th><th>è¡Œä¸º</th></tr></thead><tbody><tr><td><code>after_commit = false</code></td><td>Job ç«‹å³å…¥é˜Ÿï¼Œä¸ä¾èµ–äº‹åŠ¡æäº¤</td></tr><tr><td><code>after_commit = true</code></td><td>Job åªæœ‰åœ¨äº‹åŠ¡æäº¤æˆåŠŸåå…¥é˜Ÿ</td></tr><tr><td><code>-&gt;afterCommit()</code> æ–¹æ³•</td><td>å•æ¬¡ dispatch æ—¶è¦†ç›–å…¨å±€é…ç½®</td></tr></tbody></table><p>âœ… å°ç»“ï¼š</p><ul><li>å¦‚æœ Job ä¾èµ–æ•°æ®åº“çŠ¶æ€ï¼Œ<strong>æ¨èå¼€å¯ <code>after_commit</code></strong> æˆ–ä½¿ç”¨ <code>-&gt;afterCommit()</code></li><li>å¦‚æœ Job ä¸äº‹åŠ¡æ— å…³ï¼Œå¯ä»¥ä¿æŒé»˜è®¤ <code>false</code></li></ul><hr><h5 id="ä½¿ç”¨å»¶è¿Ÿé˜Ÿåˆ—" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨å»¶è¿Ÿé˜Ÿåˆ—"><span>ä½¿ç”¨å»¶è¿Ÿé˜Ÿåˆ—</span></a></h5><p>åœ¨ <strong>Laravel 12</strong> ä¸‹ï¼Œå¦‚æœä½ æƒ³è®©æŸä¸ª Job <strong>å»¶è¿Ÿæ‰§è¡Œ</strong>ï¼Œå¯ä»¥ç”¨ <strong><code>delay()</code> æ–¹æ³•</strong> æˆ– <code>onQueue</code> + <code>delay</code> çš„ç»„åˆã€‚è¿™é‡Œè¯¦ç»†è®²ä¸€ä¸‹ï¼š</p><h5 id="_1-åœ¨-dispatch-æ—¶æŒ‡å®šå»¶è¿Ÿ" tabindex="-1"><a class="header-anchor" href="#_1-åœ¨-dispatch-æ—¶æŒ‡å®šå»¶è¿Ÿ"><span>1. åœ¨ Dispatch æ—¶æŒ‡å®šå»¶è¿Ÿ</span></a></h5><div class="language-php line-numbers-mode" data-highlighter="prismjs" data-ext="php" data-title="php"><pre><code><span class="line"><span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\\</span>Jobs<span class="token punctuation">\\</span>MyJob</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\\</span>Support<span class="token punctuation">\\</span>Facades<span class="token punctuation">\\</span>Bus</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å»¶è¿Ÿ 10 ç§’æ‰§è¡Œ</span></span>
<span class="line"><span class="token class-name static-context">MyJob</span><span class="token operator">::</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token variable">$param1</span><span class="token punctuation">,</span> <span class="token variable">$param2</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">delay</span><span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">addSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>now()</code> â†’ å½“å‰æ—¶é—´</li><li><code>addSeconds(10)</code> â†’ å»¶è¿Ÿ 10 ç§’</li><li>ä¹Ÿå¯ä»¥ç”¨ <code>addMinutes()</code>, <code>addHours()</code> ç­‰</li></ul><h5 id="ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­"><span>ä¾‹å­ï¼š</span></a></h5><div class="language-php line-numbers-mode" data-highlighter="prismjs" data-ext="php" data-title="php"><pre><code><span class="line"><span class="token class-name static-context">MyJob</span><span class="token operator">::</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">delay</span><span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">addMinutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>Job ä¼šè¢«æ¨åˆ°é˜Ÿåˆ—ï¼Œä½† <strong>ä¸ä¼šç«‹å³è¢« worker æ‰§è¡Œ</strong></li><li>Worker å–åˆ°ä»»åŠ¡æ—¶ä¼šæ£€æŸ¥ <code>available_at</code> æ—¶é—´ï¼Œæœªåˆ°æ—¶ä¼šè·³è¿‡</li></ul><h5 id="_2-åœ¨-job-ç±»é‡Œä½¿ç”¨-shouldqueue" tabindex="-1"><a class="header-anchor" href="#_2-åœ¨-job-ç±»é‡Œä½¿ç”¨-shouldqueue"><span>2. åœ¨ Job ç±»é‡Œä½¿ç”¨ <code>ShouldQueue</code></span></a></h5><p>ç¡®ä¿ä½ çš„ Job ç±»å®ç°äº† <code>ShouldQueue</code>ï¼š</p><div class="language-php line-numbers-mode" data-highlighter="prismjs" data-ext="php" data-title="php"><pre><code><span class="line"><span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\\</span>Bus<span class="token punctuation">\\</span>Queueable</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\\</span>Contracts<span class="token punctuation">\\</span>Queue<span class="token punctuation">\\</span>ShouldQueue</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\\</span>Foundation<span class="token punctuation">\\</span>Bus<span class="token punctuation">\\</span>Dispatchable</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name-definition class-name">MyJob</span> <span class="token keyword">implements</span> <span class="token class-name">ShouldQueue</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">use</span> <span class="token package">Dispatchable</span><span class="token punctuation">,</span> Queueable<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ä»»åŠ¡é€»è¾‘</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>Queueable</code> trait æä¾›äº† <code>delay()</code> æ–¹æ³•çš„æ”¯æŒ</li><li><code>ShouldQueue</code> å‘Šè¯‰ Laravel è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡</li></ul><h5 id="_3-ç»“åˆé˜Ÿåˆ—å" tabindex="-1"><a class="header-anchor" href="#_3-ç»“åˆé˜Ÿåˆ—å"><span>3. ç»“åˆé˜Ÿåˆ—å</span></a></h5><p>å¦‚æœä½ æœ‰å¤šä¸ªé˜Ÿåˆ—ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šé˜Ÿåˆ—ï¼š</p><div class="language-php line-numbers-mode" data-highlighter="prismjs" data-ext="php" data-title="php"><pre><code><span class="line"><span class="token class-name static-context">MyJob</span><span class="token operator">::</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token operator">-&gt;</span><span class="token function">onQueue</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;emails&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token operator">-&gt;</span><span class="token function">delay</span><span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">addMinutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Job ä¼šè¢«æ¨åˆ° <code>emails</code> é˜Ÿåˆ—</li><li>Worker å¯ä»¥ä¸“é—¨ç›‘å¬ <code>emails</code> é˜Ÿåˆ—</li></ul><h5 id="_4-å»¶è¿Ÿå®ç°åŸç†-redis-é˜Ÿåˆ—" tabindex="-1"><a class="header-anchor" href="#_4-å»¶è¿Ÿå®ç°åŸç†-redis-é˜Ÿåˆ—"><span>4. å»¶è¿Ÿå®ç°åŸç†ï¼ˆRedis é˜Ÿåˆ—ï¼‰</span></a></h5><ul><li>Laravel ä¼šæŠŠ Job æ¨åˆ° <strong>Redis çš„ <code>delayed</code> é˜Ÿåˆ—</strong></li><li>Worker ä¼šå‘¨æœŸæ€§æ£€æŸ¥ä»»åŠ¡çš„ <code>available_at</code> æ—¶é—´</li><li>åªæœ‰åˆ°è¾¾æ—¶é—´çš„ Job æ‰ä¼šä» <code>delayed</code> é˜Ÿåˆ—ç§»åŠ¨åˆ°æ­£å¸¸é˜Ÿåˆ—ï¼Œç­‰å¾…æ¶ˆè´¹</li></ul><blockquote><p>æ‰€ä»¥å»¶è¿Ÿæ‰§è¡Œæ˜¯é€šè¿‡ <strong>Redis é˜Ÿåˆ— + æ—¶é—´æˆ³</strong> æ§åˆ¶çš„ï¼Œä¸ä¾èµ– PHP sleep æˆ–é˜»å¡</p></blockquote><h5 id="_5-å…³äº-å»¶è¿ŸåŸç†çš„è¯¦ç»†åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_5-å…³äº-å»¶è¿ŸåŸç†çš„è¯¦ç»†åˆ†æ"><span>5.å…³äº å»¶è¿ŸåŸç†çš„è¯¦ç»†åˆ†æ</span></a></h5><p>åœ¨ <strong>Laravel é˜Ÿåˆ— + Redis</strong> çš„åœºæ™¯ä¸‹ï¼ŒWorker ç¡®å®åŒæ—¶æ‰®æ¼”äº† <strong>ä¸¤ä¸ªè§’è‰²</strong>ï¼š</p><ol><li><strong>æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰</strong></li></ol><ul><li>ä»ä¸»é˜Ÿåˆ—ï¼ˆready queueï¼‰å–ä»»åŠ¡æ‰§è¡Œ</li><li>æ ¸å¿ƒè¡Œä¸ºï¼š <ul><li>ç›‘å¬é˜Ÿåˆ—ï¼ˆBLPOP æˆ–è½®è¯¢ï¼‰</li><li>æ‹¿åˆ°ä»»åŠ¡ â†’ è°ƒç”¨ Job çš„ <code>handle()</code> æ‰§è¡Œ</li></ul></li><li>ç±»ä¼¼â€œçœŸæ­£çš„å·¥äººâ€ï¼Œè´Ÿè´£å¤„ç†ä¸šåŠ¡é€»è¾‘</li></ul><ol start="2"><li><strong>å»¶è¿Ÿä»»åŠ¡æ¬è¿è€…ï¼ˆDelayed Job Schedulerï¼‰</strong></li></ol><ul><li>å‘¨æœŸæ€§æ£€æŸ¥ Redis <code>delayed</code> é˜Ÿåˆ—</li><li>æ ¸å¿ƒè¡Œä¸ºï¼š <ul><li>å–å‡ºåˆ°è¾¾ <code>available_at</code> æ—¶é—´çš„ Job</li><li>æŠŠå®ƒç§»åŠ¨åˆ°ä¸»é˜Ÿåˆ—ï¼ˆready queueï¼‰</li></ul></li><li>ç±»ä¼¼â€œè°ƒåº¦å‘˜â€ï¼Œä¿è¯å»¶è¿Ÿä»»åŠ¡åœ¨åˆ°æœŸæ—¶è¿›å…¥å¯æ‰§è¡Œé˜Ÿåˆ—</li></ul><ol start="3"><li>å›¾ç¤ºç†è§£ï¼ˆé€»è¾‘æµç¨‹ï¼‰</li></ol><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">Delayed Queue (Redis zset)</span>
<span class="line">       |</span>
<span class="line">       |  Worker æ£€æŸ¥ available_at</span>
<span class="line">       v</span>
<span class="line">Ready Queue (Redis list)</span>
<span class="line">       |</span>
<span class="line">       |  Worker æ¶ˆè´¹ä»»åŠ¡</span>
<span class="line">       v</span>
<span class="line">Job handle() æ‰§è¡Œ</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¡¨æ ¼è§£æ:</p><table><thead><tr><th>æ¦‚å¿µ</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>Worker</td><td>è¿è¡Œ <code>php artisan queue:work</code> çš„ CLI è¿›ç¨‹</td></tr><tr><td>Delayed é˜Ÿåˆ—</td><td>Redis çš„ zsetï¼Œscore = available_at</td></tr><tr><td>å‘¨æœŸæ£€æŸ¥</td><td>Worker å¾ªç¯ä¸­è°ƒç”¨ <code>migrateExpiredJobs()</code> æ£€æŸ¥åˆ°æœŸä»»åŠ¡</td></tr><tr><td>Ready é˜Ÿåˆ—</td><td>Job åˆ°æ—¶é—´åè¢«ç§»å…¥è¿™ä¸ªé˜Ÿåˆ—ï¼Œç­‰å¾…æ‰§è¡Œ</td></tr></tbody></table><ul><li>Worker æ˜¯ <strong>å•ä¸ªå¸¸é©»è¿›ç¨‹</strong>ï¼ŒåŒæ—¶åš <strong>è°ƒåº¦</strong> å’Œ <strong>æ¶ˆè´¹</strong></li><li>æ‰€ä»¥å³ä½¿å»¶è¿Ÿä»»åŠ¡å¾ˆå¤šï¼Œä¹Ÿä¸éœ€è¦é¢å¤–çš„ Cronï¼ŒWorker è‡ªå·±å°±èƒ½å¤„ç†</li></ul><p>âœ… æ€»ç»“</p><ul><li><strong>Worker = æ¶ˆè´¹è€… + å»¶è¿Ÿä»»åŠ¡æ¬è¿è€…</strong></li><li>å»¶è¿Ÿä»»åŠ¡é€»è¾‘æ˜¯ Worker å†…éƒ¨å¾ªç¯çš„ä¸€éƒ¨åˆ†</li><li>ä½ å¯ä»¥é€šè¿‡å¯åŠ¨å¤šä¸ª Worker æˆ–æŒ‡å®šé˜Ÿåˆ—ï¼Œçµæ´»ç®¡ç†æ¶ˆè´¹ç­–ç•¥</li></ul><p>âœ… æ€»ç»“ï¼š</p><ol><li>Job ç±»è¦ <code>implements ShouldQueue</code></li><li>Dispatch æ—¶è°ƒç”¨ <code>-&gt;delay(now()-&gt;addMinutes(...))</code></li><li>å¯é€‰ <code>onQueue()</code> æŒ‡å®šé˜Ÿåˆ—</li><li>Worker ä¼šè‡ªåŠ¨å¤„ç†å»¶è¿Ÿé€»è¾‘</li></ol><p>å‚è€ƒæ–‡æ¡£: https://laravel.com/docs/12.x/queues#delayed-dispatching</p><hr><h5 id="å…³äº-å¤šä¸ªä¸åŒçš„queue-name-çš„ä½¿ç”¨ä»¥åŠæ¶ˆè´¹" tabindex="-1"><a class="header-anchor" href="#å…³äº-å¤šä¸ªä¸åŒçš„queue-name-çš„ä½¿ç”¨ä»¥åŠæ¶ˆè´¹"><span>å…³äº å¤šä¸ªä¸åŒçš„queue name çš„ä½¿ç”¨ä»¥åŠæ¶ˆè´¹</span></a></h5><h5 id="_1-å¤šé˜Ÿåˆ—å…±äº«ä¸€ä¸ª-redis-è¿æ¥" tabindex="-1"><a class="header-anchor" href="#_1-å¤šé˜Ÿåˆ—å…±äº«ä¸€ä¸ª-redis-è¿æ¥"><span>1. å¤šé˜Ÿåˆ—å…±äº«ä¸€ä¸ª Redis è¿æ¥</span></a></h5><ul><li><p><code>connection</code> å†³å®šçš„æ˜¯ <strong>Redis å®ä¾‹/æ•°æ®åº“</strong></p></li><li><p><code>queue name</code> å†³å®šçš„æ˜¯ <strong>é€»è¾‘é˜Ÿåˆ—åˆ†ç»„</strong></p></li><li><p>æ‰€ä»¥ä½ å¯ä»¥åœ¨åŒä¸€ä¸ª Redis é‡Œï¼Œæœ‰å¤šä¸ªé€»è¾‘é˜Ÿåˆ—ï¼š</p><ul><li><code>default</code></li><li><code>emails</code></li><li><code>notifications</code></li></ul></li></ul><h5 id="_2-worker-æ¶ˆè´¹æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#_2-worker-æ¶ˆè´¹æ–¹å¼"><span>2. Worker æ¶ˆè´¹æ–¹å¼</span></a></h5><h5 id="a-æ¶ˆè´¹æ‰€æœ‰é˜Ÿåˆ—" tabindex="-1"><a class="header-anchor" href="#a-æ¶ˆè´¹æ‰€æœ‰é˜Ÿåˆ—"><span>(a) æ¶ˆè´¹æ‰€æœ‰é˜Ÿåˆ—</span></a></h5><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">php artisan queue:work redis</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>ä¸æŒ‡å®š <code>--queue</code> â†’ é»˜è®¤ä¼šæ¶ˆè´¹ <code>default</code> é˜Ÿåˆ—</li><li>å¦‚æœæƒ³æ¶ˆè´¹å¤šä¸ªé˜Ÿåˆ—ï¼Œå¯ä»¥ï¼š</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">php artisan queue:work redis <span class="token parameter variable">--queue</span><span class="token operator">=</span>default,emails,notifications</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>Worker ä¼šæŒ‰é¡ºåºè½®è¯¢è¿™äº›é˜Ÿåˆ—çš„ä»»åŠ¡</li></ul><h5 id="b-ä¸ºç‰¹å®šé˜Ÿåˆ—æŒ‡å®š-supervisor" tabindex="-1"><a class="header-anchor" href="#b-ä¸ºç‰¹å®šé˜Ÿåˆ—æŒ‡å®š-supervisor"><span>(b) ä¸ºç‰¹å®šé˜Ÿåˆ—æŒ‡å®š Supervisor</span></a></h5><ul><li>å‡è®¾ä½ åªæƒ³æ¶ˆè´¹ <code>emails</code> é˜Ÿåˆ—ï¼š</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">php artisan queue:work redis <span class="token parameter variable">--queue</span><span class="token operator">=</span>emails</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>ç„¶åé…ç½® Supervisor ç®¡ç†è¿™ä¸ª workerï¼š</li></ul><div class="language-ini line-numbers-mode" data-highlighter="prismjs" data-ext="ini" data-title="ini"><pre><code><span class="line"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">program:laravel-emails</span><span class="token punctuation">]</span></span></span>
<span class="line"><span class="token key attr-name">command</span><span class="token punctuation">=</span><span class="token value attr-value">php /var/www/html/artisan queue:work redis --queue=emails --sleep=3 --tries=3</span></span>
<span class="line"><span class="token key attr-name">process_name</span><span class="token punctuation">=</span><span class="token value attr-value">%(program_name)s_%(process_num)02d</span></span>
<span class="line"><span class="token key attr-name">numprocs</span><span class="token punctuation">=</span><span class="token value attr-value">1</span></span>
<span class="line"><span class="token key attr-name">autostart</span><span class="token punctuation">=</span><span class="token value attr-value">true</span></span>
<span class="line"><span class="token key attr-name">autorestart</span><span class="token punctuation">=</span><span class="token value attr-value">true</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è¿™æ ·å°±ä¸“é—¨ä¸º <code>emails</code> é˜Ÿåˆ—å•ç‹¬ç®¡ç† workerï¼Œé¿å…å…¶ä»–é˜Ÿåˆ—ä»»åŠ¡å½±å“å®ƒçš„æ¶ˆè´¹é€Ÿåº¦</li></ul><h5 id="_3-æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#_3-æ€»ç»“"><span>3. æ€»ç»“</span></a></h5><table><thead><tr><th>æ¦‚å¿µ</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>connection</td><td>Redis å®ä¾‹/é˜Ÿåˆ—é©±åŠ¨ï¼Œåº•å±‚å­˜å‚¨</td></tr><tr><td>queue name</td><td>é€»è¾‘é˜Ÿåˆ—åˆ†ç»„ï¼Œç”¨äºåŒºåˆ†ä¸åŒä»»åŠ¡ç±»å‹</td></tr><tr><td>Worker ä¸æŒ‡å®šé˜Ÿåˆ—</td><td>é»˜è®¤æ¶ˆè´¹é»˜è®¤é˜Ÿåˆ—ï¼Œä¹Ÿå¯é€šè¿‡ <code>--queue=a,b,c</code> è½®è¯¢å¤šä¸ªé˜Ÿåˆ—</td></tr><tr><td>Worker æŒ‡å®šé˜Ÿåˆ—</td><td>å¯ä»¥ä¸“é—¨æ¶ˆè´¹æŸä¸ªé˜Ÿåˆ—ï¼Œç”¨ Supervisor å•ç‹¬ç®¡ç†æ€§èƒ½/èµ„æº</td></tr></tbody></table><p>ç®€å•ç†è§£ï¼š</p><ul><li><strong>connection = Redis åå°ä»“åº“</strong></li><li><strong>queue name = Redis ä»“åº“é‡Œçš„ä¸åŒæŠ½å±‰</strong></li><li><strong>Worker = æ‰“å¼€æŠ½å±‰å–ä»»åŠ¡çš„äºº</strong></li></ul><p>è¿™æ ·ä½ å°±å¯ä»¥çµæ´»åœ°æŒ‰ä¸šåŠ¡æ‹†åˆ†é˜Ÿåˆ—ã€å•ç‹¬ç®¡ç†èµ„æºã€‚</p><hr><h5 id="å…³äºredisçš„blpop" tabindex="-1"><a class="header-anchor" href="#å…³äºredisçš„blpop"><span>å…³äºredisçš„BLPOP</span></a></h5><p><code>BLPOP</code> çš„åå­—å°±æ˜¯ <strong>Blocking Left POP</strong>ï¼š</p><ul><li><strong>L = Left</strong> ğŸ‘‰ ä»åˆ—è¡¨ï¼ˆlistï¼‰çš„å·¦è¾¹ï¼ˆå¤´éƒ¨ï¼‰å–æ•°æ®</li><li><strong>POP</strong> ğŸ‘‰ å–å‡ºå¹¶åˆ é™¤è¯¥å…ƒç´ </li></ul><h3 id="ä¸¾ä¾‹" tabindex="-1"><a class="header-anchor" href="#ä¸¾ä¾‹"><span>ä¸¾ä¾‹ï¼š</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">LPUSH myqueue <span class="token string">&quot;task1&quot;</span></span>
<span class="line">LPUSH myqueue <span class="token string">&quot;task2&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨é˜Ÿåˆ—å†…å®¹æ˜¯ï¼ˆå·¦è¾¹æ˜¯å¤´éƒ¨ï¼‰ï¼š</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">[&quot;task2&quot;, &quot;task1&quot;]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>æ‰§è¡Œï¼š</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">BLPOP myqueue <span class="token number">0</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>è¿”å›ï¼š</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">1) &quot;myqueue&quot;</span>
<span class="line">2) &quot;task2&quot;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>é˜Ÿåˆ—å˜ä¸ºï¼š</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">[&quot;task1&quot;]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>å†æ‰§è¡Œä¸€æ¬¡ï¼š</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">1) &quot;myqueue&quot;</span>
<span class="line">2) &quot;task1&quot;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>é˜Ÿåˆ—å˜ç©ºã€‚</p><h5 id="å¯¹æ¯”å‘½ä»¤" tabindex="-1"><a class="header-anchor" href="#å¯¹æ¯”å‘½ä»¤"><span>å¯¹æ¯”å‘½ä»¤ï¼š</span></a></h5><ul><li><code>BLPOP</code> â†’ ä»å·¦è¾¹å–</li><li><code>BRPOP</code> â†’ ä»å³è¾¹å–</li></ul><hr><h5 id="queue-work-ä¼šå¯åŠ¨ä¸€ä¸ªå¸¸é©»-php-è¿›ç¨‹-è¿™ä¸ªå’Œphp-fpmæœ‰å…³å—" tabindex="-1"><a class="header-anchor" href="#queue-work-ä¼šå¯åŠ¨ä¸€ä¸ªå¸¸é©»-php-è¿›ç¨‹-è¿™ä¸ªå’Œphp-fpmæœ‰å…³å—"><span>queue:work ä¼šå¯åŠ¨ä¸€ä¸ªå¸¸é©» PHP è¿›ç¨‹ è¿™ä¸ªå’Œphp-fpmæœ‰å…³å—</span></a></h5><h5 id="_1-php-artisan-queue-work" tabindex="-1"><a class="header-anchor" href="#_1-php-artisan-queue-work"><span>1. <code>php artisan queue:work</code></span></a></h5><ul><li>å¯åŠ¨çš„æ˜¯ä¸€ä¸ª <strong>å¸¸é©»çš„ PHP CLI è¿›ç¨‹</strong>ã€‚</li><li>å®ƒç›´æ¥è·‘åœ¨å‘½ä»¤è¡Œï¼ˆ<code>php</code> äºŒè¿›åˆ¶ï¼‰é‡Œï¼Œä¸ä¾èµ– Nginx/Apacheã€‚</li><li>åŸç†æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼šä¸æ–­ç”¨ <code>BLPOP</code> ä» Redis æ‹‰ä»»åŠ¡ï¼Œç„¶åæ‰§è¡Œ Job çš„ <code>handle()</code>ã€‚</li><li>ä½ å¯ä»¥ç”¨ <code>ps -ef | grep queue:work</code> çœ‹åˆ°å®ƒå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ <code>php</code> è¿›ç¨‹ã€‚</li></ul><h5 id="_2-php-fpm" tabindex="-1"><a class="header-anchor" href="#_2-php-fpm"><span>2. <code>php-fpm</code></span></a></h5><ul><li><code>php-fpm</code>ï¼ˆFastCGI Process Managerï¼‰æ˜¯ <strong>Web è¯·æ±‚çš„ PHP è¿›ç¨‹æ± </strong>ï¼Œé€šå¸¸ç”± Nginx/Apache è°ƒç”¨ã€‚</li><li>ç”¨æ¥å¤„ç† <strong>HTTP è¯·æ±‚</strong>ï¼ˆæ¯”å¦‚ä½ è®¿é—®ä¸€ä¸ª Laravel é¡µé¢ï¼ŒNginx è½¬å‘ç»™ php-fpmï¼‰ã€‚</li><li><code>php-fpm</code> çš„è¿›ç¨‹æ˜¯çŸ­ç”Ÿå‘½å‘¨æœŸçš„ï¼šä¸€ä¸ªè¯·æ±‚ â†’ æ‰§è¡Œ â†’ è¿”å› â†’ ç­‰å¾…ä¸‹ä¸€ä¸ªè¯·æ±‚ã€‚</li></ul><h5 id="_3-ä¸¤è€…çš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#_3-ä¸¤è€…çš„åŒºåˆ«"><span>3. ä¸¤è€…çš„åŒºåˆ«</span></a></h5><table><thead><tr><th>ç‰¹æ€§</th><th><code>queue:work</code></th><th><code>php-fpm</code></th></tr></thead><tbody><tr><td>å¯åŠ¨æ–¹å¼</td><td>å‘½ä»¤è¡Œ <code>php artisan queue:work</code></td><td>ç³»ç»ŸæœåŠ¡ï¼ˆ<code>php-fpm</code>ï¼‰</td></tr><tr><td>ç”Ÿå‘½å‘¨æœŸ</td><td>å¸¸é©»è¿›ç¨‹ï¼ˆæ­»å¾ªç¯ï¼‰</td><td>çŸ­è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ</td></tr><tr><td>è§¦å‘æ¥æº</td><td>Redis é˜Ÿåˆ—ä»»åŠ¡</td><td>Nginx/Apache å‘æ¥çš„ HTTP è¯·æ±‚</td></tr><tr><td>åœºæ™¯</td><td>å¼‚æ­¥ä»»åŠ¡æ¶ˆè´¹ï¼ˆå‘é‚®ä»¶ã€å¯¼å‡ºã€é€šçŸ¥ç­‰ï¼‰</td><td>Web é¡µé¢è¯·æ±‚å¤„ç†</td></tr></tbody></table><h5 id="_4-æœ‰æ²¡æœ‰å…³ç³»" tabindex="-1"><a class="header-anchor" href="#_4-æœ‰æ²¡æœ‰å…³ç³»"><span>4. æœ‰æ²¡æœ‰å…³ç³»ï¼Ÿ</span></a></h5><ul><li><strong>è¿è¡Œç¯å¢ƒ</strong>ï¼šå®ƒä»¬éƒ½ç”¨åŒä¸€ä¸ª PHP è§£é‡Šå™¨ï¼ˆ<code>php</code> äºŒè¿›åˆ¶ + PHP æ‰©å±•ï¼‰ã€‚</li><li><strong>è¿›ç¨‹ç‹¬ç«‹</strong>ï¼š<code>queue:work</code> è·Ÿ <code>php-fpm</code> æ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œå®ƒä»¬äº’ä¸å¹²æ‰°ã€‚</li><li><strong>é—´æ¥è”ç³»</strong>ï¼šWeb è¯·æ±‚ï¼ˆphp-fpm æ‰§è¡Œï¼‰é‡Œ <code>dispatch()</code> äº†ä¸€ä¸ª Job â†’ Job è¢«æ¨åˆ° Redis â†’ <code>queue:work</code> æ¶ˆè´¹å¹¶æ‰§è¡Œã€‚</li></ul><p>æ‰€ä»¥å¯ä»¥ç†è§£ä¸ºï¼š</p><ul><li><strong>php-fpm è´Ÿè´£è¯·æ±‚å…¥å£</strong></li><li><strong>queue:work è´Ÿè´£åå°å¼‚æ­¥ä»»åŠ¡</strong> å®ƒä»¬æ˜¯é…å¥—è€Œä¸æ˜¯ç›¸äº’ä¾èµ–çš„ã€‚</li></ul><p>âœ… æ€»ç»“ï¼š <code>queue:work</code> å¯åŠ¨çš„å¸¸é©» PHP è¿›ç¨‹ <strong>å’Œ php-fpm æ²¡å…³ç³»</strong>ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ PHP CLI workerã€‚ å”¯ä¸€çš„è”ç³»æ˜¯ï¼šWeb è¯·æ±‚ï¼ˆphp-fpmï¼‰å¯èƒ½ä¼šäº§ç”Ÿä»»åŠ¡ï¼Œäº¤ç»™ <code>queue:work</code> å»å¤„ç†ã€‚</p><hr><h5 id="php-cli-å’Œ-php-fpm-åœ¨å½“å‰php-dockerç¯å¢ƒä¸‹çš„å¯¹æ¯”" tabindex="-1"><a class="header-anchor" href="#php-cli-å’Œ-php-fpm-åœ¨å½“å‰php-dockerç¯å¢ƒä¸‹çš„å¯¹æ¯”"><span>php cli å’Œ php fpm åœ¨å½“å‰php dockerç¯å¢ƒä¸‹çš„å¯¹æ¯”</span></a></h5><p>æœ¬è´¨ä¸Šè¿™ä¸¤ä¸ªéƒ½æ˜¯ php çš„ SAPI(Server API)</p><h5 id="php-v-i" tabindex="-1"><a class="header-anchor" href="#php-v-i"><span>$ php -v / -i</span></a></h5><p>PHP 8.3.0alpha1 (cli) (built: Jun 13 2023 11:11:54) (NTS) Copyright (c) The PHP Group Zend Engine v4.3.0-dev, Copyright (c) Zend Technologies</p><p>å®Œç¾ âœ…</p><p>è¿™ä¸ªè¾“å‡ºè¯´æ˜ä½ çš„ <strong>PHP CLI</strong> å·²ç»å¯ç”¨ï¼š</p><ol><li><code>(cli)</code> â†’ å‘Šè¯‰ä½ è¿™æ˜¯ <strong>å‘½ä»¤è¡Œæ¥å£ï¼ˆCLIï¼‰ç‰ˆæœ¬</strong></li><li><code>(NTS)</code> â†’ è¡¨ç¤º <strong>éçº¿ç¨‹å®‰å…¨ï¼ˆNon Thread Safeï¼‰</strong></li><li>ç‰ˆæœ¬ä¿¡æ¯å’Œ Zend Engine éƒ½æ­£å¸¸æ˜¾ç¤º</li></ol><p>ç»“åˆä½ ä¹‹å‰çš„ <code>php-fpm -v</code> è¾“å‡ºï¼š</p><table><thead><tr><th>ç»„ä»¶</th><th>çŠ¶æ€</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>php-cli</td><td>å·²å®‰è£…</td><td>å‘½ä»¤è¡Œè¿è¡Œ Artisan å‘½ä»¤ã€é˜Ÿåˆ— Workerã€Cron ç­‰</td></tr><tr><td>php-fpm</td><td>å·²å®‰è£…</td><td>Web è¯·æ±‚å¤„ç†ï¼ˆé€šè¿‡ Nginx/Apacheï¼‰</td></tr></tbody></table><h5 id="âœ…-æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#âœ…-æ€»ç»“"><span>âœ… æ€»ç»“ï¼š</span></a></h5><ul><li><p>ä½ çš„ç³»ç»Ÿç¯å¢ƒ <strong>å®Œå…¨å¯ä»¥</strong>ï¼š</p><ul><li>è¿è¡Œ <code>php artisan queue:work</code>ï¼ˆä¾èµ– CLIï¼‰</li><li>å¤„ç† HTTP è¯·æ±‚ï¼ˆä¾èµ– php-fpmï¼‰</li></ul></li><li><p>ä¸¤è€…æ˜¯ç‹¬ç«‹çš„ï¼Œäº’ä¸å½±å“ï¼Œä½†å¯ä»¥é…åˆä½¿ç”¨ï¼šWeb è¯·æ±‚äº§ç”Ÿä»»åŠ¡ â†’ CLI Worker å¼‚æ­¥æ‰§è¡Œ</p></li></ul><h5 id="php-fpm-v-i" tabindex="-1"><a class="header-anchor" href="#php-fpm-v-i"><span>$ php-fpm -v / -i</span></a></h5><p>PHP 8.3.0alpha1 (fpm-fcgi) (built: Jun 13 2023 11:11:57) Copyright (c) The PHP Group Zend Engine v4.3.0-dev, Copyright (c) Zend Technologies</p><p>å®Œç¾ âœ…</p><p>ä½ çš„è¾“å‡ºè¯´æ˜äº†å‡ ä»¶äº‹ï¼š</p><ol><li><p><strong>PHP-FPM å·²å®‰è£…</strong></p><ul><li><code>(fpm-fcgi)</code> æ˜ç¡®æ ‡è¯†è¿™æ˜¯ <strong>FastCGI Process Manager</strong> ç‰ˆæœ¬</li><li>å¯ä»¥è¢« Nginx/Apache ç”¨æ¥å¤„ç† Web è¯·æ±‚</li></ul></li><li><p><strong>PHP ç‰ˆæœ¬</strong></p><ul><li>ä½ å®‰è£…çš„æ˜¯ <strong>PHP 8.3.0 alpha1</strong>ï¼Œå±äºå¼€å‘ç‰ˆ/æµ‹è¯•ç‰ˆ</li><li>æ³¨æ„ç”Ÿäº§ç¯å¢ƒæœ€å¥½ç”¨ç¨³å®šç‰ˆæœ¬</li></ul></li><li><p><strong>Zend Engine ç‰ˆæœ¬</strong></p><ul><li>ç”¨äºè§£é‡Šæ‰§è¡Œ PHP ä»£ç çš„æ ¸å¿ƒå¼•æ“ä¿¡æ¯</li></ul></li></ol><p>æ‰€ä»¥ç»“è®ºï¼š</p><ul><li><strong>php-fpm å¯ç”¨</strong> â†’ å¯ä»¥å¤„ç† Web è¯·æ±‚</li><li><strong>php-cli ä¾ç„¶ç‹¬ç«‹</strong>ï¼Œä½ çš„ <code>php -v</code> è¾“å‡º CLI ä¿¡æ¯çš„è¯ï¼Œä¹Ÿèƒ½è·‘å‘½ä»¤è¡Œè„šæœ¬å’Œ <code>queue:work</code></li></ul><p>ç®€å•ç†è§£ï¼š</p><ul><li><strong>php-fpm</strong> â†’ Web è¯·æ±‚å…¥å£</li><li><strong>php-cli</strong> â†’ å‘½ä»¤è¡Œè„šæœ¬ã€é˜Ÿåˆ— Workerã€Cron</li></ul><h5 id="æŸ¥çœ‹ä¸åŒserver-api-åŠ è½½çš„æ¨¡å—" tabindex="-1"><a class="header-anchor" href="#æŸ¥çœ‹ä¸åŒserver-api-åŠ è½½çš„æ¨¡å—"><span>æŸ¥çœ‹ä¸åŒServer API åŠ è½½çš„æ¨¡å—</span></a></h5><p>$ php -m</p><p>$ php-fpm -m</p><p>è¿™ä¸¤ä¸ªå‘½ä»¤è¾“å‡ºçš„å†…å®¹æ˜¯ä¸€æ ·çš„ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼ŒæŒ‰é“ç†è®²è¿™æ˜¯ä¸¤ä¸ªä¸åŒçš„SAPIç¯å¢ƒï¼Œä¸ºä»€ä¹ˆä¼šä¸€æ ·å‘¢?</p><h5 id="_1-docker-é•œåƒé‡Œçš„-php-ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_1-docker-é•œåƒé‡Œçš„-php-ç»“æ„"><span>1. Docker é•œåƒé‡Œçš„ PHP ç»“æ„</span></a></h5><ul><li>å¤§å¤šæ•°å®˜æ–¹ PHP é•œåƒï¼ˆå¦‚ <code>php:8.3-fpm</code> æˆ– <code>php:8.3-cli</code>ï¼‰æœ¬èº«åŒ…å« <strong>ç›¸åŒçš„æ ¸å¿ƒå’Œæ‰©å±•ç›®å½•</strong></li><li>Docker å®‰è£…æ‰©å±•ï¼ˆ<code>docker-php-ext-install</code> æˆ– <code>pecl install</code>ï¼‰ä¼šæŠŠæ‰©å±•ç»Ÿä¸€å®‰è£…åˆ° <strong>PHP çš„ extension_dir</strong> ä¸‹</li><li>æ— è®ºä½ æ˜¯ CLI è¿˜æ˜¯ FPMï¼Œéƒ½å…±äº«åŒä¸€å¥—æ‰©å±•è·¯å¾„</li></ul><h5 id="_2-sapi-ç‹¬ç«‹-ä½†æ‰©å±•å…±äº«" tabindex="-1"><a class="header-anchor" href="#_2-sapi-ç‹¬ç«‹-ä½†æ‰©å±•å…±äº«"><span>2. SAPI ç‹¬ç«‹ï¼Œä½†æ‰©å±•å…±äº«</span></a></h5><ul><li><strong>SAPI</strong>ï¼šCLI å’Œ FPM æ˜¯ä¸åŒçš„æ¥å£ï¼Œè¡Œä¸ºä¸åŒ</li><li><strong>æ‰©å±•</strong>ï¼šå®‰è£…åœ¨åŒä¸€ç›®å½• â†’ éƒ½èƒ½è¢«åŠ è½½</li><li>æ‰€ä»¥å³ä¾¿ FPM å’Œ CLI å„è‡ªæœ‰è‡ªå·±çš„ <code>php.ini</code>ï¼Œåªè¦éƒ½å¯ç”¨ç›¸åŒæ‰©å±•ï¼Œå°±ä¼šçœ‹åˆ°å‡ ä¹ä¸€æ ·çš„ <code>php -m</code> / <code>php-fpm -m</code></li></ul><h5 id="_3-å®é™…æ•ˆæœ" tabindex="-1"><a class="header-anchor" href="#_3-å®é™…æ•ˆæœ"><span>3. å®é™…æ•ˆæœ</span></a></h5><ul><li>CLI â†’ å¯ä»¥è·‘ <code>artisan queue:work</code>ã€Cronã€å‘½ä»¤è¡Œè„šæœ¬</li><li>FPM â†’ å¤„ç† Web è¯·æ±‚</li><li>éƒ½èƒ½ç”¨ Redisã€PDOã€curl ç­‰æ‰©å±•</li><li>å¼€å‘æ—¶ä¸å¿…æ‹…å¿ƒæ‰©å±•ç¼ºå¤±</li></ul><p>âœ… æ€»ç»“ï¼š</p><ul><li><strong>Docker å®‰è£…çš„ PHP æ‰©å±•é»˜è®¤å¯¹ CLI å’Œ FPM éƒ½å¯ç”¨</strong></li><li>CLI / FPM çš„è¡Œä¸ºå’Œé…ç½®ä»ç„¶ç‹¬ç«‹ï¼Œåªæ˜¯æ‰©å±•å…±äº«</li><li>æ‰€ä»¥çœ‹åˆ° <code>php -m</code> å’Œ <code>php-fpm -m</code> è¾“å‡ºä¸€è‡´æ˜¯æ­£å¸¸ç°è±¡</li></ul>`,160)]))}const c=n(p,[["render",l],["__file","laravel12ä¸‹åŸºäºredisçš„æ¶ˆæ¯é˜Ÿåˆ—åŸç†å›é¡¾.html.vue"]]),r=JSON.parse('{"path":"/content/php/laravel/laravel12%E4%B8%8B%E5%9F%BA%E4%BA%8Eredis%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%8E%9F%E7%90%86%E5%9B%9E%E9%A1%BE.html","title":"laravel12ä¸‹åŸºäºredisçš„æ¶ˆæ¯é˜Ÿåˆ—åŸç†å›é¡¾","lang":"en-US","frontmatter":{"sidebar":false,"title":"laravel12ä¸‹åŸºäºredisçš„æ¶ˆæ¯é˜Ÿåˆ—åŸç†å›é¡¾","head":[["meta",{"name":"title","content":"laravel12ä¸‹åŸºäºredisçš„æ¶ˆæ¯é˜Ÿåˆ—åŸç†å›é¡¾"}],["meta",{"name":"description","content":"laravel12ä¸‹åŸºäºredisçš„æ¶ˆæ¯é˜Ÿåˆ—åŸç†å›é¡¾"}],["meta",{"name":"keywords","content":"laravel,php"}],["meta",{"property":"og:title","content":"laravel12ä¸‹åŸºäºredisçš„æ¶ˆæ¯é˜Ÿåˆ—åŸç†å›é¡¾"}],["meta",{"property":"og:description","content":"laravel12ä¸‹åŸºäºredisçš„æ¶ˆæ¯é˜Ÿåˆ—åŸç†å›é¡¾"}]]},"headers":[{"level":3,"title":"1. é»˜è®¤é…ç½®ç¤ºä¾‹","slug":"_1-é»˜è®¤é…ç½®ç¤ºä¾‹","link":"#_1-é»˜è®¤é…ç½®ç¤ºä¾‹","children":[]},{"level":3,"title":"ä¸¾ä¾‹ï¼š","slug":"ä¸¾ä¾‹","link":"#ä¸¾ä¾‹","children":[]}],"git":{},"filePathRelative":"content/php/laravel/laravel12ä¸‹åŸºäºredisçš„æ¶ˆæ¯é˜Ÿåˆ—åŸç†å›é¡¾.md"}');export{c as comp,r as data};
