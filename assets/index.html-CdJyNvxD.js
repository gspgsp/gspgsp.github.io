import{_ as l,c as i,a as n,f as c,o as t,r as a}from"./app-BB_BIQV8.js";const o={};function d(r,s){const e=a("DocSearchInPage"),p=a("InArticleAd");return t(),i("div",null,[n(e),n(p),s[0]||(s[0]=c(`<h1 id="postgresql-使用手册" tabindex="-1"><a class="header-anchor" href="#postgresql-使用手册"><span>PostgreSQL 使用手册</span></a></h1><h2 id="简介" tabindex="-1"><a class="header-anchor" href="#简介"><span>简介</span></a></h2><p>PostgreSQL是一个功能强大的开源对象关系型数据库管理系统(ORDBMS),以其稳定性、数据完整性和正确性而闻名。PostgreSQL支持大部分SQL标准,并提供了许多现代特性,如复杂查询、外键、触发器、视图、事务完整性和多版本并发控制。</p><h3 id="主要特点" tabindex="-1"><a class="header-anchor" href="#主要特点"><span>主要特点</span></a></h3><ul><li>完全遵循ACID特性</li><li>支持复杂的SQL查询</li><li>强大的扩展性</li><li>支持JSON和JSONB数据类型</li><li>丰富的索引类型(B-tree, Hash, GiST, SP-GiST, GIN, BRIN)</li><li>支持全文搜索</li><li>支持地理空间数据(PostGIS扩展)</li></ul><hr><h2 id="安装与配置" tabindex="-1"><a class="header-anchor" href="#安装与配置"><span>安装与配置</span></a></h2><h3 id="ubuntu-debian系统安装" tabindex="-1"><a class="header-anchor" href="#ubuntu-debian系统安装"><span>Ubuntu/Debian系统安装</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 更新包列表</span></span>
<span class="line"><span class="token function">sudo</span> <span class="token function">apt</span> update</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 安装PostgreSQL</span></span>
<span class="line"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> postgresql postgresql-contrib</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检查PostgreSQL服务状态</span></span>
<span class="line"><span class="token function">sudo</span> systemctl status postgresql</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 启动PostgreSQL服务</span></span>
<span class="line"><span class="token function">sudo</span> systemctl start postgresql</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 设置开机自启动</span></span>
<span class="line"><span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> postgresql</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="macos安装" tabindex="-1"><a class="header-anchor" href="#macos安装"><span>macOS安装</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 使用Homebrew安装</span></span>
<span class="line">brew <span class="token function">install</span> postgresql@16</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 启动服务</span></span>
<span class="line">brew services start postgresql@16</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="windows安装" tabindex="-1"><a class="header-anchor" href="#windows安装"><span>Windows安装</span></a></h3><p>从官方网站下载安装程序: https://www.postgresql.org/download/windows/</p><h3 id="基础配置" tabindex="-1"><a class="header-anchor" href="#基础配置"><span>基础配置</span></a></h3><p>PostgreSQL主要配置文件位置:</p><ul><li><code>postgresql.conf</code> - 主配置文件</li><li><code>pg_hba.conf</code> - 客户端认证配置文件</li></ul><p>常用配置参数:</p><div class="language-conf line-numbers-mode" data-highlighter="prismjs" data-ext="conf" data-title="conf"><pre><code><span class="line"># postgresql.conf 示例</span>
<span class="line">listen_addresses = &#39;localhost&#39;          # 监听地址</span>
<span class="line">port = 5432                              # 端口号</span>
<span class="line">max_connections = 100                    # 最大连接数</span>
<span class="line">shared_buffers = 128MB                   # 共享缓冲区大小</span>
<span class="line">effective_cache_size = 4GB              # 有效缓存大小</span>
<span class="line">work_mem = 4MB                          # 工作内存</span>
<span class="line">maintenance_work_mem = 64MB             # 维护工作内存</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="基础操作" tabindex="-1"><a class="header-anchor" href="#基础操作"><span>基础操作</span></a></h2><h3 id="连接数据库" tabindex="-1"><a class="header-anchor" href="#连接数据库"><span>连接数据库</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 切换到postgres用户</span></span>
<span class="line"><span class="token function">sudo</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-u</span> postgres</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 进入PostgreSQL命令行</span></span>
<span class="line">psql</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 直接连接指定数据库</span></span>
<span class="line">psql <span class="token parameter variable">-U</span> username <span class="token parameter variable">-d</span> database_name <span class="token parameter variable">-h</span> <span class="token function">hostname</span> <span class="token parameter variable">-p</span> port</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="常用psql命令" tabindex="-1"><a class="header-anchor" href="#常用psql命令"><span>常用psql命令</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 列出所有数据库</span></span>
<span class="line">\\l 或 \\list</span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 连接到指定数据库</span></span>
<span class="line">\\c database_name 或 \\<span class="token keyword">connect</span> database_name</span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 列出当前数据库的所有表</span></span>
<span class="line">\\dt</span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 查看表结构</span></span>
<span class="line">\\d table_name</span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 列出所有用户</span></span>
<span class="line">\\du</span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 列出所有模式</span></span>
<span class="line">\\dn</span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 查看当前数据库</span></span>
<span class="line"><span class="token keyword">SELECT</span> current_database<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 退出psql</span></span>
<span class="line">\\q</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="数据库操作" tabindex="-1"><a class="header-anchor" href="#数据库操作"><span>数据库操作</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 创建数据库</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> mydatabase<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 创建数据库并指定所有者</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> mydatabase OWNER myuser<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 删除数据库</span></span>
<span class="line"><span class="token keyword">DROP</span> <span class="token keyword">DATABASE</span> mydatabase<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 重命名数据库</span></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> oldname <span class="token keyword">RENAME</span> <span class="token keyword">TO</span> newname<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="数据类型" tabindex="-1"><a class="header-anchor" href="#数据类型"><span>数据类型</span></a></h2><h3 id="数值类型" tabindex="-1"><a class="header-anchor" href="#数值类型"><span>数值类型</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 整数类型</span></span>
<span class="line"><span class="token keyword">SMALLINT</span>        <span class="token comment">-- 2字节, -32768 到 32767</span></span>
<span class="line"><span class="token keyword">INTEGER</span> 或 <span class="token keyword">INT</span>  <span class="token comment">-- 4字节, -2147483648 到 2147483647</span></span>
<span class="line"><span class="token keyword">BIGINT</span>          <span class="token comment">-- 8字节, -9223372036854775808 到 9223372036854775807</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 浮点数类型</span></span>
<span class="line"><span class="token keyword">REAL</span>            <span class="token comment">-- 4字节, 6位十进制精度</span></span>
<span class="line"><span class="token keyword">DOUBLE</span> <span class="token keyword">PRECISION</span> <span class="token comment">-- 8字节, 15位十进制精度</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 精确数值类型</span></span>
<span class="line"><span class="token keyword">NUMERIC</span><span class="token punctuation">(</span><span class="token keyword">precision</span><span class="token punctuation">,</span> scale<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token keyword">precision</span><span class="token punctuation">,</span> scale<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 自增类型</span></span>
<span class="line"><span class="token keyword">SERIAL</span>          <span class="token comment">-- 自增整数</span></span>
<span class="line">BIGSERIAL       <span class="token comment">-- 自增大整数</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="字符类型" tabindex="-1"><a class="header-anchor" href="#字符类型"><span>字符类型</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CHAR</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>         <span class="token comment">-- 定长字符串</span></span>
<span class="line"><span class="token keyword">VARCHAR</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>      <span class="token comment">-- 变长字符串,最大n个字符</span></span>
<span class="line"><span class="token keyword">TEXT</span>            <span class="token comment">-- 无限长度文本</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="日期时间类型" tabindex="-1"><a class="header-anchor" href="#日期时间类型"><span>日期时间类型</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">DATE</span>            <span class="token comment">-- 日期(年月日)</span></span>
<span class="line"><span class="token keyword">TIME</span>            <span class="token comment">-- 时间(时分秒)</span></span>
<span class="line"><span class="token keyword">TIMESTAMP</span>       <span class="token comment">-- 日期和时间</span></span>
<span class="line">TIMESTAMPTZ     <span class="token comment">-- 带时区的时间戳</span></span>
<span class="line"><span class="token keyword">INTERVAL</span>        <span class="token comment">-- 时间间隔</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="布尔类型" tabindex="-1"><a class="header-anchor" href="#布尔类型"><span>布尔类型</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">BOOLEAN</span>         <span class="token comment">-- TRUE, FALSE, NULL</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="json类型" tabindex="-1"><a class="header-anchor" href="#json类型"><span>JSON类型</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line">JSON            <span class="token comment">-- JSON文本格式</span></span>
<span class="line">JSONB           <span class="token comment">-- JSON二进制格式(推荐,支持索引)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="数组类型" tabindex="-1"><a class="header-anchor" href="#数组类型"><span>数组类型</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">INTEGER</span><span class="token punctuation">[</span><span class="token punctuation">]</span>       <span class="token comment">-- 整数数组</span></span>
<span class="line"><span class="token keyword">TEXT</span><span class="token punctuation">[</span><span class="token punctuation">]</span>          <span class="token comment">-- 文本数组</span></span>
<span class="line"><span class="token comment">-- 示例</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> products <span class="token punctuation">(</span></span>
<span class="line">    id <span class="token keyword">SERIAL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span></span>
<span class="line">    tags <span class="token keyword">TEXT</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> products <span class="token punctuation">(</span>tags<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>ARRAY<span class="token punctuation">[</span><span class="token string">&#39;electronics&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;computer&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="sql语句" tabindex="-1"><a class="header-anchor" href="#sql语句"><span>SQL语句</span></a></h2><h3 id="创建表" tabindex="-1"><a class="header-anchor" href="#创建表"><span>创建表</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 基础表创建</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> users <span class="token punctuation">(</span></span>
<span class="line">    id <span class="token keyword">SERIAL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span></span>
<span class="line">    username <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    email <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    password <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span></span>
<span class="line">    updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 带外键的表</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> posts <span class="token punctuation">(</span></span>
<span class="line">    id <span class="token keyword">SERIAL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span></span>
<span class="line">    user_id <span class="token keyword">INTEGER</span> <span class="token keyword">REFERENCES</span> users<span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">CASCADE</span><span class="token punctuation">,</span></span>
<span class="line">    title <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    content <span class="token keyword">TEXT</span><span class="token punctuation">,</span></span>
<span class="line">    published <span class="token keyword">BOOLEAN</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">FALSE</span><span class="token punctuation">,</span></span>
<span class="line">    created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 带检查约束的表</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> products <span class="token punctuation">(</span></span>
<span class="line">    id <span class="token keyword">SERIAL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span></span>
<span class="line">    name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    price <span class="token keyword">NUMERIC</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">CHECK</span> <span class="token punctuation">(</span>price <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    stock <span class="token keyword">INTEGER</span> <span class="token keyword">CHECK</span> <span class="token punctuation">(</span>stock <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="插入数据" tabindex="-1"><a class="header-anchor" href="#插入数据"><span>插入数据</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 单行插入</span></span>
<span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> users <span class="token punctuation">(</span>username<span class="token punctuation">,</span> email<span class="token punctuation">,</span> password<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;john_doe&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;john@example.com&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;hashed_password&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 多行插入</span></span>
<span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> users <span class="token punctuation">(</span>username<span class="token punctuation">,</span> email<span class="token punctuation">,</span> password<span class="token punctuation">)</span> <span class="token keyword">VALUES</span></span>
<span class="line">    <span class="token punctuation">(</span><span class="token string">&#39;alice&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;alice@example.com&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;pass1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">(</span><span class="token string">&#39;bob&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;bob@example.com&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;pass2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">(</span><span class="token string">&#39;charlie&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;charlie@example.com&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;pass3&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 插入并返回结果</span></span>
<span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> users <span class="token punctuation">(</span>username<span class="token punctuation">,</span> email<span class="token punctuation">,</span> password<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;david&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;david@example.com&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;pass4&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">RETURNING</span> id<span class="token punctuation">,</span> username<span class="token punctuation">,</span> created_at<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="查询数据" tabindex="-1"><a class="header-anchor" href="#查询数据"><span>查询数据</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 基础查询</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 条件查询</span></span>
<span class="line"><span class="token keyword">SELECT</span> username<span class="token punctuation">,</span> email <span class="token keyword">FROM</span> users <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 排序</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> created_at <span class="token keyword">DESC</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 限制结果数量</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users <span class="token keyword">LIMIT</span> <span class="token number">10</span> <span class="token keyword">OFFSET</span> <span class="token number">20</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 聚合函数</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> users<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">FROM</span> products<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token function">MAX</span><span class="token punctuation">(</span>created_at<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">MIN</span><span class="token punctuation">(</span>created_at<span class="token punctuation">)</span> <span class="token keyword">FROM</span> posts<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 分组查询</span></span>
<span class="line"><span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> post_count</span>
<span class="line"><span class="token keyword">FROM</span> posts</span>
<span class="line"><span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id</span>
<span class="line"><span class="token keyword">HAVING</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 连接查询</span></span>
<span class="line"><span class="token keyword">SELECT</span> u<span class="token punctuation">.</span>username<span class="token punctuation">,</span> p<span class="token punctuation">.</span>title<span class="token punctuation">,</span> p<span class="token punctuation">.</span>created_at</span>
<span class="line"><span class="token keyword">FROM</span> users u</span>
<span class="line"><span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> posts p <span class="token keyword">ON</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> p<span class="token punctuation">.</span>user_id</span>
<span class="line"><span class="token keyword">WHERE</span> u<span class="token punctuation">.</span>username <span class="token operator">=</span> <span class="token string">&#39;john_doe&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 左连接</span></span>
<span class="line"><span class="token keyword">SELECT</span> u<span class="token punctuation">.</span>username<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token keyword">as</span> post_count</span>
<span class="line"><span class="token keyword">FROM</span> users u</span>
<span class="line"><span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> posts p <span class="token keyword">ON</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> p<span class="token punctuation">.</span>user_id</span>
<span class="line"><span class="token keyword">GROUP</span> <span class="token keyword">BY</span> u<span class="token punctuation">.</span>id<span class="token punctuation">,</span> u<span class="token punctuation">.</span>username<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 子查询</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users</span>
<span class="line"><span class="token keyword">WHERE</span> id <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> user_id <span class="token keyword">FROM</span> posts <span class="token keyword">WHERE</span> published <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="更新数据" tabindex="-1"><a class="header-anchor" href="#更新数据"><span>更新数据</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 基础更新</span></span>
<span class="line"><span class="token keyword">UPDATE</span> users <span class="token keyword">SET</span> email <span class="token operator">=</span> <span class="token string">&#39;newemail@example.com&#39;</span> <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 更新多个字段</span></span>
<span class="line"><span class="token keyword">UPDATE</span> users</span>
<span class="line"><span class="token keyword">SET</span> email <span class="token operator">=</span> <span class="token string">&#39;updated@example.com&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    updated_at <span class="token operator">=</span> <span class="token keyword">CURRENT_TIMESTAMP</span></span>
<span class="line"><span class="token keyword">WHERE</span> username <span class="token operator">=</span> <span class="token string">&#39;john_doe&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 条件更新</span></span>
<span class="line"><span class="token keyword">UPDATE</span> products</span>
<span class="line"><span class="token keyword">SET</span> price <span class="token operator">=</span> price <span class="token operator">*</span> <span class="token number">1.1</span></span>
<span class="line"><span class="token keyword">WHERE</span> stock <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 更新并返回</span></span>
<span class="line"><span class="token keyword">UPDATE</span> users</span>
<span class="line"><span class="token keyword">SET</span> email <span class="token operator">=</span> <span class="token string">&#39;final@example.com&#39;</span></span>
<span class="line"><span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span></span>
<span class="line"><span class="token keyword">RETURNING</span> <span class="token operator">*</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="删除数据" tabindex="-1"><a class="header-anchor" href="#删除数据"><span>删除数据</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 删除特定记录</span></span>
<span class="line"><span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> users <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 条件删除</span></span>
<span class="line"><span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> posts <span class="token keyword">WHERE</span> created_at <span class="token operator">&lt;</span> <span class="token string">&#39;2023-01-01&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 删除并返回</span></span>
<span class="line"><span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> users <span class="token keyword">WHERE</span> username <span class="token operator">=</span> <span class="token string">&#39;temp_user&#39;</span> <span class="token keyword">RETURNING</span> <span class="token operator">*</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 清空表(保留表结构)</span></span>
<span class="line"><span class="token keyword">TRUNCATE</span> <span class="token keyword">TABLE</span> posts<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 级联删除相关数据</span></span>
<span class="line"><span class="token keyword">TRUNCATE</span> <span class="token keyword">TABLE</span> users <span class="token keyword">CASCADE</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="索引与性能优化" tabindex="-1"><a class="header-anchor" href="#索引与性能优化"><span>索引与性能优化</span></a></h2><h3 id="创建索引" tabindex="-1"><a class="header-anchor" href="#创建索引"><span>创建索引</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 普通索引</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_users_email <span class="token keyword">ON</span> users<span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 唯一索引</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> idx_users_username <span class="token keyword">ON</span> users<span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 复合索引</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_posts_user_created <span class="token keyword">ON</span> posts<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> created_at<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 部分索引</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_published_posts <span class="token keyword">ON</span> posts<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">WHERE</span> published <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- B-tree索引(默认)</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_products_price <span class="token keyword">ON</span> products<span class="token punctuation">(</span>price<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- Hash索引</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_users_id_hash <span class="token keyword">ON</span> users <span class="token keyword">USING</span> <span class="token keyword">HASH</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- GIN索引(适用于数组、JSONB、全文搜索)</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_products_tags <span class="token keyword">ON</span> products <span class="token keyword">USING</span> GIN<span class="token punctuation">(</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- GiST索引(适用于地理数据、范围类型)</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_events_daterange <span class="token keyword">ON</span> events <span class="token keyword">USING</span> GIST<span class="token punctuation">(</span>date_range<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="查看和管理索引" tabindex="-1"><a class="header-anchor" href="#查看和管理索引"><span>查看和管理索引</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 查看表的所有索引</span></span>
<span class="line">\\di table_name</span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 查看索引定义</span></span>
<span class="line">\\d<span class="token operator">+</span> index_name</span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 删除索引</span></span>
<span class="line"><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_users_email<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 重建索引</span></span>
<span class="line">REINDEX <span class="token keyword">INDEX</span> idx_users_email<span class="token punctuation">;</span></span>
<span class="line">REINDEX <span class="token keyword">TABLE</span> users<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="查询优化" tabindex="-1"><a class="header-anchor" href="#查询优化"><span>查询优化</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 查看查询执行计划</span></span>
<span class="line"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users <span class="token keyword">WHERE</span> email <span class="token operator">=</span> <span class="token string">&#39;test@example.com&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 查看详细执行计划和实际执行时间</span></span>
<span class="line"><span class="token keyword">EXPLAIN</span> <span class="token keyword">ANALYZE</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users <span class="token keyword">WHERE</span> email <span class="token operator">=</span> <span class="token string">&#39;test@example.com&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 使用EXPLAIN分析JOIN查询</span></span>
<span class="line"><span class="token keyword">EXPLAIN</span> <span class="token keyword">ANALYZE</span></span>
<span class="line"><span class="token keyword">SELECT</span> u<span class="token punctuation">.</span>username<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">FROM</span> users u</span>
<span class="line"><span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> posts p <span class="token keyword">ON</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> p<span class="token punctuation">.</span>user_id</span>
<span class="line"><span class="token keyword">GROUP</span> <span class="token keyword">BY</span> u<span class="token punctuation">.</span>id<span class="token punctuation">,</span> u<span class="token punctuation">.</span>username<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="性能优化技巧" tabindex="-1"><a class="header-anchor" href="#性能优化技巧"><span>性能优化技巧</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 使用VACUUM清理死元组</span></span>
<span class="line">VACUUM users<span class="token punctuation">;</span></span>
<span class="line">VACUUM <span class="token keyword">ANALYZE</span> users<span class="token punctuation">;</span>  <span class="token comment">-- 同时更新统计信息</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 分析表以更新统计信息</span></span>
<span class="line"><span class="token keyword">ANALYZE</span> users<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 自动清理配置(postgresql.conf)</span></span>
<span class="line"><span class="token comment">-- autovacuum = on</span></span>
<span class="line"><span class="token comment">-- autovacuum_naptime = 1min</span></span>
<span class="line"><span class="token comment">-- autovacuum_vacuum_threshold = 50</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="事务管理" tabindex="-1"><a class="header-anchor" href="#事务管理"><span>事务管理</span></a></h2><h3 id="基础事务" tabindex="-1"><a class="header-anchor" href="#基础事务"><span>基础事务</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 开始事务</span></span>
<span class="line"><span class="token keyword">BEGIN</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 执行操作</span></span>
<span class="line"><span class="token keyword">UPDATE</span> accounts <span class="token keyword">SET</span> balance <span class="token operator">=</span> balance <span class="token operator">-</span> <span class="token number">100</span> <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">UPDATE</span> accounts <span class="token keyword">SET</span> balance <span class="token operator">=</span> balance <span class="token operator">+</span> <span class="token number">100</span> <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 提交事务</span></span>
<span class="line"><span class="token keyword">COMMIT</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 回滚事务</span></span>
<span class="line"><span class="token comment">-- ROLLBACK;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="保存点" tabindex="-1"><a class="header-anchor" href="#保存点"><span>保存点</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">BEGIN</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> users <span class="token punctuation">(</span>username<span class="token punctuation">,</span> email<span class="token punctuation">,</span> password<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;test1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;test1@example.com&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;pass1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">SAVEPOINT</span> sp1<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> users <span class="token punctuation">(</span>username<span class="token punctuation">,</span> email<span class="token punctuation">,</span> password<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;test2&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;test2@example.com&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;pass2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 回滚到保存点</span></span>
<span class="line"><span class="token keyword">ROLLBACK</span> <span class="token keyword">TO</span> <span class="token keyword">SAVEPOINT</span> sp1<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">COMMIT</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="事务隔离级别" tabindex="-1"><a class="header-anchor" href="#事务隔离级别"><span>事务隔离级别</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 读未提交(PostgreSQL不支持,会自动升级到读已提交)</span></span>
<span class="line"><span class="token keyword">BEGIN</span> <span class="token keyword">TRANSACTION</span> <span class="token keyword">ISOLATION</span> <span class="token keyword">LEVEL</span> <span class="token keyword">READ</span> <span class="token keyword">UNCOMMITTED</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 读已提交(默认)</span></span>
<span class="line"><span class="token keyword">BEGIN</span> <span class="token keyword">TRANSACTION</span> <span class="token keyword">ISOLATION</span> <span class="token keyword">LEVEL</span> <span class="token keyword">READ</span> <span class="token keyword">COMMITTED</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 可重复读</span></span>
<span class="line"><span class="token keyword">BEGIN</span> <span class="token keyword">TRANSACTION</span> <span class="token keyword">ISOLATION</span> <span class="token keyword">LEVEL</span> <span class="token keyword">REPEATABLE</span> <span class="token keyword">READ</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 串行化</span></span>
<span class="line"><span class="token keyword">BEGIN</span> <span class="token keyword">TRANSACTION</span> <span class="token keyword">ISOLATION</span> <span class="token keyword">LEVEL</span> <span class="token keyword">SERIALIZABLE</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 示例</span></span>
<span class="line"><span class="token keyword">BEGIN</span> <span class="token keyword">TRANSACTION</span> <span class="token keyword">ISOLATION</span> <span class="token keyword">LEVEL</span> <span class="token keyword">REPEATABLE</span> <span class="token keyword">READ</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> accounts <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">-- 其他操作</span></span>
<span class="line"><span class="token keyword">COMMIT</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="用户与权限管理" tabindex="-1"><a class="header-anchor" href="#用户与权限管理"><span>用户与权限管理</span></a></h2><h3 id="用户管理" tabindex="-1"><a class="header-anchor" href="#用户管理"><span>用户管理</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 创建用户</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> myuser <span class="token keyword">WITH</span> PASSWORD <span class="token string">&#39;mypassword&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 创建超级用户</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> admin <span class="token keyword">WITH</span> SUPERUSER PASSWORD <span class="token string">&#39;adminpass&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 创建用户并设置多个属性</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> appuser <span class="token keyword">WITH</span></span>
<span class="line">    PASSWORD <span class="token string">&#39;securepass&#39;</span></span>
<span class="line">    CREATEDB</span>
<span class="line">    CREATEROLE</span>
<span class="line">    VALID UNTIL <span class="token string">&#39;2025-12-31&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 修改用户密码</span></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">USER</span> myuser <span class="token keyword">WITH</span> PASSWORD <span class="token string">&#39;newpassword&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 删除用户</span></span>
<span class="line"><span class="token keyword">DROP</span> <span class="token keyword">USER</span> myuser<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 重命名用户</span></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">USER</span> oldname <span class="token keyword">RENAME</span> <span class="token keyword">TO</span> newname<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="角色管理" tabindex="-1"><a class="header-anchor" href="#角色管理"><span>角色管理</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 创建角色</span></span>
<span class="line"><span class="token keyword">CREATE</span> ROLE readonly<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 创建可登录的角色</span></span>
<span class="line"><span class="token keyword">CREATE</span> ROLE developer <span class="token keyword">WITH</span> LOGIN PASSWORD <span class="token string">&#39;devpass&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 将用户添加到角色</span></span>
<span class="line"><span class="token keyword">GRANT</span> readonly <span class="token keyword">TO</span> myuser<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 从角色移除用户</span></span>
<span class="line"><span class="token keyword">REVOKE</span> readonly <span class="token keyword">FROM</span> myuser<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="权限管理" tabindex="-1"><a class="header-anchor" href="#权限管理"><span>权限管理</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 授予数据库权限</span></span>
<span class="line"><span class="token keyword">GRANT</span> <span class="token keyword">CONNECT</span> <span class="token keyword">ON</span> <span class="token keyword">DATABASE</span> mydatabase <span class="token keyword">TO</span> myuser<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 授予表的所有权限</span></span>
<span class="line"><span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span> <span class="token keyword">ON</span> <span class="token keyword">TABLE</span> users <span class="token keyword">TO</span> myuser<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 授予表的特定权限</span></span>
<span class="line"><span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span><span class="token punctuation">,</span> <span class="token keyword">INSERT</span><span class="token punctuation">,</span> <span class="token keyword">UPDATE</span> <span class="token keyword">ON</span> <span class="token keyword">TABLE</span> posts <span class="token keyword">TO</span> myuser<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 授予模式权限</span></span>
<span class="line"><span class="token keyword">GRANT</span> <span class="token keyword">USAGE</span> <span class="token keyword">ON</span> <span class="token keyword">SCHEMA</span> <span class="token keyword">public</span> <span class="token keyword">TO</span> myuser<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 授予序列权限</span></span>
<span class="line"><span class="token keyword">GRANT</span> <span class="token keyword">USAGE</span><span class="token punctuation">,</span> <span class="token keyword">SELECT</span> <span class="token keyword">ON</span> <span class="token keyword">ALL</span> SEQUENCES <span class="token operator">IN</span> <span class="token keyword">SCHEMA</span> <span class="token keyword">public</span> <span class="token keyword">TO</span> myuser<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 授予执行函数的权限</span></span>
<span class="line"><span class="token keyword">GRANT</span> <span class="token keyword">EXECUTE</span> <span class="token keyword">ON</span> <span class="token keyword">FUNCTION</span> my_function<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">TO</span> myuser<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 撤销权限</span></span>
<span class="line"><span class="token keyword">REVOKE</span> <span class="token keyword">INSERT</span> <span class="token keyword">ON</span> <span class="token keyword">TABLE</span> users <span class="token keyword">FROM</span> myuser<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 设置默认权限</span></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">PRIVILEGES</span> <span class="token operator">IN</span> <span class="token keyword">SCHEMA</span> <span class="token keyword">public</span></span>
<span class="line"><span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span> <span class="token keyword">ON</span> <span class="token keyword">TABLES</span> <span class="token keyword">TO</span> readonly<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 查看权限</span></span>
<span class="line">\\dp table_name</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="备份与恢复" tabindex="-1"><a class="header-anchor" href="#备份与恢复"><span>备份与恢复</span></a></h2><h3 id="使用pg-dump备份" tabindex="-1"><a class="header-anchor" href="#使用pg-dump备份"><span>使用pg_dump备份</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 备份单个数据库</span></span>
<span class="line">pg_dump <span class="token parameter variable">-U</span> postgres <span class="token parameter variable">-d</span> mydatabase <span class="token parameter variable">-f</span> backup.sql</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 备份为自定义格式(推荐,支持并行恢复)</span></span>
<span class="line">pg_dump <span class="token parameter variable">-U</span> postgres <span class="token parameter variable">-d</span> mydatabase <span class="token parameter variable">-F</span> c <span class="token parameter variable">-f</span> backup.dump</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 备份为目录格式(支持并行备份和恢复)</span></span>
<span class="line">pg_dump <span class="token parameter variable">-U</span> postgres <span class="token parameter variable">-d</span> mydatabase <span class="token parameter variable">-F</span> d <span class="token parameter variable">-j</span> <span class="token number">4</span> <span class="token parameter variable">-f</span> backup_dir</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 只备份结构(不含数据)</span></span>
<span class="line">pg_dump <span class="token parameter variable">-U</span> postgres <span class="token parameter variable">-d</span> mydatabase --schema-only <span class="token parameter variable">-f</span> schema.sql</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 只备份数据</span></span>
<span class="line">pg_dump <span class="token parameter variable">-U</span> postgres <span class="token parameter variable">-d</span> mydatabase --data-only <span class="token parameter variable">-f</span> data.sql</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 备份特定表</span></span>
<span class="line">pg_dump <span class="token parameter variable">-U</span> postgres <span class="token parameter variable">-d</span> mydatabase <span class="token parameter variable">-t</span> <span class="token function">users</span> <span class="token parameter variable">-t</span> posts <span class="token parameter variable">-f</span> tables.sql</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 压缩备份</span></span>
<span class="line">pg_dump <span class="token parameter variable">-U</span> postgres <span class="token parameter variable">-d</span> mydatabase <span class="token operator">|</span> <span class="token function">gzip</span> <span class="token operator">&gt;</span> backup.sql.gz</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="使用pg-dumpall备份" tabindex="-1"><a class="header-anchor" href="#使用pg-dumpall备份"><span>使用pg_dumpall备份</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 备份所有数据库</span></span>
<span class="line">pg_dumpall <span class="token parameter variable">-U</span> postgres <span class="token parameter variable">-f</span> all_databases.sql</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 只备份全局对象(角色和表空间)</span></span>
<span class="line">pg_dumpall <span class="token parameter variable">-U</span> postgres --globals-only <span class="token parameter variable">-f</span> globals.sql</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="恢复数据" tabindex="-1"><a class="header-anchor" href="#恢复数据"><span>恢复数据</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 从SQL文件恢复</span></span>
<span class="line">psql <span class="token parameter variable">-U</span> postgres <span class="token parameter variable">-d</span> mydatabase <span class="token parameter variable">-f</span> backup.sql</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 从自定义格式恢复</span></span>
<span class="line">pg_restore <span class="token parameter variable">-U</span> postgres <span class="token parameter variable">-d</span> mydatabase backup.dump</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 并行恢复</span></span>
<span class="line">pg_restore <span class="token parameter variable">-U</span> postgres <span class="token parameter variable">-d</span> mydatabase <span class="token parameter variable">-j</span> <span class="token number">4</span> backup.dump</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 从目录格式恢复</span></span>
<span class="line">pg_restore <span class="token parameter variable">-U</span> postgres <span class="token parameter variable">-d</span> mydatabase <span class="token parameter variable">-j</span> <span class="token number">4</span> backup_dir</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 恢复特定表</span></span>
<span class="line">pg_restore <span class="token parameter variable">-U</span> postgres <span class="token parameter variable">-d</span> mydatabase <span class="token parameter variable">-t</span> <span class="token function">users</span> backup.dump</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 从压缩文件恢复</span></span>
<span class="line">gunzip <span class="token parameter variable">-c</span> backup.sql.gz <span class="token operator">|</span> psql <span class="token parameter variable">-U</span> postgres <span class="token parameter variable">-d</span> mydatabase</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="连续归档和时间点恢复-pitr" tabindex="-1"><a class="header-anchor" href="#连续归档和时间点恢复-pitr"><span>连续归档和时间点恢复(PITR)</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 配置postgresql.conf</span></span>
<span class="line"><span class="token comment">-- wal_level = replica</span></span>
<span class="line"><span class="token comment">-- archive_mode = on</span></span>
<span class="line"><span class="token comment">-- archive_command = &#39;cp %p /path/to/archive/%f&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 创建基础备份</span></span>
<span class="line"><span class="token keyword">SELECT</span> pg_start_backup<span class="token punctuation">(</span><span class="token string">&#39;label&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">-- 复制数据目录</span></span>
<span class="line"><span class="token keyword">SELECT</span> pg_stop_backup<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 恢复到特定时间点</span></span>
<span class="line"><span class="token comment">-- 在recovery.conf中配置</span></span>
<span class="line"><span class="token comment">-- restore_command = &#39;cp /path/to/archive/%f %p&#39;</span></span>
<span class="line"><span class="token comment">-- recovery_target_time = &#39;2024-01-15 12:00:00&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="高级特性" tabindex="-1"><a class="header-anchor" href="#高级特性"><span>高级特性</span></a></h2><h3 id="视图" tabindex="-1"><a class="header-anchor" href="#视图"><span>视图</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 创建视图</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> user_posts <span class="token keyword">AS</span></span>
<span class="line"><span class="token keyword">SELECT</span> u<span class="token punctuation">.</span>username<span class="token punctuation">,</span> u<span class="token punctuation">.</span>email<span class="token punctuation">,</span> p<span class="token punctuation">.</span>title<span class="token punctuation">,</span> p<span class="token punctuation">.</span>created_at</span>
<span class="line"><span class="token keyword">FROM</span> users u</span>
<span class="line"><span class="token keyword">JOIN</span> posts p <span class="token keyword">ON</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> p<span class="token punctuation">.</span>user_id</span>
<span class="line"><span class="token keyword">WHERE</span> p<span class="token punctuation">.</span>published <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 使用视图</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> user_posts <span class="token keyword">WHERE</span> username <span class="token operator">=</span> <span class="token string">&#39;john_doe&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 物化视图(缓存查询结果)</span></span>
<span class="line"><span class="token keyword">CREATE</span> MATERIALIZED <span class="token keyword">VIEW</span> popular_posts <span class="token keyword">AS</span></span>
<span class="line"><span class="token keyword">SELECT</span> p<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token keyword">as</span> like_count</span>
<span class="line"><span class="token keyword">FROM</span> posts p</span>
<span class="line"><span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> likes l <span class="token keyword">ON</span> p<span class="token punctuation">.</span>id <span class="token operator">=</span> l<span class="token punctuation">.</span>post_id</span>
<span class="line"><span class="token keyword">GROUP</span> <span class="token keyword">BY</span> p<span class="token punctuation">.</span>id</span>
<span class="line"><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> like_count <span class="token keyword">DESC</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 刷新物化视图</span></span>
<span class="line">REFRESH MATERIALIZED <span class="token keyword">VIEW</span> popular_posts<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 删除视图</span></span>
<span class="line"><span class="token keyword">DROP</span> <span class="token keyword">VIEW</span> user_posts<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">DROP</span> MATERIALIZED <span class="token keyword">VIEW</span> popular_posts<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="触发器" tabindex="-1"><a class="header-anchor" href="#触发器"><span>触发器</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 创建触发器函数</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">FUNCTION</span> update_updated_at<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">RETURNS</span> <span class="token keyword">TRIGGER</span> <span class="token keyword">AS</span> $$</span>
<span class="line"><span class="token keyword">BEGIN</span></span>
<span class="line">    NEW<span class="token punctuation">.</span>updated_at <span class="token operator">=</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">RETURN</span> NEW<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">END</span><span class="token punctuation">;</span></span>
<span class="line">$$ <span class="token keyword">LANGUAGE</span> plpgsql<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 创建触发器</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> users_update_trigger</span>
<span class="line">BEFORE <span class="token keyword">UPDATE</span> <span class="token keyword">ON</span> users</span>
<span class="line"><span class="token keyword">FOR EACH ROW</span></span>
<span class="line"><span class="token keyword">EXECUTE</span> <span class="token keyword">FUNCTION</span> update_updated_at<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 删除触发器</span></span>
<span class="line"><span class="token keyword">DROP</span> <span class="token keyword">TRIGGER</span> users_update_trigger <span class="token keyword">ON</span> users<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="存储过程和函数" tabindex="-1"><a class="header-anchor" href="#存储过程和函数"><span>存储过程和函数</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 创建函数</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">FUNCTION</span> get_user_post_count<span class="token punctuation">(</span>user_id_param <span class="token keyword">INTEGER</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">RETURNS</span> <span class="token keyword">INTEGER</span> <span class="token keyword">AS</span> $$</span>
<span class="line"><span class="token keyword">DECLARE</span></span>
<span class="line">    post_count <span class="token keyword">INTEGER</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">BEGIN</span></span>
<span class="line">    <span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">INTO</span> post_count</span>
<span class="line">    <span class="token keyword">FROM</span> posts</span>
<span class="line">    <span class="token keyword">WHERE</span> user_id <span class="token operator">=</span> user_id_param<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">RETURN</span> post_count<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">END</span><span class="token punctuation">;</span></span>
<span class="line">$$ <span class="token keyword">LANGUAGE</span> plpgsql<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 调用函数</span></span>
<span class="line"><span class="token keyword">SELECT</span> get_user_post_count<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 创建存储过程(PostgreSQL 11+)</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">PROCEDURE</span> transfer_funds<span class="token punctuation">(</span></span>
<span class="line">    sender_id <span class="token keyword">INTEGER</span><span class="token punctuation">,</span></span>
<span class="line">    receiver_id <span class="token keyword">INTEGER</span><span class="token punctuation">,</span></span>
<span class="line">    amount <span class="token keyword">NUMERIC</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">LANGUAGE</span> plpgsql</span>
<span class="line"><span class="token keyword">AS</span> $$</span>
<span class="line"><span class="token keyword">BEGIN</span></span>
<span class="line">    <span class="token keyword">UPDATE</span> accounts <span class="token keyword">SET</span> balance <span class="token operator">=</span> balance <span class="token operator">-</span> amount <span class="token keyword">WHERE</span> id <span class="token operator">=</span> sender_id<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">UPDATE</span> accounts <span class="token keyword">SET</span> balance <span class="token operator">=</span> balance <span class="token operator">+</span> amount <span class="token keyword">WHERE</span> id <span class="token operator">=</span> receiver_id<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">COMMIT</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">END</span><span class="token punctuation">;</span></span>
<span class="line">$$<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 调用存储过程</span></span>
<span class="line"><span class="token keyword">CALL</span> transfer_funds<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">100.00</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="json操作" tabindex="-1"><a class="header-anchor" href="#json操作"><span>JSON操作</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 创建包含JSON的表</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> orders <span class="token punctuation">(</span></span>
<span class="line">    id <span class="token keyword">SERIAL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span></span>
<span class="line">    customer_data JSONB</span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 插入JSON数据</span></span>
<span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> orders <span class="token punctuation">(</span>customer_data<span class="token punctuation">)</span> <span class="token keyword">VALUES</span></span>
<span class="line"><span class="token punctuation">(</span><span class="token string">&#39;{&quot;name&quot;: &quot;John&quot;, &quot;age&quot;: 30, &quot;items&quot;: [&quot;book&quot;, &quot;pen&quot;]}&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 查询JSON字段</span></span>
<span class="line"><span class="token keyword">SELECT</span> customer_data<span class="token operator">-</span><span class="token operator">&gt;&gt;</span><span class="token string">&#39;name&#39;</span> <span class="token keyword">as</span> customer_name <span class="token keyword">FROM</span> orders<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 查询JSON数组元素</span></span>
<span class="line"><span class="token keyword">SELECT</span> customer_data<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token string">&#39;items&#39;</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">as</span> first_item <span class="token keyword">FROM</span> orders<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- JSON条件查询</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> orders <span class="token keyword">WHERE</span> customer_data<span class="token operator">-</span><span class="token operator">&gt;&gt;</span><span class="token string">&#39;age&#39;</span> <span class="token operator">=</span> <span class="token string">&#39;30&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 查询JSON数组包含特定值</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> orders <span class="token keyword">WHERE</span> customer_data<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token string">&#39;items&#39;</span> ? <span class="token string">&#39;book&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 更新JSON字段</span></span>
<span class="line"><span class="token keyword">UPDATE</span> orders</span>
<span class="line"><span class="token keyword">SET</span> customer_data <span class="token operator">=</span> jsonb_set<span class="token punctuation">(</span>customer_data<span class="token punctuation">,</span> <span class="token string">&#39;{age}&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;31&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 在JSONB上创建索引</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_orders_customer <span class="token keyword">ON</span> orders <span class="token keyword">USING</span> GIN<span class="token punctuation">(</span>customer_data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="全文搜索" tabindex="-1"><a class="header-anchor" href="#全文搜索"><span>全文搜索</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 创建全文搜索列</span></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> posts <span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> search_vector tsvector<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 更新搜索向量</span></span>
<span class="line"><span class="token keyword">UPDATE</span> posts</span>
<span class="line"><span class="token keyword">SET</span> search_vector <span class="token operator">=</span> to_tsvector<span class="token punctuation">(</span><span class="token string">&#39;english&#39;</span><span class="token punctuation">,</span> title <span class="token operator">||</span> <span class="token string">&#39; &#39;</span> <span class="token operator">||</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 创建GIN索引</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_posts_search <span class="token keyword">ON</span> posts <span class="token keyword">USING</span> GIN<span class="token punctuation">(</span>search_vector<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 全文搜索查询</span></span>
<span class="line"><span class="token keyword">SELECT</span> title<span class="token punctuation">,</span> content</span>
<span class="line"><span class="token keyword">FROM</span> posts</span>
<span class="line"><span class="token keyword">WHERE</span> search_vector @@ to_tsquery<span class="token punctuation">(</span><span class="token string">&#39;english&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;postgresql &amp; database&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 按相关性排序</span></span>
<span class="line"><span class="token keyword">SELECT</span> title<span class="token punctuation">,</span> ts_rank<span class="token punctuation">(</span>search_vector<span class="token punctuation">,</span> query<span class="token punctuation">)</span> <span class="token keyword">as</span> rank</span>
<span class="line"><span class="token keyword">FROM</span> posts<span class="token punctuation">,</span> to_tsquery<span class="token punctuation">(</span><span class="token string">&#39;english&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;postgresql &amp; database&#39;</span><span class="token punctuation">)</span> query</span>
<span class="line"><span class="token keyword">WHERE</span> search_vector @@ query</span>
<span class="line"><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> rank <span class="token keyword">DESC</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="分区表" tabindex="-1"><a class="header-anchor" href="#分区表"><span>分区表</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 创建分区表(范围分区)</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> measurements <span class="token punctuation">(</span></span>
<span class="line">    id <span class="token keyword">SERIAL</span><span class="token punctuation">,</span></span>
<span class="line">    log_date <span class="token keyword">DATE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">value</span> <span class="token keyword">NUMERIC</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> RANGE <span class="token punctuation">(</span>log_date<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 创建分区</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> measurements_2024_01 <span class="token keyword">PARTITION</span> <span class="token keyword">OF</span> measurements</span>
<span class="line"><span class="token keyword">FOR</span> <span class="token keyword">VALUES</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token string">&#39;2024-01-01&#39;</span><span class="token punctuation">)</span> <span class="token keyword">TO</span> <span class="token punctuation">(</span><span class="token string">&#39;2024-02-01&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> measurements_2024_02 <span class="token keyword">PARTITION</span> <span class="token keyword">OF</span> measurements</span>
<span class="line"><span class="token keyword">FOR</span> <span class="token keyword">VALUES</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token string">&#39;2024-02-01&#39;</span><span class="token punctuation">)</span> <span class="token keyword">TO</span> <span class="token punctuation">(</span><span class="token string">&#39;2024-03-01&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 插入数据会自动路由到对应分区</span></span>
<span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> measurements <span class="token punctuation">(</span>log_date<span class="token punctuation">,</span> <span class="token keyword">value</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;2024-01-15&#39;</span><span class="token punctuation">,</span> <span class="token number">42.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="窗口函数" tabindex="-1"><a class="header-anchor" href="#窗口函数"><span>窗口函数</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- ROW_NUMBER</span></span>
<span class="line"><span class="token keyword">SELECT</span> username<span class="token punctuation">,</span> created_at<span class="token punctuation">,</span></span>
<span class="line">       ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> created_at<span class="token punctuation">)</span> <span class="token keyword">as</span> row_num</span>
<span class="line"><span class="token keyword">FROM</span> users<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- RANK</span></span>
<span class="line"><span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span> score<span class="token punctuation">,</span></span>
<span class="line">       RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> score <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rank</span>
<span class="line"><span class="token keyword">FROM</span> game_scores<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 分组窗口函数</span></span>
<span class="line"><span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span> post_id<span class="token punctuation">,</span> created_at<span class="token punctuation">,</span></span>
<span class="line">       ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> user_id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> created_at<span class="token punctuation">)</span> <span class="token keyword">as</span> post_number</span>
<span class="line"><span class="token keyword">FROM</span> posts<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 滑动窗口聚合</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token keyword">date</span><span class="token punctuation">,</span> sales<span class="token punctuation">,</span></span>
<span class="line">       <span class="token function">AVG</span><span class="token punctuation">(</span>sales<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">date</span> <span class="token keyword">ROWS</span> <span class="token operator">BETWEEN</span> <span class="token number">6</span> <span class="token keyword">PRECEDING</span> <span class="token operator">AND</span> <span class="token keyword">CURRENT</span> <span class="token keyword">ROW</span><span class="token punctuation">)</span> <span class="token keyword">as</span> moving_avg</span>
<span class="line"><span class="token keyword">FROM</span> daily_sales<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="cte-公共表表达式" tabindex="-1"><a class="header-anchor" href="#cte-公共表表达式"><span>CTE(公共表表达式)</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 基础CTE</span></span>
<span class="line"><span class="token keyword">WITH</span> recent_users <span class="token keyword">AS</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users</span>
<span class="line">    <span class="token keyword">WHERE</span> created_at <span class="token operator">&gt;</span> <span class="token keyword">CURRENT_DATE</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token string">&#39;30 days&#39;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> recent_users</span>
<span class="line"><span class="token keyword">WHERE</span> email <span class="token operator">LIKE</span> <span class="token string">&#39;%@example.com&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 递归CTE</span></span>
<span class="line"><span class="token keyword">WITH</span> RECURSIVE category_tree <span class="token keyword">AS</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token comment">-- 基础查询</span></span>
<span class="line">    <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> parent_id<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">as</span> <span class="token keyword">level</span></span>
<span class="line">    <span class="token keyword">FROM</span> categories</span>
<span class="line">    <span class="token keyword">WHERE</span> parent_id <span class="token operator">IS</span> <span class="token boolean">NULL</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">UNION</span> <span class="token keyword">ALL</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">-- 递归查询</span></span>
<span class="line">    <span class="token keyword">SELECT</span> c<span class="token punctuation">.</span>id<span class="token punctuation">,</span> c<span class="token punctuation">.</span>name<span class="token punctuation">,</span> c<span class="token punctuation">.</span>parent_id<span class="token punctuation">,</span> ct<span class="token punctuation">.</span><span class="token keyword">level</span> <span class="token operator">+</span> <span class="token number">1</span></span>
<span class="line">    <span class="token keyword">FROM</span> categories c</span>
<span class="line">    <span class="token keyword">JOIN</span> category_tree ct <span class="token keyword">ON</span> c<span class="token punctuation">.</span>parent_id <span class="token operator">=</span> ct<span class="token punctuation">.</span>id</span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> category_tree <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">level</span><span class="token punctuation">,</span> name<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="常用维护命令" tabindex="-1"><a class="header-anchor" href="#常用维护命令"><span>常用维护命令</span></a></h2><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 查看数据库大小</span></span>
<span class="line"><span class="token keyword">SELECT</span> pg_size_pretty<span class="token punctuation">(</span>pg_database_size<span class="token punctuation">(</span><span class="token string">&#39;mydatabase&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 查看表大小</span></span>
<span class="line"><span class="token keyword">SELECT</span> pg_size_pretty<span class="token punctuation">(</span>pg_total_relation_size<span class="token punctuation">(</span><span class="token string">&#39;users&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 查看所有表的大小</span></span>
<span class="line"><span class="token keyword">SELECT</span></span>
<span class="line">    schemaname<span class="token punctuation">,</span></span>
<span class="line">    tablename<span class="token punctuation">,</span></span>
<span class="line">    pg_size_pretty<span class="token punctuation">(</span>pg_total_relation_size<span class="token punctuation">(</span>schemaname<span class="token operator">||</span><span class="token string">&#39;.&#39;</span><span class="token operator">||</span>tablename<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> size</span>
<span class="line"><span class="token keyword">FROM</span> pg_tables</span>
<span class="line"><span class="token keyword">WHERE</span> schemaname <span class="token operator">=</span> <span class="token string">&#39;public&#39;</span></span>
<span class="line"><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> pg_total_relation_size<span class="token punctuation">(</span>schemaname<span class="token operator">||</span><span class="token string">&#39;.&#39;</span><span class="token operator">||</span>tablename<span class="token punctuation">)</span> <span class="token keyword">DESC</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 查看当前活动连接</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> pg_stat_activity<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 终止特定连接</span></span>
<span class="line"><span class="token keyword">SELECT</span> pg_terminate_backend<span class="token punctuation">(</span>pid<span class="token punctuation">)</span> <span class="token keyword">FROM</span> pg_stat_activity</span>
<span class="line"><span class="token keyword">WHERE</span> datname <span class="token operator">=</span> <span class="token string">&#39;mydatabase&#39;</span> <span class="token operator">AND</span> pid <span class="token operator">&lt;&gt;</span> pg_backend_pid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 查看表的统计信息</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> pg_stat_user_tables <span class="token keyword">WHERE</span> relname <span class="token operator">=</span> <span class="token string">&#39;users&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 查看索引使用情况</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> pg_stat_user_indexes <span class="token keyword">WHERE</span> relname <span class="token operator">=</span> <span class="token string">&#39;users&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="参考资源" tabindex="-1"><a class="header-anchor" href="#参考资源"><span>参考资源</span></a></h2><ul><li>官方文档: https://www.postgresql.org/docs/</li><li>中文文档: http://www.postgres.cn/docs/</li><li>PostgreSQL Wiki: https://wiki.postgresql.org/</li><li>PostgreSQL Tutorial: https://www.postgresqltutorial.com/</li></ul><hr><p><em>本手册基于PostgreSQL 16版本编写,涵盖了常用功能和最佳实践。</em></p>`,114))])}const u=l(o,[["render",d],["__file","index.html.vue"]]),v=JSON.parse('{"path":"/books/postgresql-handbook/","title":"PostgreSQL 使用手册","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"简介","slug":"简介","link":"#简介","children":[{"level":3,"title":"主要特点","slug":"主要特点","link":"#主要特点","children":[]}]},{"level":2,"title":"安装与配置","slug":"安装与配置","link":"#安装与配置","children":[{"level":3,"title":"Ubuntu/Debian系统安装","slug":"ubuntu-debian系统安装","link":"#ubuntu-debian系统安装","children":[]},{"level":3,"title":"macOS安装","slug":"macos安装","link":"#macos安装","children":[]},{"level":3,"title":"Windows安装","slug":"windows安装","link":"#windows安装","children":[]},{"level":3,"title":"基础配置","slug":"基础配置","link":"#基础配置","children":[]}]},{"level":2,"title":"基础操作","slug":"基础操作","link":"#基础操作","children":[{"level":3,"title":"连接数据库","slug":"连接数据库","link":"#连接数据库","children":[]},{"level":3,"title":"常用psql命令","slug":"常用psql命令","link":"#常用psql命令","children":[]},{"level":3,"title":"数据库操作","slug":"数据库操作","link":"#数据库操作","children":[]}]},{"level":2,"title":"数据类型","slug":"数据类型","link":"#数据类型","children":[{"level":3,"title":"数值类型","slug":"数值类型","link":"#数值类型","children":[]},{"level":3,"title":"字符类型","slug":"字符类型","link":"#字符类型","children":[]},{"level":3,"title":"日期时间类型","slug":"日期时间类型","link":"#日期时间类型","children":[]},{"level":3,"title":"布尔类型","slug":"布尔类型","link":"#布尔类型","children":[]},{"level":3,"title":"JSON类型","slug":"json类型","link":"#json类型","children":[]},{"level":3,"title":"数组类型","slug":"数组类型","link":"#数组类型","children":[]}]},{"level":2,"title":"SQL语句","slug":"sql语句","link":"#sql语句","children":[{"level":3,"title":"创建表","slug":"创建表","link":"#创建表","children":[]},{"level":3,"title":"插入数据","slug":"插入数据","link":"#插入数据","children":[]},{"level":3,"title":"查询数据","slug":"查询数据","link":"#查询数据","children":[]},{"level":3,"title":"更新数据","slug":"更新数据","link":"#更新数据","children":[]},{"level":3,"title":"删除数据","slug":"删除数据","link":"#删除数据","children":[]}]},{"level":2,"title":"索引与性能优化","slug":"索引与性能优化","link":"#索引与性能优化","children":[{"level":3,"title":"创建索引","slug":"创建索引","link":"#创建索引","children":[]},{"level":3,"title":"查看和管理索引","slug":"查看和管理索引","link":"#查看和管理索引","children":[]},{"level":3,"title":"查询优化","slug":"查询优化","link":"#查询优化","children":[]},{"level":3,"title":"性能优化技巧","slug":"性能优化技巧","link":"#性能优化技巧","children":[]}]},{"level":2,"title":"事务管理","slug":"事务管理","link":"#事务管理","children":[{"level":3,"title":"基础事务","slug":"基础事务","link":"#基础事务","children":[]},{"level":3,"title":"保存点","slug":"保存点","link":"#保存点","children":[]},{"level":3,"title":"事务隔离级别","slug":"事务隔离级别","link":"#事务隔离级别","children":[]}]},{"level":2,"title":"用户与权限管理","slug":"用户与权限管理","link":"#用户与权限管理","children":[{"level":3,"title":"用户管理","slug":"用户管理","link":"#用户管理","children":[]},{"level":3,"title":"角色管理","slug":"角色管理","link":"#角色管理","children":[]},{"level":3,"title":"权限管理","slug":"权限管理","link":"#权限管理","children":[]}]},{"level":2,"title":"备份与恢复","slug":"备份与恢复","link":"#备份与恢复","children":[{"level":3,"title":"使用pg_dump备份","slug":"使用pg-dump备份","link":"#使用pg-dump备份","children":[]},{"level":3,"title":"使用pg_dumpall备份","slug":"使用pg-dumpall备份","link":"#使用pg-dumpall备份","children":[]},{"level":3,"title":"恢复数据","slug":"恢复数据","link":"#恢复数据","children":[]},{"level":3,"title":"连续归档和时间点恢复(PITR)","slug":"连续归档和时间点恢复-pitr","link":"#连续归档和时间点恢复-pitr","children":[]}]},{"level":2,"title":"高级特性","slug":"高级特性","link":"#高级特性","children":[{"level":3,"title":"视图","slug":"视图","link":"#视图","children":[]},{"level":3,"title":"触发器","slug":"触发器","link":"#触发器","children":[]},{"level":3,"title":"存储过程和函数","slug":"存储过程和函数","link":"#存储过程和函数","children":[]},{"level":3,"title":"JSON操作","slug":"json操作","link":"#json操作","children":[]},{"level":3,"title":"全文搜索","slug":"全文搜索","link":"#全文搜索","children":[]},{"level":3,"title":"分区表","slug":"分区表","link":"#分区表","children":[]},{"level":3,"title":"窗口函数","slug":"窗口函数","link":"#窗口函数","children":[]},{"level":3,"title":"CTE(公共表表达式)","slug":"cte-公共表表达式","link":"#cte-公共表表达式","children":[]}]},{"level":2,"title":"常用维护命令","slug":"常用维护命令","link":"#常用维护命令","children":[]},{"level":2,"title":"参考资源","slug":"参考资源","link":"#参考资源","children":[]}],"git":{},"filePathRelative":"books/postgresql-handbook/index.md"}');export{u as comp,v as data};
