import{_ as n,c as s,f as a,o as d}from"./app-BB_BIQV8.js";const i={};function t(l,e){return d(),s("div",null,e[0]||(e[0]=[a(`<h5 id="åŸºäºhaproxy-å®¹å™¨-nginxçš„é¡¹ç›®éƒ¨ç½²" tabindex="-1"><a class="header-anchor" href="#åŸºäºhaproxy-å®¹å™¨-nginxçš„é¡¹ç›®éƒ¨ç½²"><span>åŸºäºHaproxy+å®¹å™¨+Nginxçš„é¡¹ç›®éƒ¨ç½²:</span></a></h5><p>æœ€è¿‘åœ¨çœ‹é¡¹ç›®éƒ¨ç½²ç›¸å…³çš„ä¸œè¥¿ï¼Œè¿™äº›éƒ½æ˜¯å®é™…å·¥ä½œä¸­ç”¨åˆ°çš„.</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">é¦–å…ˆåšäº†å¦‚ä¸‹éƒ¨ç½²ï¼š</span>
<span class="line">ha é‡Œé¢åšäº† http--&gt;httpsçš„è½¬å‘åˆ° duo_staging_backend</span>
<span class="line"></span>
<span class="line">duo_staging_backend å³ä¸ºåå°æœåŠ¡: 10.10.0.121:4431-----dockerå®¹å™¨æ˜ å°„------&gt; nginx 443 æœåŠ¡ï¼Œstaging.duo.com</span>
<span class="line"></span>
<span class="line">staging.duo.com ç»‘å®šçš„å…¬ç½‘IPå°±æ˜¯è¿™ä¸ª 175.63.194.210</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="å†çœ‹ä¸‹é¢è¿™æ®µä»£ç å°±çŸ¥é“äº†è¿™ä¹ˆéƒ¨ç½²çš„åŸç†" tabindex="-1"><a class="header-anchor" href="#å†çœ‹ä¸‹é¢è¿™æ®µä»£ç å°±çŸ¥é“äº†è¿™ä¹ˆéƒ¨ç½²çš„åŸç†"><span>å†çœ‹ä¸‹é¢è¿™æ®µä»£ç å°±çŸ¥é“äº†è¿™ä¹ˆéƒ¨ç½²çš„åŸç†:</span></a></h5><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">frontend http_frontend</span>
<span class="line">    bind *:80</span>
<span class="line">    mode http</span>
<span class="line">    option httplog</span>
<span class="line">    redirect scheme https code 301 if !{ ssl_fc }</span>
<span class="line">  </span>
<span class="line">frontend https_frontend</span>
<span class="line">    bind *:443 ssl crt /etc/haproxy/certs/your_domain.pem</span>
<span class="line">    mode http</span>
<span class="line">    option httplog</span>
<span class="line">    default_backend https_backend</span>
<span class="line">    </span>
<span class="line">    //è¿™é‡Œå…¶å®è¿˜å¯ä»¥ä½¿ç”¨ ACLï¼ˆAccess Control Listï¼‰æ£€æŸ¥è¯·æ±‚çš„ &quot;Host&quot; å¤´éƒ¨æ˜¯å¦ä¸º www.hello.testã€‚å¦‚æœæ˜¯ï¼Œå°†ä½¿ç”¨ https_backend åç«¯ã€‚</span>
<span class="line">    acl is_hello_test hdr(host) -i www.hello.test</span>
<span class="line">    use_backend https_backend if is_hello_test</span>
<span class="line">      </span>
<span class="line">backend https_backend</span>
<span class="line">    mode http</span>
<span class="line">    option httplog</span>
<span class="line">    server backend_server 192.168.1.2:8443 ssl verify none</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="ä¸Šé¢é…ç½®åˆ†æ" tabindex="-1"><a class="header-anchor" href="#ä¸Šé¢é…ç½®åˆ†æ"><span>ä¸Šé¢é…ç½®åˆ†æ</span></a></h5><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">åœ¨ä¸Šè¿°é…ç½®ä¸­ï¼š</span>
<span class="line">1.http_frontend æ˜¯ä¸€ä¸ªå‰ç«¯ï¼Œç›‘å¬80ç«¯å£ï¼Œé€šè¿‡ HTTP è½¬å‘åˆ° HTTPSã€‚</span>
<span class="line">2.redirect scheme https code 301 if !{ ssl_fc } å°†æ‰€æœ‰ HTTP è¯·æ±‚é‡å®šå‘åˆ° HTTPSã€‚</span>
<span class="line">3.https_frontend æ˜¯å¦ä¸€ä¸ªå‰ç«¯ï¼Œç›‘å¬443ç«¯å£ï¼Œç”¨äºç»ˆæ­¢ SSL/TLSï¼Œä½¿ç”¨ /etc/haproxy/certs/your_domain.pem è¯ä¹¦æ–‡ä»¶è¿›è¡Œ SSL å¤„ç†ã€‚</span>
<span class="line">4.default_backend https_backend å°† HTTPS è¯·æ±‚è½¬å‘åˆ°åç«¯çš„ HTTPS æœåŠ¡å™¨ã€‚</span>
<span class="line">5.è¿™é‡Œ 192.168.1.2:8443 æ˜¯ä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼ŒIP åœ°å€æ˜¯ 192.168.1.2ï¼Œç«¯å£æ˜¯ 8443ã€‚ssl å…³é”®å­—è¡¨ç¤ºä½¿ç”¨ SSL/TLS è¿æ¥ã€‚verify none è¡¨ç¤ºä¸è¿›è¡Œè¯ä¹¦éªŒè¯ï¼Œè¿™åœ¨æµ‹è¯•ç¯å¢ƒä¸­å¯èƒ½å¯ä»¥æ¥å—ã€‚</span>
<span class="line">ç„¶åï¼Œä½ éœ€è¦ç¡®ä¿åœ¨ä½ çš„å®¹å™¨ç¯å¢ƒä¸­ï¼Œå°†å®¹å™¨çš„443ç«¯å£æ­£ç¡®æ˜ å°„åˆ°ä¸»æœºçš„ 192.168.1.2:8443 åœ°å€ä¸Šã€‚</span>
<span class="line"></span>
<span class="line">6.å½“ç„¶äº†ï¼Œ192.168.1.2:8443 ä¹Ÿå¯ä»¥æ˜ å°„åˆ°å®¹å™¨çš„80ç«¯å£ï¼Œaca é¡¹ç›®çš„ç¬¬ä¸€æ¬¡é…ç½®å°±æ˜¯è¿™ä¹ˆé…ç½®çš„ï¼Œç›¸å½“äºhaproxyåšäº†ä¸€æ¬¡ 80---&gt;443---&gt;80çš„è½¬æ¢ï¼Œä½†æ˜¯è¿™æ ·å¯¼è‡´ï¼Œé¡¹ç›®ä»£æ¯é‡Œé¢è·å–åˆ°çš„æ€»æ˜¯httpåè®®ï¼Œè€Œä¸æ˜¯httpsåè®®ï¼Œå°±ä¼šæŠ¥ä¸‹é¢çš„é”™è¯¯:</span>
<span class="line">7037.a1ad5b79.js:1 Mixed Content: The page at &#39;https://staging.duo.com/admin/course/manage/list/1&#39; was loaded over HTTPS, but requested an insecure XMLHttpRequest endpoint &#39;http://staging.duo.com/admin/course/quiz?course_id=1&#39;. This request has been blocked; the content must be served over HTTPS.</span>
<span class="line"></span>
<span class="line">æ‰€ä»¥åæ¥å’Œè¿ç»´è®¨è®ºäº†è¿™ä¸ªé—®é¢˜ï¼Œä»–å°±æŠŠ 192.168.1.2:8443 æ˜ å°„åˆ°äº†å®¹å™¨çš„443ç«¯å£(å½“ç„¶åˆé‡æ–°é…ç½®äº†httpsè¯ä¹¦)</span>
<span class="line"></span>
<span class="line">7.ä¸Šé¢è¿™ç§é…ç½®æ˜¯ä¸€ç§å¸¸è§çš„åšæ³•ï¼Œå¯ä»¥å°†å¤–éƒ¨è¯·æ±‚é€šè¿‡ HAProxy è½¬å‘åˆ°å†…éƒ¨å®¹å™¨çš„å®‰å…¨ç«¯å£ï¼Œä»è€Œå®ç°éš”ç¦»å’Œå®‰å…¨æ€§ã€‚</span>
<span class="line"></span>
<span class="line">8.ä¸Šé¢æœ‰ä¸ª acl é…ç½®ï¼Œè¿™é‡Œçš„ www.hello.testï¼ŒDNS è§£æä¸ºå®¿ä¸»æœºçš„å…¬ç½‘IPï¼Œä½†æ˜¯ä½¿ç”¨çš„æ—¶å€™  www.hello.test é…ç½®åœ¨ å®¹å™¨çš„ nginx server_name é‡Œé¢çš„ï¼Œè¿™æ ·é…ç½®æœ‰ä¸ªä½¿ç”¨å‰æï¼šéœ€è¦åœ¨ä¸»æœºä¸Šè¿è¡Œä¸€ä¸ª HTTP æœåŠ¡å™¨æ¥å¤„ç† www.hello.test åŸŸåçš„è¯·æ±‚ï¼Œè¿™é‡Œå°±æ˜¯ä½¿ç”¨äº† haproxy æ¥å¤„ç†çš„ã€‚æ‰€ä»¥æ•´ä¸ªè¿‡ç¨‹é…åˆçš„ååˆ†å·§å¦™ã€‚</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">ç»†èŠ‚å¯ä»¥å‚è€ƒï¼š chatGPTä¸‹çš„ nginxæœåŠ¡ å¯¹è¯ï¼Œæ„Ÿè§‰  chatGPT è¿˜æ˜¯å¾ˆå¼ºå¤§çš„ï¼Œç›´æ¥å¸®æˆ‘éªŒè¯äº†è¿™ä¸€ç†è®ºã€‚</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="è¿™ä¸ªé…ç½®è¿˜æ˜¯å¾ˆå®ç”¨çš„-å®é™…ä¸Šçš„backendå¯ä»¥æœ‰å¤šä¸ª-é€šè¿‡haproxyåšè´Ÿè½½å‡è¡¡-å¦‚ä¸‹æ‰€ç¤º" tabindex="-1"><a class="header-anchor" href="#è¿™ä¸ªé…ç½®è¿˜æ˜¯å¾ˆå®ç”¨çš„-å®é™…ä¸Šçš„backendå¯ä»¥æœ‰å¤šä¸ª-é€šè¿‡haproxyåšè´Ÿè½½å‡è¡¡-å¦‚ä¸‹æ‰€ç¤º"><span>è¿™ä¸ªé…ç½®è¿˜æ˜¯å¾ˆå®ç”¨çš„ï¼Œå®é™…ä¸Šçš„backendå¯ä»¥æœ‰å¤šä¸ªï¼Œé€šè¿‡Haproxyåšè´Ÿè½½å‡è¡¡ï¼Œå¦‚ä¸‹æ‰€ç¤º:</span></a></h5><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">backend nginx_backend</span>
<span class="line">    mode http</span>
<span class="line">    option httplog</span>
<span class="line">    balance roundrobin  # ä½¿ç”¨å¾ªç¯ç®—æ³•è¿›è¡Œè´Ÿè½½å‡è¡¡</span>
<span class="line">    server container_server1 172.17.0.2:80 check</span>
<span class="line">    server container_server2 172.17.0.3:80 check</span>
<span class="line">    server container_server3 172.17.0.4:80 check</span>
<span class="line"></span>
<span class="line">//å½“ç„¶ container_server1 container_server2 container_server3 å¯¹åº”çš„å®¹å™¨æœåŠ¡é‡Œçš„ nginx server_nameé…ç½®ä¹Ÿè¦æ˜¯ç›¸åŒçš„çš„</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>ä¸Šé¢æ²¡æœ‰ä½¿ç”¨ KeepAlivedï¼ŒåŸå› æ˜¯ï¼Œå·²ç»å¤Ÿç”¨äº†ï¼Œå½“ç„¶å¦‚æœä½¿ç”¨ KeepAlivedï¼Œé‚£å°±ä¼šæ›´å¤æ‚æœ‰äº›</p></blockquote><hr><h5 id="haproxy-acl-å¸¸ç”¨-fetch-æ–¹æ³•-åŒ¹é…è¿ç®—ç¬¦è¡¨" tabindex="-1"><a class="header-anchor" href="#haproxy-acl-å¸¸ç”¨-fetch-æ–¹æ³•-åŒ¹é…è¿ç®—ç¬¦è¡¨"><span>HAProxy ACL å¸¸ç”¨ fetch æ–¹æ³• + åŒ¹é…è¿ç®—ç¬¦è¡¨</span></a></h5><table><thead><tr><th>fetch æ–¹æ³•</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td><code>hdr(&lt;name&gt;)</code></td><td>å–è¯·æ±‚å¤´ <code>&lt;name&gt;</code>ï¼Œæ¯”å¦‚ <code>hdr(User-Agent)</code></td></tr><tr><td><code>path</code></td><td>å– URL çš„ path éƒ¨åˆ†ï¼ˆä¸å« query stringï¼‰</td></tr><tr><td><code>url_param(&lt;name&gt;)</code></td><td>å– URL å‚æ•° <code>&lt;name&gt;</code> çš„å€¼</td></tr><tr><td><code>method</code></td><td>å– HTTP æ–¹æ³•ï¼Œå¦‚ <code>GET</code>ã€<code>POST</code></td></tr><tr><td><code>src</code></td><td>å–å®¢æˆ·ç«¯ IP åœ°å€</td></tr><tr><td><code>dst</code></td><td>å–ç›®æ ‡æœåŠ¡å™¨ IP åœ°å€</td></tr><tr><td><code>ssl_fc</code></td><td>åˆ¤æ–­æ˜¯å¦æ˜¯ SSL å‰ç«¯è¿æ¥ (true/false)</td></tr><tr><td><code>nbsrv(&lt;backend&gt;)</code></td><td>è·å–æŸä¸ª backend å½“å‰å¯ç”¨çš„ server æ•°é‡</td></tr><tr><td><code>req_len</code></td><td>è¯·æ±‚æŠ¥æ–‡å¤§å°</td></tr><tr><td><code>resp_len</code></td><td>å“åº”æŠ¥æ–‡å¤§å°</td></tr></tbody></table><h5 id="ğŸŸ¡-å¸¸ç”¨åŒ¹é…è¿ç®—ç¬¦" tabindex="-1"><a class="header-anchor" href="#ğŸŸ¡-å¸¸ç”¨åŒ¹é…è¿ç®—ç¬¦"><span>ğŸŸ¡ å¸¸ç”¨åŒ¹é…è¿ç®—ç¬¦</span></a></h5><table><thead><tr><th>è¿ç®—ç¬¦ / ç®€å†™</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td><code>-m sub</code> â†’ <code>_sub</code></td><td>å­ä¸²åŒ¹é…ï¼ˆåŒ…å«ï¼‰</td></tr><tr><td><code>-m beg</code> â†’ <code>_beg</code></td><td>å‰ç¼€åŒ¹é…ï¼ˆä»¥â€¦å¼€å¤´ï¼‰</td></tr><tr><td><code>-m end</code> â†’ <code>_end</code></td><td>åç¼€åŒ¹é…ï¼ˆä»¥â€¦ç»“å°¾ï¼‰</td></tr><tr><td><code>-m reg</code> â†’ <code>_reg</code></td><td>æ­£åˆ™åŒ¹é…</td></tr><tr><td><code>-i</code></td><td>å¿½ç•¥å¤§å°å†™ï¼ˆå¯å’Œä¸Šé¢ç»„åˆï¼‰</td></tr><tr><td><code>eq</code> / <code>lt</code> / <code>gt</code></td><td>æ•°å€¼æ¯”è¾ƒï¼ˆç­‰äº / å°äº / å¤§äºï¼‰</td></tr><tr><td><code>len</code></td><td>é•¿åº¦æ¯”è¾ƒ</td></tr></tbody></table><h5 id="ğŸ”µ-ç»„åˆç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#ğŸ”µ-ç»„åˆç¤ºä¾‹"><span>ğŸ”µ ç»„åˆç¤ºä¾‹</span></a></h5><ul><li><p><strong>åŒ¹é…ç§»åŠ¨ç«¯ UA</strong></p><div class="language-haproxy line-numbers-mode" data-highlighter="prismjs" data-ext="haproxy" data-title="haproxy"><pre><code><span class="line">acl is_mobile hdr_sub(User-Agent) -i mobile</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>â†’ <code>hdr(User-Agent)</code> + <code>sub</code>ï¼Œæ£€æŸ¥ UA é‡Œæ˜¯å¦åŒ…å« <code>mobile</code>ï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰ã€‚</p></li><li><p><strong>åŒ¹é… <code>/api/</code> å¼€å¤´çš„è·¯å¾„</strong></p><div class="language-haproxy line-numbers-mode" data-highlighter="prismjs" data-ext="haproxy" data-title="haproxy"><pre><code><span class="line">acl is_api path_beg /api/</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>â†’ <code>path</code> + <code>beg</code>ï¼Œæ£€æŸ¥ URL path æ˜¯å¦ä»¥ <code>/api/</code> å¼€å¤´ã€‚</p></li><li><p><strong>åˆ¤æ–­æ¥æº IP æ˜¯å¦å†…ç½‘</strong></p><div class="language-haproxy line-numbers-mode" data-highlighter="prismjs" data-ext="haproxy" data-title="haproxy"><pre><code><span class="line">acl is_admin src 192.168.1.0/24</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p><strong>åˆ¤æ–­åç«¯å­˜æ´»æ•°æ˜¯å¦ &lt; 2</strong></p><div class="language-haproxy line-numbers-mode" data-highlighter="prismjs" data-ext="haproxy" data-title="haproxy"><pre><code><span class="line">acl high_load nbsrv(web_backend) lt 2</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ul>`,17)]))}const c=n(i,[["render",t],["__file","åŸºäºHaproxy_å®¹å™¨_Nginxçš„é¡¹ç›®éƒ¨ç½².html.vue"]]),p=JSON.parse('{"path":"/content/service/deploy/%E5%9F%BA%E4%BA%8EHaproxy_%E5%AE%B9%E5%99%A8_Nginx%E7%9A%84%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2.html","title":"åŸºäºHaproxyå®¹å™¨Nginxçš„é¡¹ç›®éƒ¨ç½²","lang":"en-US","frontmatter":{"sidebar":false,"title":"åŸºäºHaproxyå®¹å™¨Nginxçš„é¡¹ç›®éƒ¨ç½²","description":"åŸºäºHaproxyå®¹å™¨Nginxçš„é¡¹ç›®éƒ¨ç½²"},"headers":[],"git":{},"filePathRelative":"content/service/deploy/åŸºäºHaproxy+å®¹å™¨+Nginxçš„é¡¹ç›®éƒ¨ç½².md"}');export{c as comp,p as data};
