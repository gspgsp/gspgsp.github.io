import{_ as n,c as a,d as e,o as i}from"./app-CHrRue27.js";const l={};function d(p,s){return i(),a("div",null,s[0]||(s[0]=[e(`<h4 id="gitlab之server端hook自动创建项目分支" tabindex="-1"><a class="header-anchor" href="#gitlab之server端hook自动创建项目分支"><span>gitlab之server端hook自动创建项目分支</span></a></h4><ul><li>之前已经搭建了gitlab下的server hook，做了简单的测试，是可以生效的，接下来准备通过这个hook实现，代码分支的自动发布</li><li>思路如下:</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">1.在gitlab的server的post-receive下定义一个脚本</span>
<span class="line">2.在这个脚本里面通过ssh登录到宿主机，然后执行宿主机上的脚本,在这个脚本里面，执行拉取代码操作</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>环境准备:</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">由于要使用ssh服务，所以必须要在系统安装ssh</span>
<span class="line">1.检查ssh是否安装</span>
<span class="line">systemctl status ssh</span>
<span class="line"></span>
<span class="line">2.如果没有安装，可以通过如下方式安装</span>
<span class="line">$ sudo apt install -y openssh-server</span>
<span class="line">Reading package lists... Done</span>
<span class="line">Building dependency tree... Done</span>
<span class="line">Reading state information... Done</span>
<span class="line">The following additional packages will be installed:</span>
<span class="line">  ncurses-term openssh-sftp-server ssh-import-id</span>
<span class="line">Suggested packages:</span>
<span class="line">  molly-guard monkeysphere ssh-askpass</span>
<span class="line">The following NEW packages will be installed:</span>
<span class="line">  ncurses-term openssh-server openssh-sftp-server ssh-import-id</span>
<span class="line">0 upgraded, 4 newly installed, 0 to remove and 247 not upgraded.</span>
<span class="line">Need to get 751 kB of archives.</span>
<span class="line">After this operation, 6,046 kB of additional disk space will be used.</span>
<span class="line">Get:1 http://mirrors.tuna.tsinghua.edu.cn/ubuntu jammy-updates/main amd64 openssh-sftp-server amd64 1:8.9p1-3ubuntu0.11 [38.7 kB]</span>
<span class="line">Get:2 http://mirrors.tuna.tsinghua.edu.cn/ubuntu jammy-updates/main amd64 openssh-server amd64 1:8.9p1-3ubuntu0.11 [435 kB]</span>
<span class="line">Get:3 http://mirrors.tuna.tsinghua.edu.cn/ubuntu jammy-updates/main amd64 ncurses-term all 6.3-2ubuntu0.1 [267 kB]</span>
<span class="line">Get:4 http://mirrors.tuna.tsinghua.edu.cn/ubuntu jammy/main amd64 ssh-import-id all 5.11-0ubuntu1 [10.1 kB]</span>
<span class="line">Fetched 751 kB in 3s (245 kB/s)          </span>
<span class="line">Preconfiguring packages ...</span>
<span class="line">Selecting previously unselected package openssh-sftp-server.</span>
<span class="line">(Reading database ... 287328 files and directories currently installed.)</span>
<span class="line">Preparing to unpack .../openssh-sftp-server_1%3a8.9p1-3ubuntu0.11_amd64.deb ...</span>
<span class="line">Unpacking openssh-sftp-server (1:8.9p1-3ubuntu0.11) ...</span>
<span class="line">Selecting previously unselected package openssh-server.</span>
<span class="line">Preparing to unpack .../openssh-server_1%3a8.9p1-3ubuntu0.11_amd64.deb ...</span>
<span class="line">Unpacking openssh-server (1:8.9p1-3ubuntu0.11) ...</span>
<span class="line">Selecting previously unselected package ncurses-term.</span>
<span class="line">Preparing to unpack .../ncurses-term_6.3-2ubuntu0.1_all.deb ...</span>
<span class="line">Unpacking ncurses-term (6.3-2ubuntu0.1) ...</span>
<span class="line">Selecting previously unselected package ssh-import-id.</span>
<span class="line">Preparing to unpack .../ssh-import-id_5.11-0ubuntu1_all.deb ...</span>
<span class="line">Unpacking ssh-import-id (5.11-0ubuntu1) ...</span>
<span class="line">Setting up openssh-sftp-server (1:8.9p1-3ubuntu0.11) ...</span>
<span class="line">Setting up openssh-server (1:8.9p1-3ubuntu0.11) ...</span>
<span class="line"></span>
<span class="line">Creating config file /etc/ssh/sshd_config with new version</span>
<span class="line">Creating SSH2 RSA key; this may take some time ...</span>
<span class="line">3072 SHA256:Bc6mfCjp5qrlFU0x7wu1fcSGY718FeEXXnwcU4PHeDA root@tianyi510s (RSA)</span>
<span class="line">Creating SSH2 ECDSA key; this may take some time ...</span>
<span class="line">256 SHA256:wirUnlfZcsdMjIy3lhIEfkWnItdXByl+uxTyVEpzNzQ root@tianyi510s (ECDSA)</span>
<span class="line">Creating SSH2 ED25519 key; this may take some time ...</span>
<span class="line">256 SHA256:hMriVpK3rh8cVNiQvlU82t3hw0KUDkIvAYhJC1munkQ root@tianyi510s (ED25519)</span>
<span class="line">Created symlink /etc/systemd/system/sshd.service → /lib/systemd/system/ssh.service.</span>
<span class="line">Created symlink /etc/systemd/system/multi-user.target.wants/ssh.service → /lib/systemd/system/ssh.service.</span>
<span class="line">rescue-ssh.target is a disabled or a static unit, not starting it.</span>
<span class="line">ssh.socket is a disabled or a static unit, not starting it.</span>
<span class="line">Setting up ssh-import-id (5.11-0ubuntu1) ...</span>
<span class="line">Setting up ncurses-term (6.3-2ubuntu0.1) ...</span>
<span class="line">Processing triggers for man-db (2.10.2-1) ...</span>
<span class="line">Processing triggers for ufw (0.36.1-4build1) ...</span>
<span class="line">guoshipeng@tianyi510s:~$ </span>
<span class="line">guoshipeng@tianyi510s:~$ sudo systemctl start ssh</span>
<span class="line">guoshipeng@tianyi510s:~$ </span>
<span class="line">guoshipeng@tianyi510s:~$ systemctl status ssh</span>
<span class="line">● ssh.service - OpenBSD Secure Shell server</span>
<span class="line">     Loaded: loaded (/lib/systemd/system/ssh.service; enabled; vendor preset: enabled)</span>
<span class="line">     Active: active (running) since Thu 2025-03-06 00:16:38 CST; 27s ago</span>
<span class="line">       Docs: man:sshd(8)</span>
<span class="line">             man:sshd_config(5)</span>
<span class="line">   Main PID: 22674 (sshd)</span>
<span class="line">      Tasks: 1 (limit: 18753)</span>
<span class="line">     Memory: 1.7M</span>
<span class="line">        CPU: 11ms</span>
<span class="line">     CGroup: /system.slice/ssh.service</span>
<span class="line">             └─22674 &quot;sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 startups&quot;</span>
<span class="line"></span>
<span class="line">Mar 06 00:16:38 tianyi510s systemd[1]: Starting OpenBSD Secure Shell server...</span>
<span class="line">Mar 06 00:16:38 tianyi510s sshd[22674]: Server listening on 0.0.0.0 port 22.</span>
<span class="line">Mar 06 00:16:38 tianyi510s sshd[22674]: Server listening on :: port 22.</span>
<span class="line">Mar 06 00:16:38 tianyi510s systemd[1]: Started OpenBSD Secure Shell server.</span>
<span class="line">guoshipeng@tianyi510s:~$ </span>
<span class="line">guoshipeng@tianyi510s:~$ sudo systemctl enable ssh //设置开机自启动</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>步骤如下:</li></ul><h5 id="第一部分-配置ssh连接" tabindex="-1"><a class="header-anchor" href="#第一部分-配置ssh连接"><span>第一部分，配置ssh连接</span></a></h5><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">1.由于需要ssh 连接到宿主机，需要将本地主机的SSH公钥安装到远程主机的授权密钥文件中</span>
<span class="line">1&gt;在容器中通过openssh 生成SSH密钥</span>
<span class="line">root@gitlab:/# apt-get install -y openssh-client</span>
<span class="line">Reading package lists... Done</span>
<span class="line">Building dependency tree... Done</span>
<span class="line">Reading state information... Done</span>
<span class="line">The following additional packages will be installed:</span>
<span class="line">  openssh-server openssh-sftp-server</span>
<span class="line">Suggested packages:</span>
<span class="line">  keychain libpam-ssh monkeysphere ssh-askpass molly-guard ufw</span>
<span class="line">Recommended packages:</span>
<span class="line">  xauth default-logind | logind | libpam-systemd ncurses-term ssh-import-id</span>
<span class="line">The following packages will be upgraded:</span>
<span class="line">  openssh-client openssh-server openssh-sftp-server</span>
<span class="line">3 upgraded, 0 newly installed, 0 to remove and 17 not upgraded.</span>
<span class="line">Need to get 1376 kB of archives.</span>
<span class="line">After this operation, 0 B of additional disk space will be used.</span>
<span class="line">Get:1 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 openssh-sftp-server amd64 1:8.9p1-3ubuntu0.11 [38.7 kB]</span>
<span class="line">Get:2 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 openssh-server amd64 1:8.9p1-3ubuntu0.11 [435 kB]</span>
<span class="line">Get:3 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 openssh-client amd64 1:8.9p1-3ubuntu0.11 [903 kB]</span>
<span class="line">Fetched 1376 kB in 3s (479 kB/s)      </span>
<span class="line">debconf: delaying package configuration, since apt-utils is not installed</span>
<span class="line">(Reading database ... 112282 files and directories currently installed.)</span>
<span class="line">Preparing to unpack .../openssh-sftp-server_1%3a8.9p1-3ubuntu0.11_amd64.deb ...</span>
<span class="line">Unpacking openssh-sftp-server (1:8.9p1-3ubuntu0.11) over (1:8.9p1-3ubuntu0.10) ...</span>
<span class="line">Preparing to unpack .../openssh-server_1%3a8.9p1-3ubuntu0.11_amd64.deb ...</span>
<span class="line">Unpacking openssh-server (1:8.9p1-3ubuntu0.11) over (1:8.9p1-3ubuntu0.10) ...</span>
<span class="line">Preparing to unpack .../openssh-client_1%3a8.9p1-3ubuntu0.11_amd64.deb ...</span>
<span class="line">Unpacking openssh-client (1:8.9p1-3ubuntu0.11) over (1:8.9p1-3ubuntu0.10) ...</span>
<span class="line">Setting up openssh-client (1:8.9p1-3ubuntu0.11) ...</span>
<span class="line">Setting up openssh-sftp-server (1:8.9p1-3ubuntu0.11) ...</span>
<span class="line">Setting up openssh-server (1:8.9p1-3ubuntu0.11) ...</span>
<span class="line">debconf: unable to initialize frontend: Dialog</span>
<span class="line">debconf: (No usable dialog-like program is installed, so the dialog based frontend cannot be used. at /usr/share/perl5/Debconf/FrontEnd/Dialog.pm line 78.)</span>
<span class="line">debconf: falling back to frontend: Readline</span>
<span class="line">invoke-rc.d: could not determine current runlevel</span>
<span class="line">invoke-rc.d: policy-rc.d denied execution of restart.</span>
<span class="line">root@gitlab:/# </span>
<span class="line">root@gitlab:/# </span>
<span class="line">root@gitlab:/# </span>
<span class="line">root@gitlab:/# ssh-keygen -t rsa -b 4096</span>
<span class="line">Generating public/private rsa key pair.</span>
<span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span>
<span class="line">Created directory &#39;/root/.ssh&#39;.</span>
<span class="line">Enter passphrase (empty for no passphrase): </span>
<span class="line">Enter same passphrase again: </span>
<span class="line">Your identification has been saved in /root/.ssh/id_rsa</span>
<span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub</span>
<span class="line">The key fingerprint is:</span>
<span class="line">SHA256:3c4MshoBmZ4/mH7PqsAbJY6fxa5lHkopWN8cXp8YKkE root@gitlab.example.com</span>
<span class="line">The key&#39;s randomart image is:</span>
<span class="line">+---[RSA 4096]----+</span>
<span class="line">|                 |</span>
<span class="line">|     o           |</span>
<span class="line">|    E            |</span>
<span class="line">|   o o   . .     |</span>
<span class="line">|  o = o S o .    |</span>
<span class="line">|.= * O = * *     |</span>
<span class="line">|+ B @ O o o +    |</span>
<span class="line">| + &amp; o.=         |</span>
<span class="line">|  *.=oooo        |</span>
<span class="line">+----[SHA256]-----+</span>
<span class="line">root@gitlab:/# </span>
<span class="line">root@gitlab:/# cd  ~/.ssh/</span>
<span class="line">root@gitlab:~/.ssh# ls</span>
<span class="line">id_rsa  id_rsa.pub</span>
<span class="line"></span>
<span class="line">2&gt;通过 ssh-copy-id 命令，将本地主机的SSH公钥安装到远程主机的授权密钥文件中</span>
<span class="line">root@gitlab:~/.ssh# ssh-copy-id guoshipeng@192.168.5.17</span>
<span class="line">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: &quot;/root/.ssh/id_rsa.pub&quot;</span>
<span class="line">The authenticity of host &#39;192.168.5.17 (192.168.5.17)&#39; can&#39;t be established.</span>
<span class="line">ED25519 key fingerprint is SHA256:hMriVpK3rh8cVNiQvlU82t3hw0KUDkIvAYhJC1munkQ.</span>
<span class="line">This key is not known by any other names</span>
<span class="line">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span>
<span class="line">/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed</span>
<span class="line">/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys</span>
<span class="line">guoshipeng@192.168.5.17&#39;s password: </span>
<span class="line">Permission denied, please try again.</span>
<span class="line">guoshipeng@192.168.5.17&#39;s password: </span>
<span class="line"></span>
<span class="line">Number of key(s) added: 1</span>
<span class="line"></span>
<span class="line">Now try logging into the machine, with:   &quot;ssh &#39;guoshipeng@192.168.5.17&#39;&quot;</span>
<span class="line">and check to make sure that only the key(s) you wanted were added.</span>
<span class="line"></span>
<span class="line">root@gitlab:~/.ssh# </span>
<span class="line"></span>
<span class="line">3&gt;ssh-copy-id 原理</span>
<span class="line">它会读取本地的SSH公钥（通常是 ~/.ssh/id_rsa.pub）</span>
<span class="line">将公钥上传到远程服务器</span>
<span class="line">添加到远程服务器的授权密钥列表中</span>
<span class="line"></span>
<span class="line">语法:</span>
<span class="line">ssh-copy-id user@hostname</span>
<span class="line"></span>
<span class="line">参数:</span>
<span class="line">user：远程服务器的用户名</span>
<span class="line">hostname：远程服务器的IP地址或域名</span>
<span class="line"></span>
<span class="line">注意:</span>
<span class="line">执行这个命令时：</span>
<span class="line">会提示你输入远程服务器的密码</span>
<span class="line">成功后，你就可以无密码SSH登录该服务器了</span>
<span class="line">确保只对可信的服务器使用</span>
<span class="line"></span>
<span class="line">2.配置SSH配置文件，在容器中编辑 ~/.ssh/config 文件，简化连接，内容如下:</span>
<span class="line">Host hostmachine</span>
<span class="line">    HostName 宿主机IP地址</span>
<span class="line">    User 宿主机用户名</span>
<span class="line">    IdentityFile ~/.ssh/id_rsa</span>
<span class="line"></span>
<span class="line">对于 ~/.ssh/config 文件，如果不存在，可以直接创建：</span>
<span class="line">touch ~/.ssh/config</span>
<span class="line">chmod 600 ~/.ssh/config</span>
<span class="line"></span>
<span class="line">我的配置内容如下:</span>
<span class="line">Host myserver</span>
<span class="line">    HostName 192.168.5.17</span>
<span class="line">    User guoshipeng</span>
<span class="line">    Port 22</span>
<span class="line">    IdentityFile ~/.ssh/id_rsa</span>
<span class="line"></span>
<span class="line">这样配置后，就可以直接使用 ssh myserver 连接，而不需要每次输入完整的用户名和IP(ssh user@host 的方式)。所以最好取一个有意义的名称(别名)，这里是myserver</span>
<span class="line">需要注意的是：</span>
<span class="line">文件权限必须是600（仅对所有者可读可写）</span>
<span class="line">可以配置多个不同的主机</span>
<span class="line">简化日常SSH连接操作</span>
<span class="line"></span>
<span class="line">3.确保宿主机SSH服务器配置，在宿主机 /etc/ssh/sshd_config 中确认以下配置:</span>
<span class="line">PubkeyAuthentication yes</span>
<span class="line">AuthorizedKeysFile .ssh/authorized_keys</span>
<span class="line"></span>
<span class="line">查看宿主机相关配置，如下(根据需要爱哦已经做了修改):</span>
<span class="line">#PubkeyAuthentication yes</span>
<span class="line">PubkeyAuthentication yes</span>
<span class="line"></span>
<span class="line"># Expect .ssh/authorized_keys2 to be disregarded by default in future.</span>
<span class="line">#AuthorizedKeysFile     .ssh/authorized_keys .ssh/authorized_keys2</span>
<span class="line">AuthorizedKeysFile      .ssh/authorized_keys</span>
<span class="line"></span>
<span class="line">然后重启宿主机的ssh:</span>
<span class="line">sudo systemctl restart ssh</span>
<span class="line"></span>
<span class="line">关于AuthorizedKeysFile的解释:</span>
<span class="line">这个配置项 AuthorizedKeysFile .ssh/authorized_keys 中的 .ssh/authorized_keys 是一个文件路径，它指定了用于SSH公钥认证的授权密钥存储位置。</span>
<span class="line">具体解释：</span>
<span class="line"></span>
<span class="line">.ssh/ 是一个目录，位于用户的主目录下</span>
<span class="line">authorized_keys 是存储授权公钥的文件</span>
<span class="line">完整路径通常是 ~/.ssh/authorized_keys（针对普通用户）或 /root/.ssh/authorized_keys（针对root用户）</span>
<span class="line"></span>
<span class="line">这个文件的作用是：</span>
<span class="line"></span>
<span class="line">存储所有被允许通过SSH密钥登录到此账户的公钥</span>
<span class="line">每个公钥占一行</span>
<span class="line">当有人尝试使用SSH密钥登录时，服务器会检查该文件中是否包含对应的公钥</span>
<span class="line"></span>
<span class="line">当你运行 ssh-copy-id 命令时，它实际上是把你的公钥添加到远程服务器上这个文件中。</span>
<span class="line">文件格式示例：</span>
<span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAA... 用户@主机</span>
<span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABBB... 另一个用户@另一个主机</span>
<span class="line"></span>
<span class="line">4.测试ssh 连接是否可用</span>
<span class="line"># 使用别名连接</span>
<span class="line">ssh hostmachine</span>
<span class="line"># 或直接连接</span>
<span class="line">ssh user@宿主机IP</span>
<span class="line"></span>
<span class="line">我这里执行:</span>
<span class="line">root@gitlab:~/.ssh# ssh myserver</span>
<span class="line">Welcome to Ubuntu 22.04.2 LTS (GNU/Linux 6.8.0-52-generic x86_64)</span>
<span class="line"></span>
<span class="line"> * Documentation:  https://help.ubuntu.com</span>
<span class="line"> * Management:     https://landscape.canonical.com</span>
<span class="line"> * Support:        https://ubuntu.com/advantage</span>
<span class="line"></span>
<span class="line"> * Introducing Expanded Security Maintenance for Applications.</span>
<span class="line">   Receive updates to over 25,000 software packages with your</span>
<span class="line">   Ubuntu Pro subscription. Free for personal use.</span>
<span class="line"></span>
<span class="line">     https://ubuntu.com/pro</span>
<span class="line"></span>
<span class="line">Expanded Security Maintenance for Applications is not enabled.</span>
<span class="line"></span>
<span class="line">201 updates can be applied immediately.</span>
<span class="line">To see these additional updates run: apt list --upgradable</span>
<span class="line"></span>
<span class="line">3 additional security updates can be applied with ESM Apps.</span>
<span class="line">Learn more about enabling ESM Apps service at https://ubuntu.com/esm</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">The list of available updates is more than a week old.</span>
<span class="line">To check for new updates run: sudo apt update</span>
<span class="line">New release &#39;24.04.2 LTS&#39; available.</span>
<span class="line">Run &#39;do-release-upgrade&#39; to upgrade to it.</span>
<span class="line"></span>
<span class="line">Last login: Sun Mar  9 19:01:30 2025 from 172.17.0.4</span>
<span class="line">guoshipeng@tianyi510s:~$ </span>
<span class="line"></span>
<span class="line">或者:</span>
<span class="line">root@gitlab:~/.ssh# ssh guoshipeng@192.168.5.17</span>
<span class="line">Welcome to Ubuntu 22.04.2 LTS (GNU/Linux 6.8.0-52-generic x86_64)</span>
<span class="line"></span>
<span class="line"> * Documentation:  https://help.ubuntu.com</span>
<span class="line"> * Management:     https://landscape.canonical.com</span>
<span class="line"> * Support:        https://ubuntu.com/advantage</span>
<span class="line"></span>
<span class="line"> * Introducing Expanded Security Maintenance for Applications.</span>
<span class="line">   Receive updates to over 25,000 software packages with your</span>
<span class="line">   Ubuntu Pro subscription. Free for personal use.</span>
<span class="line"></span>
<span class="line">     https://ubuntu.com/pro</span>
<span class="line"></span>
<span class="line">Expanded Security Maintenance for Applications is not enabled.</span>
<span class="line"></span>
<span class="line">201 updates can be applied immediately.</span>
<span class="line">To see these additional updates run: apt list --upgradable</span>
<span class="line"></span>
<span class="line">3 additional security updates can be applied with ESM Apps.</span>
<span class="line">Learn more about enabling ESM Apps service at https://ubuntu.com/esm</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">The list of available updates is more than a week old.</span>
<span class="line">To check for new updates run: sudo apt update</span>
<span class="line">New release &#39;24.04.2 LTS&#39; available.</span>
<span class="line">Run &#39;do-release-upgrade&#39; to upgrade to it.</span>
<span class="line"></span>
<span class="line">Last login: Sun Mar  9 19:21:10 2025 from 172.17.0.4</span>
<span class="line">guoshipeng@tianyi510s:~$ </span>
<span class="line"></span>
<span class="line">说明是可以在容器里，使用ssh连接宿主机的, 接下来就是编写脚本了</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="第二部分-编写脚本" tabindex="-1"><a class="header-anchor" href="#第二部分-编写脚本"><span>第二部分，编写脚本</span></a></h5><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">1.修改post-receive，添加如下内容</span>
<span class="line"></span>
<span class="line">#!/bin/bash</span>
<span class="line"></span>
<span class="line">read oldrev newrev refname</span>
<span class="line"></span>
<span class="line">BRANCH=&quot;refs/heads/dev&quot;</span>
<span class="line"></span>
<span class="line">if [ &quot;$refname&quot; == &quot;$BRANCH&quot; ]; then</span>
<span class="line">    echo &quot;$(date &#39;+%Y-%m-%d %H:%M:%S&#39;) - Push to dev branch detected: $newrev&quot; &gt;&gt; /var/log/gitlab/custom_hooks.log</span>
<span class="line">    echo &quot;Detected push to $BRANCH branch, triggering deploy...&quot;</span>
<span class="line">    ssh -vvv guoshipeng@192.168.5.17 &quot;/home/guoshipeng/Documents/code/deploy/deploy.sh&quot; &gt;&gt; /var/log/gitlab/custom_hooks.log 2&gt;&amp;1</span>
<span class="line">fi</span>
<span class="line"></span>
<span class="line">2.在宿主机 /home/guoshipeng/Documents/code/deploy/ 下新建如下 deploy.sh 脚本</span>
<span class="line">#!/bin/bash</span>
<span class="line"></span>
<span class="line">PROJECT_DIR=&quot;/home/guoshipeng/Documents/code/deploy/laravel-12&quot;</span>
<span class="line">#GIT_REPO=&quot;git@gitlab.example.com:9022/dev/laravel12.git&quot;</span>
<span class="line">#由于使用的是ssh，所以要加这个前缀，否则 git clone 失败，报: remote: The project you were looking for could not be found or you don&#39;t have permission to view it.</span>
<span class="line">GIT_REPO=&quot;ssh://git@gitlab.example.com:9022/dev/laravel12.git&quot;</span>
<span class="line">BRANCH=&quot;dev&quot;</span>
<span class="line"></span>
<span class="line">echo &quot;==== [$(date)] 开始部署 Laravel 12 ====&quot;</span>
<span class="line"></span>
<span class="line"># 如果目录不存在，克隆仓库</span>
<span class="line">if [ ! -d &quot;$PROJECT_DIR/.git&quot; ]; then</span>
<span class="line">    echo &quot;&gt;&gt;&gt; 目录不存在，克隆仓库...&quot;</span>
<span class="line">    git clone -b $BRANCH $GIT_REPO $PROJECT_DIR</span>
<span class="line">else</span>
<span class="line">    echo &quot;&gt;&gt;&gt; 目录已存在，拉取最新代码...&quot;</span>
<span class="line">    cd $PROJECT_DIR || exit</span>
<span class="line">    git fetch origin $BRANCH</span>
<span class="line">    git reset --hard origin/$BRANCH</span>
<span class="line">fi</span>
<span class="line"></span>
<span class="line"># 安装依赖</span>
<span class="line">echo &quot;&gt;&gt;&gt; 安装 PHP 依赖...&quot;</span>
<span class="line">#docker run --rm -v $PROJECT_DIR:/app -w /app composer install --no-dev --optimize-autoloader</span>
<span class="line"></span>
<span class="line"># 运行数据库迁移</span>
<span class="line">echo &quot;&gt;&gt;&gt; 运行数据库迁移...&quot;</span>
<span class="line">#docker-compose -f $DOCKER_COMPOSE_FILE exec app php artisan migrate --force</span>
<span class="line"></span>
<span class="line"># 重新启动 Laravel 项目</span>
<span class="line">echo &quot;&gt;&gt;&gt; 重新启动 Laravel 项目...&quot;</span>
<span class="line">#docker-compose -f $DOCKER_COMPOSE_FILE up -d --build</span>
<span class="line"></span>
<span class="line">echo &quot;==== [$(date)] 部署完成 ====&quot;</span>
<span class="line"></span>
<span class="line">上面脚本的内容只是做一个简单的测试，所以具体的逻辑还没使用，只是做了echo 操作</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="第三部分-测试脚本" tabindex="-1"><a class="header-anchor" href="#第三部分-测试脚本"><span>第三部分，测试脚本</span></a></h5><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">新建项目(这里是laravel12)，然后拉到本地，新建dev分支，然后 push 到远程仓库，到宿主机的 /home/guoshipeng/Documents/code/deploy/目录下看有没有laravel-12项目，结果发现没有</span>
<span class="line"></span>
<span class="line">但是脚本中的日志 /var/log/gitlab/custom_hooks.log </span>
<span class="line">echo &quot;$(date &#39;+%Y-%m-%d %H:%M:%S&#39;) - Push to dev branch detected: $newrev&quot; &gt;&gt; /var/log/gitlab/custom_hooks.log</span>
<span class="line"></span>
<span class="line">有日志信息，证明这个脚本是执行了,但是ssh没有执行</span>
<span class="line"></span>
<span class="line">我直接在gitlab容器里执行:</span>
<span class="line">root@gitlab:/var/opt/gitlab/git-data/repositories/@hashed/9f/14/9f14025af0065b30e47e23ebb3b491d39ae8ed17d33739e5ff3827ffb3634953.git/custom_hooks# ssh guoshipeng@192.168.5.17 &quot;/home/guoshipeng/Documents/code/deploy/deploy.sh&quot;</span>
<span class="line">==== [Fri Mar  7 12:07:37 AM CST 2025] 开始部署 Laravel 12 ====</span>
<span class="line">&gt;&gt;&gt; 目录不存在，克隆仓库...</span>
<span class="line">Cloning into &#39;/home/guoshipeng/Documents/code/deploy/laravel-12&#39;...</span>
<span class="line">remote: </span>
<span class="line">remote: ========================================================================</span>
<span class="line">remote: </span>
<span class="line">remote: The project you were looking for could not be found or you don&#39;t have permission to view it. //这是另一个问题，上面已经解决</span>
<span class="line">remote: </span>
<span class="line">remote: ========================================================================</span>
<span class="line">remote: </span>
<span class="line">fatal: Could not read from remote repository.</span>
<span class="line"></span>
<span class="line">Please make sure you have the correct access rights</span>
<span class="line">and the repository exists.</span>
<span class="line">&gt;&gt;&gt; 安装 PHP 依赖...</span>
<span class="line">&gt;&gt;&gt; 运行数据库迁移...</span>
<span class="line">&gt;&gt;&gt; 重新启动 Laravel 项目...</span>
<span class="line">==== [Fri Mar  7 12:07:37 AM CST 2025] 部署完成 ====</span>
<span class="line"></span>
<span class="line">发现脚本是可以执行的，那就很奇怪了，为什么hook下，ssh没有执行</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="第四部分-解决hook下-ssh没有执行的问题" tabindex="-1"><a class="header-anchor" href="#第四部分-解决hook下-ssh没有执行的问题"><span>第四部分，解决hook下，ssh没有执行的问题</span></a></h5><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">目前的问题:</span>
<span class="line">手动执行 ssh guoshipeng@192.168.5.17 &quot;/home/guoshipeng/Documents/code/deploy/deploy.sh&quot; 可以正常执行；</span>
<span class="line">自动执行 post-receive hook 时，这个 SSH 命令没有被执行。</span>
<span class="line"></span>
<span class="line">这表明： SSH 可能无法在 git 用户的环境中执行</span>
<span class="line">在gitlab容器里查看日志 vim /var/log/gitlab/custom_hooks.log</span>
<span class="line">...</span>
<span class="line">...</span>
<span class="line">debug1: Authenticating to 192.168.5.17:22 as &#39;guoshipeng&#39;^M</span>
<span class="line">debug1: load_hostkeys: fopen /var/opt/gitlab/.ssh/known_hosts: No such file or directory^M</span>
<span class="line">debug1: load_hostkeys: fopen /var/opt/gitlab/.ssh/known_hosts2: No such file or directory^M</span>
<span class="line">debug1: load_hostkeys: fopen /etc/ssh/ssh_known_hosts: No such file or directory^M</span>
<span class="line">debug1: load_hostkeys: fopen /etc/ssh/ssh_known_hosts2: No such file or directory^M</span>
<span class="line">debug3: order_hostkeyalgs: no algorithms matched; accept original^M</span>
<span class="line">debug3: send packet: type 20^M</span>
<span class="line">debug1: SSH2_MSG_KEXINIT sent^M</span>
<span class="line">debug3: receive packet: type 20^M</span>
<span class="line">debug1: SSH2_MSG_KEXINIT received^M</span>
<span class="line">debug2: local client KEXINIT proposal^M</span>
<span class="line">...</span>
<span class="line">...</span>
<span class="line"></span>
<span class="line">这说明 hook 脚本里执行 ssh 的用户为 git 用户，但是这个 git 用户没有被认证，这个 git 用户的默认加目录为： /var/opt/gitlab，而不是root用户的/root，之前在第一部分添加的认证其实都是root用户的，所以这里git用户执行ssh会失败</span>
<span class="line"></span>
<span class="line">解决办法:</span>
<span class="line">1.在容器里切换到git用户</span>
<span class="line">sudo -u git mkdir -p /var/opt/gitlab/.ssh</span>
<span class="line">sudo -u git ssh-keyscan 192.168.5.17 &gt;&gt; /var/opt/gitlab/.ssh/known_hosts</span>
<span class="line">sudo -u git chmod 644 /var/opt/gitlab/.ssh/known_hosts</span>
<span class="line"></span>
<span class="line">但是很遗憾，报:</span>
<span class="line">root@gitlab:~# sudo -u git</span>
<span class="line">bash: sudo: command not found</span>
<span class="line"></span>
<span class="line">这是因为: 在 GitLab 容器里，默认是 没有 sudo 的，因为容器通常是最小化的环境</span>
<span class="line"></span>
<span class="line">2.在 GitLab 容器里，并且是 root，切换到 git 用户：</span>
<span class="line">su - git</span>
<span class="line">如下:</span>
<span class="line">root@gitlab:~# su - git</span>
<span class="line">$ pwd </span>
<span class="line">/var/opt/gitlab</span>
<span class="line">然后执行:</span>
<span class="line">mkdir -p ~/.ssh</span>
<span class="line">ssh-keyscan 192.168.5.17 &gt;&gt; ~/.ssh/known_hosts</span>
<span class="line">chmod 644 ~/.ssh/known_hosts</span>
<span class="line"></span>
<span class="line">但是很遗憾，报:</span>
<span class="line">git 用户下，执行脚本报</span>
<span class="line">cannot create /var/opt/gitlab/.ssh/known_hosts: Permission denied</span>
<span class="line">但是 前面的 mkdir -p ~/.ssh 却执行了，我想可能是 ssh-keyscan 没有权限吧</span>
<span class="line"></span>
<span class="line">3.git 用户没有权限写入 /var/opt/gitlab/.ssh/known_hosts，可以用 root 用户 先创建 .ssh 目录并赋权给 git 用户：</span>
<span class="line">从上面的git用户exit 出到root，执行:</span>
<span class="line">mkdir -p /var/opt/gitlab/.ssh //这个其实不用执行了，因为上面已经创将了</span>
<span class="line">chown -R git:git /var/opt/gitlab/.ssh</span>
<span class="line">chmod 700 /var/opt/gitlab/.ssh</span>
<span class="line"></span>
<span class="line">然后:</span>
<span class="line">su - git # </span>
<span class="line"># 添加 SSH 服务器的 key 到 known_hosts，避免 SSH 连接报错</span>
<span class="line">ssh-keyscan 192.168.5.17 &gt;&gt; /var/opt/gitlab/.ssh/known_hosts //如果哦还有问题，就直接在root用户下执行，然后修改目录归属</span>
<span class="line">chmod 644 /var/opt/gitlab/.ssh/known_hosts</span>
<span class="line"></span>
<span class="line">我这里执行 ssh-keyscan 192.168.5.17 &gt;&gt; /var/opt/gitlab/.ssh/known_hosts 的效果如下:</span>
<span class="line">ssh-keyscan 192.168.5.17 &gt;&gt; ~/.ssh/known_hosts //这个是我之前使用root的时候为root用户生成的, 其实root用户和git用户的known_hosts 存的内容都一样</span>
<span class="line"># 192.168.5.17:22 SSH-2.0-OpenSSH_8.9p1 Ubuntu-3ubuntu0.11</span>
<span class="line"># 192.168.5.17:22 SSH-2.0-OpenSSH_8.9p1 Ubuntu-3ubuntu0.11</span>
<span class="line"># 192.168.5.17:22 SSH-2.0-OpenSSH_8.9p1 Ubuntu-3ubuntu0.11</span>
<span class="line"># 192.168.5.17:22 SSH-2.0-OpenSSH_8.9p1 Ubuntu-3ubuntu0.11</span>
<span class="line"># 192.168.5.17:22 SSH-2.0-OpenSSH_8.9p1 Ubuntu-3ubuntu0.11</span>
<span class="line">$ </span>
<span class="line">$ ls -l ~/.ssh/known_hosts</span>
<span class="line">-rw-r--r-- 1 git git 834 Mar  8 14:58 /var/opt/gitlab/.ssh/known_hosts</span>
<span class="line"></span>
<span class="line">vim /var/opt/gitlab/.ssh/known_hosts, 内容如下:</span>
<span class="line">192.168.5.17 ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDLE4ptNJOj0gOQRqtADbuxXvWW+B+7GLTlqh2/MzRKgB2vchs5e3HlDdQ80UkQC6UqtUgzEdPljEw9+DfAUwd1kFw8YyL4ht/mu/m6Ru6xikvRml6m+5ZR8WeS0x9DTIByLplLWNRQvN9v3FMQNXo2b2l+rhVidsMMHhkS+eB9AUFr1dT101Nega+VHmLeVZTU96jFTxxHZCm9COID4ygwyDBTqLHr743D4H/dfEvkdy7GhMKtXPCdrBBATxykfD9KbGm65mlGxPAbyu7igo4rmNvsCBPxji90mL2UrtuSTB1UFuV2LabcQCHIUwAIdJF9JLyfPiROMcM4EAkl8xkCj/sOC+AfxGZx/HHpEdqo3iU+9xInnlgyuzSTcWXs2IiHE67Gczg4rovkMgXTrVRwotfAgy13XKX1TFGWvmg50qbBO6RUKRxNfONcXsnUdAi46kYRUqUuZ4NG8Fet6LyQvA6Gb0mO26lek6t2oo6KSeULHL/a5OYSPxhuUNEIyys=</span>
<span class="line">192.168.5.17 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFERYqCHXozlOK5lE7F+FX5Cy3ejnURAs0XxzAPLmOVixwZgPKJ63HA8LrvZn2J9XUgSnFWSfN3wS85defqrLCg=</span>
<span class="line">192.168.5.17 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAICKLoOAsvzRv7gLc/edywOmsH7ewq+KVay+N/9n63eDP</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">在git 用户下测试:</span>
<span class="line">ssh -T guoshipeng@192.168.5.17</span>
<span class="line"></span>
<span class="line">...</span>
<span class="line">...</span>
<span class="line">debug1: Next authentication method: publickey^M</span>
<span class="line">debug1: Trying private key: /var/opt/gitlab/.ssh/id_rsa^M</span>
<span class="line">debug3: no such identity: /var/opt/gitlab/.ssh/id_rsa: No such file or directory^M</span>
<span class="line">debug1: Trying private key: /var/opt/gitlab/.ssh/id_ecdsa^M</span>
<span class="line">debug3: no such identity: /var/opt/gitlab/.ssh/id_ecdsa: No such file or directory^M</span>
<span class="line">debug1: Trying private key: /var/opt/gitlab/.ssh/id_ecdsa_sk^M</span>
<span class="line">debug3: no such identity: /var/opt/gitlab/.ssh/id_ecdsa_sk: No such file or directory^M</span>
<span class="line">debug1: Trying private key: /var/opt/gitlab/.ssh/id_ed25519^M</span>
<span class="line">debug3: no such identity: /var/opt/gitlab/.ssh/id_ed25519: No such file or directory^M</span>
<span class="line">debug1: Trying private key: /var/opt/gitlab/.ssh/id_ed25519_sk^M</span>
<span class="line">debug3: no such identity: /var/opt/gitlab/.ssh/id_ed25519_sk: No such file or directory^M</span>
<span class="line">debug1: Trying private key: /var/opt/gitlab/.ssh/id_xmss^M</span>
<span class="line">debug3: no such identity: /var/opt/gitlab/.ssh/id_xmss: No such file or directory^M</span>
<span class="line">debug1: Trying private key: /var/opt/gitlab/.ssh/id_dsa^M</span>
<span class="line">debug3: no such identity: /var/opt/gitlab/.ssh/id_dsa: No such file or directory^M</span>
<span class="line">debug2: we did not send a packet, disable method^M</span>
<span class="line">debug3: authmethod_lookup password^M</span>
<span class="line">debug3: remaining preferred: ,password^M</span>
<span class="line">debug3: authmethod_is_enabled password^M</span>
<span class="line">debug1: Next authentication method: password^M</span>
<span class="line">...</span>
<span class="line">...</span>
<span class="line"></span>
<span class="line">如果有 Permission denied (publickey)的问题，那说明 git 用户的 SSH Key 不正确或者不存在，大概率是不存在，执行:</span>
<span class="line">su - git //切换到git用户</span>
<span class="line">ssh-keygen -t rsa -b 4096 -C &quot;git@gitlab&quot; -f ~/.ssh/id_rsa -N &quot;&quot;</span>
<span class="line"></span>
<span class="line">然后将 id_rsa.pub 复制到 192.168.5.17：</span>
<span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub guoshipeng@192.168.5.17</span>
<span class="line">会提示输入远程服务器的密码</span>
<span class="line">成功后，就可以无密码SSH登录该服务器了</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">通过一下命令验证git 的 ssh key 是否被添加:</span>
<span class="line">root@gitlab:~/.ssh# ssh -i /var/opt/gitlab/.ssh/id_rsa guoshipeng@192.168.5.17</span>
<span class="line">Welcome to Ubuntu 22.04.2 LTS (GNU/Linux 6.8.0-52-generic x86_64)</span>
<span class="line"></span>
<span class="line"> * Documentation:  https://help.ubuntu.com</span>
<span class="line"> * Management:     https://landscape.canonical.com</span>
<span class="line"> * Support:        https://ubuntu.com/advantage</span>
<span class="line"></span>
<span class="line"> * Introducing Expanded Security Maintenance for Applications.</span>
<span class="line">   Receive updates to over 25,000 software packages with your</span>
<span class="line">   Ubuntu Pro subscription. Free for personal use.</span>
<span class="line"></span>
<span class="line">     https://ubuntu.com/pro</span>
<span class="line"></span>
<span class="line">Expanded Security Maintenance for Applications is not enabled.</span>
<span class="line"></span>
<span class="line">201 updates can be applied immediately.</span>
<span class="line">To see these additional updates run: apt list --upgradable</span>
<span class="line"></span>
<span class="line">3 additional security updates can be applied with ESM Apps.</span>
<span class="line">Learn more about enabling ESM Apps service at https://ubuntu.com/esm</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">The list of available updates is more than a week old.</span>
<span class="line">To check for new updates run: sudo apt update</span>
<span class="line">New release &#39;24.04.2 LTS&#39; available.</span>
<span class="line">Run &#39;do-release-upgrade&#39; to upgrade to it.</span>
<span class="line"></span>
<span class="line">Last login: Sun Mar  9 19:21:50 2025 from 172.17.0.4</span>
<span class="line">guoshipeng@tianyi510s:~$ </span>
<span class="line"></span>
<span class="line">说明添加成功</span>
<span class="line"></span>
<span class="line">还有个问题，对于 git 用户，我没有在它的.ssh目录下添加 config，用来添加host 别名，以简化连接，如果需要也可以为git用户添加一个 ~/.ssh/config，类似root用户的。</span>
<span class="line"></span>
<span class="line">接下来，再重新提交代码，可以发现 /home/guoshipeng/Documents/code/deploy 下有了 laravel-12 这个目录，说明post-receive 这个脚本中的 ssh 被执行了 </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="第五部分-关于known-hosts的作用" tabindex="-1"><a class="header-anchor" href="#第五部分-关于known-hosts的作用"><span>第五部分，关于known_hosts的作用</span></a></h5><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">ssh-keyscan 192.168.5.17 &gt;&gt; ~/.ssh/known_hosts 的作用</span>
<span class="line">这个命令的作用是 将 192.168.5.17 服务器的 SSH 主机密钥添加到 known_hosts 文件，避免 SSH 连接时手动确认主机身份。</span>
<span class="line"></span>
<span class="line">原理如下:</span>
<span class="line">SSH 连接时，客户端会检查服务器的身份，具体流程如下：</span>
<span class="line">客户端尝试连接服务器（如 ssh user@192.168.5.17）。</span>
<span class="line">服务器返回自己的 SSH 公钥（host key）。</span>
<span class="line">客户端检查 ~/.ssh/known_hosts 文件：</span>
<span class="line">如果 文件里已经有匹配的主机密钥，SSH 连接继续。</span>
<span class="line">如果 文件里没有该服务器的密钥，SSH 会提示：</span>
<span class="line">The authenticity of host &#39;192.168.5.17 (192.168.5.17)&#39; can&#39;t be established.</span>
<span class="line">ECDSA key fingerprint is SHA256:xxxxx.</span>
<span class="line">Are you sure you want to continue connecting (yes/no)?</span>
<span class="line"></span>
<span class="line">选择 yes 后，该密钥会存入 known_hosts，以后就不会再提示。</span>
<span class="line"></span>
<span class="line">ssh-keyscan 的作用:</span>
<span class="line">ssh-keyscan 自动获取服务器的 SSH 主机密钥，并写入 known_hosts，避免手动确认。</span>
<span class="line">如：</span>
<span class="line">ssh-keyscan 192.168.5.17 &gt;&gt; ~/.ssh/known_hosts</span>
<span class="line">等价于：</span>
<span class="line">连接 192.168.5.17 获取 SSH 主机密钥（但不会真的 SSH 登录）。</span>
<span class="line">把这个主机密钥追加 (&gt;&gt;) 到 ~/.ssh/known_hosts，避免手动输入 yes。</span>
<span class="line"></span>
<span class="line">ssh-keyscan 可用于批量获取多台服务器的密钥：</span>
<span class="line">ssh-keyscan 192.168.5.17 192.168.5.18 192.168.5.19 &gt;&gt; ~/.ssh/known_hosts</span>
<span class="line"></span>
<span class="line">ssh-keyscan 不会验证 服务器身份，只是盲目地获取密钥，所以如果 DNS 劫持或中间人攻击发生，可能会存储错误的密钥。ssh-keyscan 可以获取任意服务器的 SSH 主机密钥，前提是该服务器允许通过 SSH 进行连接。ssh-keyscan 的作用就是 扫描并获取远程服务器的公钥，并将其输出到标准输出（通常是终端或指定文件）。它并不会尝试进行登录操作，只是读取服务器的公钥信息。</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="第六部分-关于ssh-copy-id" tabindex="-1"><a class="header-anchor" href="#第六部分-关于ssh-copy-id"><span>第六部分,关于ssh-copy-id</span></a></h5><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">ssh-copy-id 是一个非常实用的命令，用于将本地主机的SSH公钥安装到远程主机的授权密钥文件中。细解释一下：</span>
<span class="line">基本功能:</span>
<span class="line">ssh-copy-id 的主要作用是简化SSH免密登录的配置过程。它会自动将你的公钥添加到远程服务器的 ~/.ssh/authorized_keys 文件中。这个命令大大简化了SSH免密登录的配置过程，是系统管理员和开发人员常用的效率工具。</span>
<span class="line"></span>
<span class="line">工作原理:</span>
<span class="line">它会读取本地的SSH公钥（通常是 ~/.ssh/id_rsa.pub）</span>
<span class="line">将公钥上传到远程服务器</span>
<span class="line">添加到远程服务器的授权密钥列表中</span>
<span class="line"></span>
<span class="line">示例:</span>
<span class="line">ssh-copy-id user@hostname</span>
<span class="line"></span>
<span class="line">user：远程服务器的用户名</span>
<span class="line">hostname：远程服务器的IP地址或域名</span>
<span class="line"></span>
<span class="line">具体操作流程:</span>
<span class="line"># 1. 先生成SSH密钥（如果还没有）</span>
<span class="line">ssh-keygen -t rsa</span>
<span class="line"></span>
<span class="line"># 2. 复制公钥到远程服务器</span>
<span class="line">ssh-copy-id root@192.168.1.100</span>
<span class="line">执行这个命令时：</span>
<span class="line">会提示你输入远程服务器的密码</span>
<span class="line">成功后，你就可以无密码SSH登录该服务器了</span>
<span class="line"></span>
<span class="line">安全注意事项:</span>
<span class="line">确保只对可信的服务器使用</span>
<span class="line">保护好私钥</span>
<span class="line">不要随意分享私钥</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="第七部分-检查宿主机下的-authorized-keys-有哪些" tabindex="-1"><a class="header-anchor" href="#第七部分-检查宿主机下的-authorized-keys-有哪些"><span>第七部分，检查宿主机下的 authorized_keys 有哪些</span></a></h5><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">guoshipeng@tianyi510s:~$ pwd</span>
<span class="line">/home/guoshipeng</span>
<span class="line">guoshipeng@tianyi510s:~$ vim ~/.ssh/authorized_keys</span>
<span class="line"></span>
<span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDLr/1E9ipQEN1au7R2SkjVXEuYFlnH3OHbRxXmWC7Ib4e+tj8jwwv/WSX2wV2FOTHZ7csoHdxqAHE8C9fTPBBAHyk+vhV+8BS/yYp+poqqTLHDO+Rkqy2ZZ2VIx3cQAhUTOtsYCP1Pkf55YeJmOpEunqE9CQyGNPuwCv1EF5zeTe+knV4g6EhTBJ/hXIRfb3kd1YJSOIJYWMElF5hiiiUuDu3+ZovlBmVHE3YNavV7GzJzPDkgHIWRMqMz9dVA+of4N3UHR5Sc54RhSlL3LErQ00Q24DEBfW29LC/oqNeKMDs+BPS7ArsCiHPVNZd1vSexufqh6GDf/B879II1FNB1/gFYTnphAH20JRcJK4JMEncC3UybUMDNCDiS7rarSSldmKhc0yrUL2bazUoFfCpmoQVUqaQHPsbDaIpfiJOSz64dOqUkVZfIxj73Q+02WN73dfaRskqySftRmoP36PhHIqLAKRjZZDft20hvrE0/KVXVuNem7W6Dq0uHGdYunLEhF82TpDZTNoZfvdtMACF8cAOVFRoLIJjRqBWQmKTTQF+xFo/P9JmnkgxJ9puDFm/bHH/fou9OcYKP7TPXIB7LGyEpkxX8iM6DqOOs/6XxJzQ+NFVvSVrHHceDRpJAYdKiQjAhC88qhxC6S1seCwWCs4xHgpiPsw37vl/BYYgMWw== root@gitlab.example.com</span>
<span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDDMN/yVIWUufSrJBtB1hXSu3/zXwlcrXwihycTbjmc9L+3ukDXwa3JkEMJgrYPVNZQy/iEc6u9HbGEQv2ld60BtDuUagZvMgJfiinFq6D/BXxvdeCOo1TE2NrDvHrhUC67G0pT40vYgfa/Y5o/JYemu/MhRuj/rW/g1LZ+9vUOXhXuDDPSzGUueRJUmAOzDUkcsihHpFH6NlgQ9Adn+cUod9pw/z1EsUltroyuMZC3qJzADt3dXdEmiYDV0sw0B5oSE3v9Sm4nm+02hC0OL12xBisPXZR7FyxLHEW983XXGsomTX4f9rsdHVkaDv9ObI/pzbClYgFsWwj46xqt/rExZ550IExtUnh1CpXz2UD57m9AoLYph7bV21+0c48lMUwh/m7AYLXuBtAm7vPGA0mJWVei5Iuw5XIr+dNhg+IS+LWsjBKQis2UrqDLBNWYMGnlg0HLye6qIuPRiNb5quMfzx63KUygMHwkcG+/L9+7a7iA13/guMVNNEqjc8Ibe7Ikj33uc56rW+WVPF9MI9ITQsOOwTsW1cdx7856e+iYhs+WIs5da8llGrwaqbXuniSy5INbrG/E75+lu9iceptdt9853jL2giWiP7+jaQjqkV2zIHGtk4IulWZ+6myk/i+YUrxHiU5oEXeS+KJZxSXjvvZcGzmNS+b02ueD01ax6Q== git@gitlab</span>
<span class="line"></span>
<span class="line">说明之前为 root 和 git 添加的 ssh key 都被保存到宿主机.</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="第八部分-总结" tabindex="-1"><a class="header-anchor" href="#第八部分-总结"><span>第八部分，总结</span></a></h5><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">一定要为当前执行ssh的用户添加相应的权限，包括和目标服务器的连接.</span>
<span class="line">四部分:</span>
<span class="line">1.add known-hosts</span>
<span class="line">2.generate SSH key</span>
<span class="line">3.copy SSH key</span>
<span class="line">4.grant role</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,22)]))}const r=n(l,[["render",d],["__file","gitlab之server端hook自动创建项目分支.html.vue"]]),v=JSON.parse('{"path":"/content/service/docker/gitlab%E4%B9%8Bserver%E7%AB%AFhook%E8%87%AA%E5%8A%A8%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E5%88%86%E6%94%AF.html","title":"gitlab之server端hook自动创建项目分支","lang":"en-US","frontmatter":{"sidebar":false,"title":"gitlab之server端hook自动创建项目分支","head":[["meta",{"name":"title","content":"gitlab之server端hook自动创建项目分支"}],["meta",{"name":"description","content":"gitlab之server端hook自动创建项目分支"}],["meta",{"name":"keywords","content":"gitlab,hook,ci/cd"}],["meta",{"property":"og:title","content":"gitlab之server端hook自动创建项目分支"}],["meta",{"property":"og:description","content":"gitlab之server端hook自动创建项目分支"}]]},"headers":[],"git":{},"filePathRelative":"content/service/docker/gitlab之server端hook自动创建项目分支.md"}');export{r as comp,v as data};
